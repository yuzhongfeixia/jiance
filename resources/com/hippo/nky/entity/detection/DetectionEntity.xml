<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hippo.nky.entity.detection.DetectionEntity">
	<resultMap type="java.util.HashMap" id="detectionResult">
        <result column="RN" property="rn"/> 
        <result column="ID" property="id"/> 
        <result column="CODE" property="code"/> 
        <result column="LAB_CODE" property="labCode"/>
        <result column="SAMPLE_STATUS" property="sampleStatus"/>
        <result column="INDUSTRY_CODE" property="industryCode"/> 
        <result column="PRINT_COUNT" property="printCount"/>
        <result column="CNAME" property="agrname"/>
    </resultMap>  
	<select id="getDetectionCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			<include refid="detectionID"/>
  			<if test=" sampleStatus != '' and sampleStatus != null ">
				AND NSI.SAMPLE_STATUS IN 
			    <foreach collection="sampleStatus" index="index" item="item" open="(" separator="," close=")">
			    	 #{item}
			    </foreach>
			</if>
			AND NSI.DETECTION_CODE = #{orgCode}
  			<!-- 样品名称 -->
	        <if test=" sampleName != '' and sampleName != null ">
				AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
			<if test="orgCode != '' and orgCode != null ">
 				AND NOI.CODE = #{orgCode}
			</if>
			<if test="labCode != '' and labCode != null ">
 				AND NSI.LAB_CODE LIKE '%' || #{labCode} || '%'
			</if>	
			ORDER BY NSI.SAMPLING_DATE DESC 
         ) t	
	</select>
	
	<select id="getDetection" resultMap="detectionResult" parameterType="java.util.HashMap">
<!-- 		SELECT T2.ID, -->
<!-- 	       T2.CODE, -->
<!-- 	       T2.CNAME, -->
<!-- 	       T2.LAB_CODE, -->
<!-- 	       T2.SAMPLE_STATUS, -->
<!-- 	       T2.PRINT_COUNT, -->
<!--        	   ROWNUM RN -->
		SELECT *
		  FROM (SELECT T.*,ROWNUM AS RN
		          FROM (SELECT 
		                       NSI.ID,
		                       (CASE NMP.DETACHED
		                         WHEN '1' THEN
		                          NSI.SP_CODE
		                         ELSE
		                          NSI.D_CODE
		                       END) AS CODE,
		                       AGR.CNAME,
		                       NSI.LAB_CODE,
		                       NSI.SAMPLE_STATUS,
		                       NVL(NSI.PRINT_COUNT, 0) AS PRINT_COUNT
		                  FROM NKY_SAMPLING_INFO NSI
		                  LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE =
		                                                       NMT.TASK_CODE)
		                  LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE =
		                                                          NMT.PROJECT_CODE)
		                  LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON (NMP.PROJECT_CODE =
		                                                               NMO.PROJECT_CODE)
		                  LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NMO.ORG_CODE =
		                                                         NOI.CODE)
		                  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE =
		                                                        NSI.AGR_CODE AND
		                                                        AGR.PROJECT_CODE =
		                                                        NMP.PROJECT_CODE)
		                 WHERE 1 = 1
		                 <if test=" sampleStatus != '' and sampleStatus != null ">
							 AND NSI.SAMPLE_STATUS IN 
						     <foreach collection="sampleStatus" index="index" item="item" open="(" separator="," close=")">
						     	 #{item}
						     </foreach>  
						 </if>		
						AND NSI.DETECTION_CODE = #{orgCode}
						 <!-- 样品名称 -->
				         <if test=" sampleName != '' and sampleName != null ">
							 AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
						 </if>
		      			 <if test="projectCode != '' and projectCode != null ">
			 				 AND NMP.PROJECT_CODE = #{projectCode}
						 </if>
						 <if test="orgCode != '' and orgCode != null ">
			 				 AND NOI.CODE = #{orgCode}
						 </if>
						 <if test="labCode != '' and labCode != null ">
			 				 AND NSI.LAB_CODE LIKE '%' || #{labCode} || '%'
						 </if>
						 <if test="invokeFlg == 0 and isDetached != '' and isDetached != null ">
						  ORDER BY substr(NSI.SP_CODE,1,inStr(NSI.SP_CODE,'-',-1)-1),to_number(substr(NSI.SP_CODE,inStr(NSI.SP_CODE,'-',-1)+1))
		                 </if>
		                 <if test="invokeFlg == 0 and (isDetached == '' or isDetached == null)">
						  ORDER BY SUBSTR(NSI.D_CODE, 8, 6) ASC
		                 </if>
		                 <if test="invokeFlg == 1 and isDetached != '' and isDetached != null ">
						 ORDER BY substr(NSI.SP_CODE,1,inStr(NSI.SP_CODE,'-',-1)-1),to_number(substr(NSI.SP_CODE,inStr(NSI.SP_CODE,'-',-1)+1))
		                 </if>
		                 <if test="invokeFlg == 1 and (isDetached == '' or isDetached == null)">
						 ORDER BY substr(NSI.LAB_CODE,1,inStr(NSI.LAB_CODE,'-',-1)-1),to_number(substr(NSI.LAB_CODE,inStr(NSI.LAB_CODE,'-',-1)+1))
		                 </if>
		                 ) T
		       
           )  WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>

	<select id="checkSampleDetached" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			FROM NKY_SAMPLING_INFO NSI
		    LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		    LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		WHERE NMP.DETACHED = 1 
		<if test="projectCode != '' and projectCode != null ">
			AND NMP.PROJECT_CODE = #{projectCode}
		</if>
	</select>
	
	<!-- 标签打印 start -->
	<select id="findSampleByIds" resultMap="detectionResult"
		parameterType="java.util.HashMap">
	    SELECT NSI.ID,(CASE NMP.DETACHED WHEN '1' THEN NSI.SP_CODE ELSE  NSI.D_CODE END) AS CODE,AGR.CNAME,NSI.LAB_CODE,NSI.SAMPLE_STATUS,NVL(NMP.INDUSTRY_CODE,' ')AS INDUSTRY_CODE
		    FROM NKY_SAMPLING_INFO NSI
		    LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
		    LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		    LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
		    LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
		    LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND NMP.PROJECT_CODE = AGR.PROJECT_CODE)
		    WHERE NSI.ID IN 
		    <foreach collection="ids" index="index" item="item" open="(" separator="," close=")">
		     	#{item}
		    </foreach>
	  		 <if test="orgCode != '' and orgCode != null ">
				 AND NOI.CODE = #{orgCode}
			 </if>
	</select>
	<!-- 标签打印 end -->
	
	<sql id="detectionID">
		SELECT NSI.ID
			FROM NKY_SAMPLING_INFO NSI
			LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
			LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
			LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND agr.PROJECT_CODE = nmp.project_code)
            WHERE 1=1 
	</sql>

<!-- 
	<parameterMap type="map" id="parameterMap">  
	   <parameter property="orgCode" jdbcType="VARCHAR" mode="IN"/>  
	   <parameter property="projectCode" jdbcType="VARCHAR" mode="IN"/>  
	   <parameter property="labPre" jdbcType="VARCHAR" mode="IN"/>  
	   <parameter property="startSer" jdbcType="INTEGER" mode="IN"/>  
	 </parameterMap>  
 -->
	<update id="updateDetection" parameterType="java.util.HashMap" statementType="CALLABLE">  
          <![CDATA[
	          {call pkg_detection_makecode.update_detection_labCode(
	          	#{orgCode,mode=IN,jdbcType=VARCHAR}
	          	,#{projectCode,mode=IN,jdbcType=VARCHAR}
	          	,#{labPre,mode=IN,jdbcType=VARCHAR}
	          	,#{startSer,mode=IN,jdbcType=INTEGER}
	          	,#{detached,mode=IN,jdbcType=VARCHAR}
	          )}
          ]]> 
	</update>
	
	<!-- 取得项目已接收的实验室编码 -->
	<select id="getLabCodeForRecv" resultType="java.lang.String" parameterType="java.util.HashMap">
		SELECT 
			 NSI.LAB_CODE AS labCode
			FROM NKY_SAMPLING_INFO NSI
			INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		WHERE NMP.PROJECT_CODE = #{projectCode}
		AND NSI.DETECTION_CODE = #{orgCode}
		AND NSI.SAMPLE_STATUS = '4'
	</select>
	
	<!-- 检测信息汇总列表取得  =======================================================================================================-->
	<resultMap type="java.util.HashMap" id="detectionInfoCollectResult">
		<result column="ID" property="id"/>  
		<result column="SAMPLE_CODE" property="sampleCode"/>   
        <result column="TASKNAME" property="taskName"/>  
        <result column="SP_CODE" property="spCode"/>  
        <result column="CNAME" property="cname"/>  
        <result column="UNIT_FULLNAME" property="unitFullname"/>
        <result column="MONITORING_LINK" property="monitoringLink"/>
        <result column="UNIT_ADDRESS" property="unitAddress"/>
        <result column="SAMPLING_DATE" property="samplingDate"/>
        <result column="SAMPLING_OGRNAME" property="samplingOgrname"/>
        <result column="DETECTION_ORGNAME" property="detectionOgrname"/>
        <result column="INDUSTRY_CODE" property="industryCode"/>
		<result column="RN" property="rn"/>
		<result column="IS_OVERPROOF" property="isOverproof"/>
    </resultMap>  
	<select id="getDetectionInfoCollectCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
  			FROM (
  			SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 				INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
				LEFT JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
				LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
				INNER JOIN NKY_DETECTION_INFORMATION NDI ON(NDI.SAMPLE_CODE = NSI.SAMPLE_CODE)
            WHERE 1=1 
             AND NSI.SAMPLE_STATUS = '5'
            <if test="qt != '' and qt != null">
            	AND NMP.LEADUNIT = #{qt}
            </if>
            <if test="pt != '' and pt != null">
<!--             	AND NSI.SAMPLING_ORG_CODE = #{pt} -->
            	AND NSI.DETECTION_CODE = #{pt}
<!--           			AND NMO.ORG_CODE = #{pt} -->
            </if>
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
			<if test="agrName != '' and agrName != null">
				AND AGR.CNAME LIKE '%' || #{agrName} || '%'
			</if>
			<if test=" unitFullname != '' and unitFullname != null ">
				AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="monitoringLink != '' and monitoringLink != null">
			 	AND NSI.MONITORING_LINK = #{monitoringLink}
			</if>
			GROUP BY NSI.ID,NSI.SAMPLE_CODE
         ) t	
	</select>
	
	<select id="getDetectionInfoCollect" resultMap="detectionInfoCollectResult" parameterType="java.util.HashMap">
	SELECT * FROM (
			SELECT T.*,ROWNUM AS RN
			  FROM (
			  SELECT NSI.ID,
			  		 NSI.SAMPLE_CODE,
			  		 NMT.TASKNAME,
			  		 CASE WHEN NMP.DETACHED = '0' 
			  		 	THEN NSI.D_CODE
			  		      WHEN NMP.DETACHED = '1'
			  		    THEN NSI.SP_CODE END AS SP_CODE,
			  		 AGR.CNAME,
			  		 NSI.UNIT_FULLNAME,
			  		 NSI.MONITORING_LINK,
			  		 NSI.UNIT_ADDRESS,
			  		 TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
			  		 NOI1.OGRNAME AS SAMPLING_OGRNAME,
			  		 NOI2.OGRNAME AS DETECTION_ORGNAME,			  		 
			  		 NMP.INDUSTRY_CODE AS INDUSTRY_CODE,
			  		 DECODE(SUM(DECODE(NDI.IS_OVERPROOF,'0',0,'1',1)),0,'0','1') AS IS_OVERPROOF
					FROM NKY_SAMPLING_INFO NSI
					INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
					INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
					INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 					INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
					LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
					LEFT JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
					LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
					INNER JOIN NKY_DETECTION_INFORMATION NDI ON(NDI.SAMPLE_CODE = NSI.SAMPLE_CODE)
	            WHERE 1=1
	            AND NSI.SAMPLE_STATUS = '5'
	            <if test="qt != '' and qt != null">
	            	AND NMP.LEADUNIT = #{qt}
	            </if>
	            <if test="pt != '' and pt != null">
<!-- 	            	AND NSI.SAMPLING_ORG_CODE = #{pt} -->
	            	AND NSI.DETECTION_CODE = #{pt}
<!--            			AND NMO.ORG_CODE = #{pt} -->
	            </if>
				<if test="projectCode != '' and projectCode != null ">
					AND NMP.PROJECT_CODE = #{projectCode}
				</if>
				<if test="agrName != '' and agrName != null">
					AND AGR.CNAME LIKE '%' || #{agrName} || '%'
				</if>
				<if test=" unitFullname != '' and unitFullname != null ">
					AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
				</if>
				<if test="monitoringLink != '' and monitoringLink != null">
				 	AND NSI.MONITORING_LINK = #{monitoringLink}
				</if>
				<if test="id != '' and id != null ">
					AND NSI.ID = #{id}
				</if>
				GROUP BY NSI.ID,NSI.SAMPLE_CODE, NMT.TASKNAME, 
				       CASE
                         WHEN NMP.DETACHED = '0' THEN
                          NSI.D_CODE
                         WHEN NMP.DETACHED = '1' THEN
                          NSI.SP_CODE END,
						AGR.CNAME, NSI.UNIT_FULLNAME, NSI.MONITORING_LINK,NSI.UNIT_ADDRESS,SAMPLING_DATE,
				        NMP.INDUSTRY_CODE,NOI1.OGRNAME,NOI2.OGRNAME
	      	) T
      	)
      	<if test="id == '' or id == null ">
		 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
		</if>
	</select>
	
	<!-- 检测信息汇总列表取得导出用 -->
	<select id="getDetectionInfoCollectForExport" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
		SELECT 'title#KV#序号#EM#width#KV#5'                            AS rowIndex
		       ,'title#KV#任务#EM#width#KV#40'                           AS taskname
		       ,'title#KV#检测结果#EM#width#KV#8'                         AS isOverProof
		        <if test="detached != '' and detached != null and detached == 0">
		       ,'title#KV#样品条码#EM#width#KV#20'                        AS spCode
		       </if>
		       <if test="detached != '' and detached != null and detached == 1">
		       ,'title#KV#制样编码#EM#width#KV#20'                        AS spCode
		       </if>
		       ,'title#KV#样品名称#EM#width#KV#20'                        AS cname
		       ,'title#KV#受检单位名称#EM#width#KV#20'                     AS unitFullName
		       ,'title#KV#监测环节#EM#width#KV#20'                        AS monitoringLink
		       ,'title#KV#受检单位所在地#EM#width#KV#20'                    AS unitAddress
		       ,'title#KV#抽样单位#EM#width#KV#20'                       AS samplingOrgName
		       ,'title#KV#检测单位#EM#width#KV#20'                       AS detectionOrgName
		  FROM DUAL
		UNION ALL
			SELECT TO_CHAR(ROWNUM) AS rowIndex,
				   T.TASKNAME AS taskname,
				   CASE WHEN
				   	 T.IS_OVERPROOF = '1' THEN '不合格'
				   	 WHEN
				   	 T.IS_OVERPROOF = '0' THEN '合格'
				   	 END AS isOverProof,
				   T.SP_CODE AS spCode,
				   T.CNAME AS cname,
				   T.UNIT_FULLNAME AS unitFullName,
				   T.MONITORING_LINKK AS monitoringLink,
				   NVL(T.UNIT_ADDRESS, ' ') AS unitAddress,
				   T.SAMPLING_OGRNAME AS samplingOrgName,
				   T.DETECTION_ORGNAME AS detectionOrgName
			  FROM (
			  SELECT NSI.ID,
			  		 NSI.SAMPLE_CODE,
			  		 NMT.TASKNAME,
			  		 CASE WHEN NMP.DETACHED = '0' 
			  		 	THEN NSI.D_CODE
			  		      WHEN NMP.DETACHED = '1'
			  		    THEN NSI.SP_CODE END AS SP_CODE,
			  		 AGR.CNAME,
			  		 NSI.UNIT_FULLNAME,
			  		 TST.TYPENAME AS MONITORING_LINKK,
			  		 NSI.UNIT_ADDRESS,
			  		 TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
			  		 NOI1.OGRNAME AS SAMPLING_OGRNAME,
			  		 NOI2.OGRNAME AS DETECTION_ORGNAME,			  		 
			  		 DECODE(SUM(DECODE(NDI.IS_OVERPROOF,'0',0,'1',1)),0,'0','1') AS IS_OVERPROOF
					FROM NKY_SAMPLING_INFO NSI
					INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
					INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
					INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 					INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
					LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
					LEFT JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
					LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
					INNER JOIN NKY_DETECTION_INFORMATION NDI ON(NDI.SAMPLE_CODE = NSI.SAMPLE_CODE)
				    LEFT JOIN T_S_TYPE TST ON (TST.TYPECODE =  NSI.MONITORING_LINK)
		       		LEFT JOIN T_S_TYPEGROUP TSTG ON (TSTG.ID = TST.TYPEGROUPID) 
	            WHERE 1=1
	            AND NSI.SAMPLE_STATUS = '5'
	            AND TSTG.TYPEGROUPCODE = 'allmonLink'
	            <if test="qt != '' and qt != null">
	            	AND NMP.LEADUNIT = #{qt}
	            </if>
	            <if test="pt != '' and pt != null">
<!-- 	            	AND NSI.SAMPLING_ORG_CODE = #{pt} -->
					AND NSI.DETECTION_CODE = #{pt}
<!--            			AND NMO.ORG_CODE = #{pt} -->
	            </if>
				<if test="projectCode != '' and projectCode != null ">
					AND NMP.PROJECT_CODE = #{projectCode}
				</if>
				<if test="agrName != '' and agrName != null">
					AND AGR.CNAME LIKE '%' || #{agrName} || '%'
				</if>
				<if test=" unitFullname != '' and unitFullname != null ">
					AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
				</if>
				<if test="monitoringLink != '' and monitoringLink != null">
				 	AND NSI.MONITORING_LINK = #{monitoringLink}
				</if>
				<if test="id != '' and id != null ">
					AND NSI.ID = #{id}
				</if>
				GROUP BY NSI.ID,NSI.SAMPLE_CODE, NMT.TASKNAME, 
					     CASE
                         WHEN NMP.DETACHED = '0' THEN
                          NSI.D_CODE
                         WHEN NMP.DETACHED = '1' THEN
                          NSI.SP_CODE END,
						 AGR.CNAME, 
						 NSI.UNIT_FULLNAME, TST.TYPENAME,NSI.UNIT_ADDRESS,SAMPLING_DATE,
				         NOI1.OGRNAME,NOI2.OGRNAME
	      	) T
	</select>
	
	
	<!-- vvv==================================================================================================================== -->
	<select id="getLeftDetectionInfoCollect" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
			SELECT TO_CHAR(ROWNUM) AS rowIndex,
				   T.TASKNAME AS taskname,
				   T.CITY_AND_COUNTY AS cityAndCounty,
				   CASE WHEN
				   	 T.IS_OVERPROOF = '1' THEN '不合格'
				   	 WHEN
				   	 T.IS_OVERPROOF = '0' THEN '合格'
				   	 END AS isOverProof,
				   T.SP_CODE AS spCode,
				   T.CNAME AS cname,
				   T.UNIT_FULLNAME AS unitFullName,
				   T.MONITORING_LINKK AS monitoringLink,
				   NVL(T.UNIT_ADDRESS, ' ') AS unitAddress,
				   <if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 1">
          		   SAMPLE_SOURCE as smapleSource,
          			</if>
          			<if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 5">
          		   ANIMAL_ORIGIN as smapleSource,
          			</if>
				   T.SAMPLING_OGRNAME AS samplingOrgName,
				   T.DETECTION_ORGNAME AS detectionOrgName
			  FROM (
			  SELECT NSI.ID,
			  		 NSI.SAMPLE_CODE,
			  		 NMT.TASKNAME,
			  		 AREA1.AREANAME || AREA2.AREANAME AS CITY_AND_COUNTY,
			  		 CASE WHEN NMP.DETACHED = '0' 
			  		 	THEN NSI.D_CODE
			  		      WHEN NMP.DETACHED = '1'
			  		    THEN NSI.SP_CODE END AS SP_CODE,
			  		 AGR.CNAME,
			  		 NSI.UNIT_FULLNAME,
			  		 TST.TYPENAME AS MONITORING_LINKK,
			  		 NSI.UNIT_ADDRESS,
			  		 TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
			  		 <if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 1">
          			NVL(NRM.SAMPLE_SOURCE, ' ') AS SAMPLE_SOURCE,
          			</if>
          			<if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 5">
          			NVL(NL.ANIMAL_ORIGIN, ' ') AS ANIMAL_ORIGIN,
          			</if>
			  		 NOI1.OGRNAME AS SAMPLING_OGRNAME,
			  		 NOI2.OGRNAME AS DETECTION_ORGNAME,			  		 
			  		 DECODE(SUM(DECODE(NDI.IS_OVERPROOF,'0',0,'1',1)),0,'0','1') AS IS_OVERPROOF
					FROM NKY_SAMPLING_INFO NSI
					INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
					INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
					INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 					INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
					LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
					LEFT JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
					LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
					INNER JOIN NKY_DETECTION_INFORMATION NDI ON(NDI.SAMPLE_CODE = NSI.SAMPLE_CODE)
				    LEFT JOIN T_S_TYPE TST ON (TST.TYPECODE =  NSI.MONITORING_LINK)
		       		LEFT JOIN T_S_TYPEGROUP TSTG ON (TSTG.ID = TST.TYPEGROUPID) 
		       		LEFT JOIN SYS_AREA_CODE AREA1 ON AREA1.CODE = NSI.CITY_CODE
          			LEFT JOIN SYS_AREA_CODE AREA2 ON AREA2.CODE = NSI.COUNTY_CODE
          			<if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 1">
          			LEFT JOIN NKY_ROUTINE_MONITORING NRM ON (NSI.SAMPLE_CODE = NRM.SAMPLE_CODE)
          			</if>
          			<if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 5">
          			LEFT JOIN NKY_LIVESTOCK NL ON (NSI.SAMPLE_CODE = NL.SAMPLE_CODE)
          			</if>
	            WHERE 1=1
	            AND NSI.SAMPLE_STATUS = '5'
	            AND TSTG.TYPEGROUPCODE = 'allmonLink'
	            <if test="qt != '' and qt != null">
	            	AND NMP.LEADUNIT = #{qt}
	            </if>
	            <if test="pt != '' and pt != null">
<!-- 	            	AND NSI.SAMPLING_ORG_CODE = #{pt} -->
					AND NSI.DETECTION_CODE = #{pt}
<!--            			AND NMO.ORG_CODE = #{pt} -->
	            </if>
				<if test="projectCode != '' and projectCode != null ">
					AND NMP.PROJECT_CODE = #{projectCode}
				</if>
				<if test="agrName != '' and agrName != null">
					AND AGR.CNAME LIKE '%' || #{agrName} || '%'
				</if>
				<if test=" unitFullname != '' and unitFullname != null ">
					AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
				</if>
				<if test="monitoringLink != '' and monitoringLink != null">
				 	AND NSI.MONITORING_LINK = #{monitoringLink}
				</if>
				<if test="id != '' and id != null ">
					AND NSI.ID = #{id}
				</if>
				GROUP BY NSI.ID,NSI.SAMPLE_CODE, NMT.TASKNAME, 
				     	AREA1.AREANAME,AREA2.AREANAME,
                 		AREA1.SHOW_ORDER,AREA2.SHOW_ORDER,
					     CASE
                         WHEN NMP.DETACHED = '0' THEN
                          NSI.D_CODE
                         WHEN NMP.DETACHED = '1' THEN
                          NSI.SP_CODE END,
						 AGR.CNAME, 
						 NSI.UNIT_FULLNAME, TST.TYPENAME,NSI.UNIT_ADDRESS,SAMPLING_DATE,
					  	<if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 1">
	          			NRM.SAMPLE_SOURCE,
	          			</if>
	          			<if test="sampleMonType != '' and sampleMonType != null and sampleMonType == 5">
	          			NL.ANIMAL_ORIGIN,
	          			</if>
				         NOI1.OGRNAME,NOI2.OGRNAME
				ORDER BY AREA1.SHOW_ORDER,AREA2.SHOW_ORDER,NSI.SAMPLE_CODE
	      	) T
	</select>
	
	<select id="getDetectionInfoPollHeader" resultType="java.lang.String" parameterType="java.util.HashMap">
	    SELECT
			PD.POPCNAME AS pollName
		FROM 
			NKY_DETECTION_INFORMATION NDI
			INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
			INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
			INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			LEFT JOIN V_NKY_MONITORING_POLL PD ON PD.CAS = NDI.CAS_CODE AND PD.PROJECT_CODE = NMP.PROJECT_CODE 
		WHERE
			NMT.PROJECT_CODE = #{projectCode}
			<if test="qt != '' and qt != null">
	            AND NMP.LEADUNIT = #{qt}
	        </if>
			<if test="pt != '' and pt != null">
				AND NSI.DETECTION_CODE = #{pt}
            </if>
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
			<if test="agrName != '' and agrName != null">
				AND AGR.CNAME LIKE '%' || #{agrName} || '%'
			</if>
			<if test=" unitFullname != '' and unitFullname != null ">
				AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="monitoringLink != '' and monitoringLink != null">
			 	AND NSI.MONITORING_LINK = #{monitoringLink}
			</if>
		 Group by PD.CAS,PD.POPCNAME
   		 ORDER BY PD.CAS  	
	</select>
	
	<resultMap type="java.util.HashMap" id="detectionInfoCollectRightResult">
	    <result column="SAMPLE_CODE" property="sampleCode"/>
		<result column="POPCNAME" property="popCname"/>  
		<result column="DETECTION_VALUE" property="detectionValue"/>
    </resultMap>  
	
	<select id="getRightDetectionInfoCollect" resultMap="detectionInfoCollectRightResult" parameterType="java.util.HashMap">
		SELECT
			NSI.SAMPLE_CODE,
			PD.POPCNAME,
			NDI.DETECTION_VALUE
		FROM 
			NKY_DETECTION_INFORMATION NDI
			INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
			INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
			INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			LEFT JOIN V_NKY_MONITORING_POLL PD ON PD.CAS = NDI.CAS_CODE AND PD.PROJECT_CODE = NMP.PROJECT_CODE
			LEFT JOIN SYS_AREA_CODE AREA1 ON AREA1.CODE = NSI.CITY_CODE
            LEFT JOIN SYS_AREA_CODE AREA2 ON AREA2.CODE = NSI.COUNTY_CODE
		WHERE
			NMT.PROJECT_CODE = #{projectCode}
			AND NSI.SAMPLE_STATUS = '5'
	        <if test="qt != '' and qt != null">
            	AND NMP.LEADUNIT = #{qt}
            </if>
			<if test="pt != '' and pt != null">
				AND NSI.DETECTION_CODE = #{pt}
            </if>
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
			<if test="agrName != '' and agrName != null">
				AND AGR.CNAME LIKE '%' || #{agrName} || '%'
			</if>
			<if test=" unitFullname != '' and unitFullname != null ">
				AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="monitoringLink != '' and monitoringLink != null">
			 	AND NSI.MONITORING_LINK = #{monitoringLink}
			</if>
		 Group by NSI.SAMPLE_CODE,AREA1.SHOW_ORDER,AREA2.SHOW_ORDER,PD.CAS,PD.POPCNAME,NDI.DETECTION_VALUE
   		 ORDER BY AREA1.SHOW_ORDER,AREA2.SHOW_ORDER,NSI.SAMPLE_CODE,PD.CAS
	</select>
	<!-- ==================================================================================================================== -->
	
	<select id="getPollDetectionResult" resultType="com.hippo.nky.entity.detection.NkyDetectionInformationEntity" parameterType="java.util.HashMap">
	 	 SELECT 
			  NDI.DETECTION_VALUE AS detectionValue,
			  NPD.POPCNAME AS pollName
			FROM NKY_DETECTION_INFORMATION NDI
		    LEFT JOIN NKY_POLL_DICTIONARY NPD ON(NPD.CAS = NDI.CAS_CODE) 
          WHERE NDI.SAMPLE_CODE = #{sampleCode} 
	</select>
	<!-- ======================================================================================================================-->
	
	<update id="updateSamplesByIds" parameterType="java.util.HashMap">
		UPDATE NKY_SAMPLING_INFO NSI SET NSI.PRINT_COUNT = NVL(NSI.PRINT_COUNT,0)+1 WHERE NSI.ID IN
	    <foreach collection="ids" index="index" item="item" open="(" separator="," close=")">
	     	#{item}
	    </foreach>
	</update>
	
	<select id="getDetectionInfoSampleCount" resultType="java.lang.Integer" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
<!-- 		SELECT COUNT(labCode) -->
<!-- 		  FROM ( -->
<!-- 				SELECT NSI.LAB_CODE                                                     AS labCode -->
<!-- 					  ,NSI.AGR_CODE                                                     AS agrCode -->
<!-- 					  ,AGR.CNAME                                                        AS sampleName -->
<!-- 					  ,MAX(CASE -->
<!--                              WHEN NDI.DETECTION_VALUE <![CDATA[<]]> 0 THEN -->
<!--                               1 -->
<!--                              WHEN NDI.DETECTION_VALUE = 0 THEN -->
<!--                               0 -->
<!--                              WHEN NDI.DETECTION_VALUE > 0 THEN -->
<!--                               NDI.DETECTION_VALUE -->
<!--                            END)                                                         AS isCreate -->
<!-- 				  FROM NKY_DETECTION_INFORMATION NDI -->
<!-- 				 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE -->
<!-- 				 INNER JOIN (SELECT NSI.ID, -->
<!-- 								    CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE -->
<!-- 							   FROM NKY_SAMPLING_INFO NSI -->
<!-- 							  INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!-- 							  INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!-- 							  WHERE NMP.PROJECT_CODE = #{projectCode} -->
<!-- 							 ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID -->
<!-- 				 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE -->
<!-- 				 INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE)  -->
<!-- 				 											  AND MDT.POLL_CAS = NDI.CAS_CODE -->
<!-- 				 LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = MDT.PROJECT_CODE) -->
<!-- 				 WHERE OI.ID = #{orgCode} -->
<!-- 				   AND MDT.PROJECT_CODE = #{projectCode} -->
<!-- 				   除去费样、除去已上报、且进行了实验室编码的 -->
<!-- 				   AND NSI.SAMPLE_STATUS = '4' -->
<!-- 				搜索条件-Strat -->
<!-- 				实验室编码 -->
<!-- 				<if test="labCode != '' and labCode != null "> -->
<!-- 				   AND NSI.LAB_CODE like '%' || #{labCode} || '%' -->
<!-- 				</if> -->
<!-- 				样品名称 -->
<!-- 				<if test=" sampleName != '' and sampleName != null "> -->
<!-- 				   AND AGR.CNAME LIKE '%' || #{sampleName} || '%' -->
<!-- 				</if> -->
<!-- 				搜索条件-End -->
<!-- 				 GROUP BY NSI.LAB_CODE, AGR.CNAME, NSI.AGR_CODE -->
<!-- 				 ORDER BY NSI.LAB_CODE -->
<!-- 		) -->
		
		   SELECT COUNT(1)
			  FROM NKY_SAMPLING_INFO NSI
			  INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
			  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMT.PROJECT_CODE)
			  LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NOI.CODE = NSI.DETECTION_CODE)
			  WHERE NOI.ID = #{orgCode}
			  AND NMT.PROJECT_CODE = #{projectCode}
			  AND NSI.SAMPLE_STATUS = '4'
			  <if test="labCode != '' and labCode != null ">
				   AND NSI.LAB_CODE like '%' || #{labCode} || '%'
			  </if>
			  <if test=" sampleName != '' and sampleName != null ">
				   AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			  </if>
			  <if test=" spCode != '' and spCode != null ">
				   AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
			  </if>	
	</select>
	
	<select id="getDetectionInfoSample" resultType="com.hippo.nky.entity.detection.DetectionEntity" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
<!-- 		SELECT T.*  -->
<!-- 		  FROM ( -->
<!-- 				SELECT TEMP.*,ROWNUM AS RN FROM( -->
<!-- 					SELECT NSI.LAB_CODE                                                     AS labCode -->
<!-- 						  ,NSI.SP_CODE                                                      AS spCode -->
<!-- 						  ,NSI.AGR_CODE                                                     AS agrCode -->
<!-- 						  ,AGR.CNAME                                                        AS sampleName -->
<!-- 						  ,MAX(CASE -->
<!--                              WHEN NDI.DETECTION_VALUE <![CDATA[<]]> 0 THEN -->
<!--                               1 -->
<!--                              WHEN NDI.DETECTION_VALUE = 0 THEN -->
<!--                               0 -->
<!--                              WHEN NDI.DETECTION_VALUE > 0 THEN -->
<!--                               NDI.DETECTION_VALUE -->
<!--                            END)                                                             AS isCreate -->
<!-- 					  FROM NKY_DETECTION_INFORMATION NDI -->
<!-- 					 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE -->
<!-- 					 INNER JOIN (SELECT NSI.ID, -->
<!-- 									    CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE -->
<!-- 								   FROM NKY_SAMPLING_INFO NSI -->
<!-- 								  INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!-- 								  INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!-- 								  WHERE NMP.PROJECT_CODE = #{projectCode} -->
<!-- 								 ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID -->
<!-- 					 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE -->
<!-- 					 INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE)  -->
<!-- 					 											  AND MDT.POLL_CAS = NDI.CAS_CODE -->
<!-- 					 LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = MDT.PROJECT_CODE) -->
<!-- 					 WHERE OI.ID = #{orgCode} -->
<!-- 					   AND MDT.PROJECT_CODE = #{projectCode} -->
<!-- 					   除去费样、除去已上报、且进行了实验室编码的 -->
<!-- 					   AND NSI.SAMPLE_STATUS = '4' -->
<!-- 					搜索条件-Strat -->
<!-- 					实验室编码 -->
<!-- 					<if test="labCode != '' and labCode != null "> -->
<!-- 					   AND NSI.LAB_CODE like '%' || #{labCode} || '%' -->
<!-- 					</if> -->
<!-- 					样品名称 -->
<!-- 					<if test=" sampleName != '' and sampleName != null "> -->
<!-- 					   AND AGR.CNAME LIKE '%' || #{sampleName} || '%' -->
<!-- 					</if> -->
<!-- 					样品名称 -->
<!-- 					<if test=" spCode != '' and spCode != null "> -->
<!-- 					   AND NSI.SP_CODE LIKE '%' || #{spCode} || '%' -->
<!-- 					</if> -->
<!-- 					搜索条件-End -->
<!-- 					 GROUP BY NSI.LAB_CODE,NSI.SP_CODE,AGR.CNAME, NSI.AGR_CODE -->
<!-- 					 ORDER BY NSI.LAB_CODE -->
<!-- 				) TEMP -->
<!-- 			) T -->
<!-- 		 WHERE T.RN > #{beginIndex} AND T.RN <![CDATA[ <= ]]>  #{endIndex} -->
		 
		 SELECT * FROM (
			 SELECT T.*,ROWNUM AS RN FROM(
				  SELECT NSI.LAB_CODE                                                AS labCode
				  	  <if test=" detachedFlg != '' and detachedFlg != null and detachedFlg == 1">
					  ,NSI.SP_CODE                                                   AS spCode
					  </if>
					  <if test=" detachedFlg != '' and detachedFlg != null and detachedFlg == 0">
					  ,NSI.D_CODE                                                   AS spCode
					  </if>
					  ,NSI.AGR_CODE                                                  AS agrCode
					  ,AGR.CNAME                                                     AS sampleName
				  FROM NKY_SAMPLING_INFO NSI
				  INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
				  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMT.PROJECT_CODE)
			      LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NOI.CODE = NSI.DETECTION_CODE)
			      WHERE NOI.ID = #{orgCode}
				  AND NMT.PROJECT_CODE = #{projectCode}
				  AND NSI.SAMPLE_STATUS = '4'
				  <if test="labCode != '' and labCode != null ">
					   AND NSI.LAB_CODE like '%' || #{labCode} || '%'
				  </if>
				  <if test=" sampleName != '' and sampleName != null ">
					   AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
				  </if>
				  <if test=" spCode != '' and spCode != null and detachedFlg == 1">
					   AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
				  </if>
				  <if test=" spCode != '' and spCode != null and detachedFlg == 0">
					   AND NSI.D_CODE LIKE '%' || #{spCode} || '%'
				  </if>	
				  <if test=" detachedFlg != '' and detachedFlg != null and detachedFlg == 1">
				  	   ORDER BY substr(NSI.SP_CODE,1,inStr(NSI.SP_CODE,'-',-1)-1),to_number(substr(NSI.SP_CODE,inStr(NSI.SP_CODE,'-',-1)+1))
				  </if>
				  <if test=" detachedFlg != '' and detachedFlg != null and detachedFlg == 0">
				  	   ORDER BY substr(NSI.LAB_CODE,1,inStr(NSI.LAB_CODE,'-',-1)-1),to_number(substr(NSI.LAB_CODE,inStr(NSI.LAB_CODE,'-',-1)+1))
				  </if>
				) T
			 )
			WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex} 
	</select>
	
	<select id="getDetectionInfoPollCount" resultType="java.lang.Integer" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
<!-- 	   SELECT COUNT(casCode) -->
<!-- 	     FROM ( -->
<!-- 				SELECT NDI.CAS_CODE                                                     AS casCode -->
<!-- 					  ,PD.POPCNAME                                                      AS pollName -->
<!-- 					  ,MAX(CASE -->
<!--                              WHEN NDI.DETECTION_VALUE <![CDATA[<]]> 0 THEN -->
<!--                               1 -->
<!--                              WHEN NDI.DETECTION_VALUE = 0 THEN -->
<!--                               0 -->
<!--                              WHEN NDI.DETECTION_VALUE > 0 THEN -->
<!--                               NDI.DETECTION_VALUE -->
<!--                            END)                                                         AS isCreate -->
<!-- 				  FROM NKY_DETECTION_INFORMATION NDI -->
<!-- 				 INNER JOIN NKY_SAMPLING_INFO NSI ON NDI.SAMPLE_CODE = NSI.SAMPLE_CODE -->
<!-- 				 INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE) -->
<!-- 				 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = NSI.DETECTION_CODE -->
<!-- 				  LEFT JOIN V_NKY_MONITORING_POLL PD ON PD.CAS = NDI.CAS_CODE AND PD.PROJECT_CODE = MDT.PROJECT_CODE -->
<!-- 				 WHERE OI.ID = #{orgCode} -->
<!-- 				   AND MDT.PROJECT_CODE = #{projectCode} -->
<!-- 				   除去费样、除去已上报、且进行了实验室编码的 -->
<!-- 				   AND NSI.SAMPLE_STATUS = '4' -->
<!-- 				搜索条件-Strat -->
<!-- 				污染物名称 -->
<!-- 				<if test="pollName != '' and pollName != null "> -->
<!-- 				   AND PD.POPCNAME LIKE '%' || #{pollName} || '%' -->
<!-- 				</if> -->
<!-- 				搜索条件-End -->
<!-- 				 GROUP BY NDI.CAS_CODE, PD.POPCNAME -->
<!-- 		) -->
		
			 SELECT COUNT(1) FROM(
			     SELECT 
					PD.CAS,PD.POPCNAME
					FROM
					(
						SELECT
							NSI.AGR_CODE
						FROM
						 NKY_SAMPLING_INFO NSI 
						 INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
						 LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NOI.CODE = NSI.DETECTION_CODE)          
						WHERE NOI.ID = #{orgCode}
					     AND NMT.PROJECT_CODE = #{projectCode}
					     AND NSI.SAMPLE_STATUS = '4'
					    GROUP BY NSI.AGR_CODE
				    ) T
					LEFT JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON (MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,T.AGR_CODE)
																 AND MDT.PROJECT_CODE = #{projectCode})
					LEFT JOIN V_NKY_MONITORING_POLL PD ON (PD.CAS = MDT.POLL_CAS AND PD.PROJECT_CODE = MDT.PROJECT_CODE)
					WHERE 1=1
					<if test="pollName != '' and pollName != null ">
					  AND PD.POPCNAME LIKE '%' || #{pollName} || '%'
				    </if>
					GROUP BY PD.CAS,PD.POPCNAME
				)
	</select>
	
	<select id="getDetectionInfoPoll" resultType="com.hippo.nky.entity.detection.DetectionEntity" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
<!-- 		SELECT T.*  -->
<!-- 		  FROM ( -->
<!-- 				SELECT TEMP.*,ROWNUM AS RN FROM( -->
<!-- 					SELECT NDI.CAS_CODE                                                     AS casCode -->
<!-- 						  ,PD.POPCNAME                                                      AS pollName -->
<!-- 						  ,MAX(CASE -->
<!--                              WHEN NDI.DETECTION_VALUE <![CDATA[<]]> 0 THEN -->
<!--                               1 -->
<!--                              WHEN NDI.DETECTION_VALUE = 0 THEN -->
<!--                               0 -->
<!--                              WHEN NDI.DETECTION_VALUE > 0 THEN -->
<!--                               NDI.DETECTION_VALUE -->
<!--                            END)                                                             AS isCreate -->
<!-- 					  FROM NKY_DETECTION_INFORMATION NDI -->
<!-- 					 INNER JOIN NKY_SAMPLING_INFO NSI ON NDI.SAMPLE_CODE = NSI.SAMPLE_CODE -->
<!-- 					 INNER JOIN (SELECT NSI.ID, -->
<!-- 									    CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE -->
<!-- 								   FROM NKY_SAMPLING_INFO NSI -->
<!-- 								  INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!-- 								  INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!-- 								  WHERE NMP.PROJECT_CODE = #{projectCode} -->
<!-- 								 ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID -->
<!-- 					 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE -->
<!-- 					 INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE) -->
<!-- 					 											  AND MDT.POLL_CAS = NDI.CAS_CODE -->
<!-- 					  LEFT JOIN V_NKY_MONITORING_POLL PD ON PD.CAS = NDI.CAS_CODE AND PD.PROJECT_CODE = MDT.PROJECT_CODE -->
<!-- 					 WHERE OI.ID = #{orgCode} -->
<!-- 					   AND MDT.PROJECT_CODE = #{projectCode} -->
<!-- 					   除去费样、除去已上报、且进行了实验室编码的 -->
<!-- 					   AND NSI.SAMPLE_STATUS = '4' -->
<!-- 					搜索条件-Strat -->
<!-- 					污染物名称 -->
<!-- 					<if test="pollName != '' and pollName != null "> -->
<!-- 					   AND PD.POPCNAME LIKE '%' || #{pollName} || '%' -->
<!-- 					</if> -->
<!-- 					搜索条件-End -->
<!-- 					 GROUP BY NDI.CAS_CODE, PD.POPCNAME -->
<!-- 					 ORDER BY PD.POPCNAME -->
<!-- 				) TEMP -->
<!-- 			) T -->
<!-- 		WHERE T.RN > #{beginIndex} AND T.RN <![CDATA[ <= ]]>  #{endIndex} -->
		
		SELECT * FROM(
			SELECT T1.*,ROWNUM AS RN
			FROM
			(
				SELECT 
					PD.CAS                                                           AS casCode
				   ,PD.POPCNAME                                                      AS pollName
				FROM
				(
					SELECT
						NSI.AGR_CODE
					FROM
					 NKY_SAMPLING_INFO NSI 
					 INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
					 LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NOI.CODE = NSI.DETECTION_CODE)          
					WHERE NOI.ID = #{orgCode}
				     AND NMT.PROJECT_CODE = #{projectCode}
				     AND NSI.SAMPLE_STATUS = '4'
				    GROUP BY NSI.AGR_CODE
			    ) T
				LEFT JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON (MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,T.AGR_CODE)
															 AND MDT.PROJECT_CODE = #{projectCode})
				LEFT JOIN V_NKY_MONITORING_POLL PD ON (PD.CAS = MDT.POLL_CAS AND PD.PROJECT_CODE = MDT.PROJECT_CODE)
				WHERE 1=1
				<if test="pollName != '' and pollName != null ">
				  AND PD.POPCNAME LIKE '%' || #{pollName} || '%'
			    </if>
				GROUP BY PD.CAS,PD.POPCNAME
			) T1
		)
		WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	
	<select id="getDetectionInfoPollItem" resultType="com.hippo.nky.entity.detection.NkyDetectionInformationEntity" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
	    SELECT NDI.ID              AS id
		      ,NDI.CAS_CODE        AS casCode
		      ,PD.POPCNAME         AS pollName
		      ,NDI.DETECTION_VALUE AS detectionValue
		  FROM NKY_DETECTION_INFORMATION NDI
		 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
		 INNER JOIN (SELECT NSI.ID,
						    CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE
					   FROM NKY_SAMPLING_INFO NSI
					  INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
					  INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
					  WHERE NMP.PROJECT_CODE = #{projectCode}
					 ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID
		 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE
		 INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE) 
		                                              AND MDT.POLL_CAS = NDI.CAS_CODE
		 INNER JOIN (select NPD.cas, NPD.popcname
     from nky_poll_products NPD
     join nky_standard_version nsv
       on nsv.poll_version_id = NPD.versionid
     join nky_monitoring_project nmp
       on nmp.judge_version_id = nsv.id
    where nmp.project_code = #{projectCode}) PD ON NDI.CAS_CODE = PD.CAS
		 WHERE MDT.PROJECT_CODE = #{projectCode}
		   AND OI.ID = #{orgCode}
		   AND NSI.LAB_CODE = #{labCode}
		   AND NSI.AGR_CODE = #{agrCode}
		   <!-- 除去费样、除去已上报、且进行了实验室编码的 -->
		   AND NSI.SAMPLE_STATUS = #{sampleStatus}
		<!-- 搜索条件-Strat -->
		<!-- 污染物名称 -->
		<if test="pollName != '' and pollName != null ">
		   AND PD.POPCNAME LIKE '%' || #{pollName} || '%'
		</if>
		<!-- 是否detail数据 -->
		<if test="isDetail != '' and isDetail != null ">
		   AND NDI.DETECTION_VALUE != 0
		</if>
		<!-- 搜索条件-End -->
		 ORDER BY PD.POPCNAME
	</select>
	
	<select id="getDetectionInfoAgrItem" resultType="com.hippo.nky.entity.detection.NkyDetectionInformationEntity" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
		SELECT NDI.ID              AS id
		      ,NDI.DETECTION_VALUE AS detectionValue
		      ,NSI.LAB_CODE        AS labCode
		      ,AGR.CNAME           AS sampleName
		  FROM NKY_DETECTION_INFORMATION NDI
		  INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
		  INNER JOIN (SELECT NSI.ID,
						     CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE
					    FROM NKY_SAMPLING_INFO NSI
					   INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
					   INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
					   WHERE NMP.PROJECT_CODE = #{projectCode}
					  ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID
		  INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE
		  INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE) 
		                                               AND MDT.POLL_CAS = NDI.CAS_CODE
		  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = MDT.PROJECT_CODE)
		  WHERE MDT.PROJECT_CODE = #{projectCode}
		    AND OI.ID = #{orgCode}
		    AND NDI.CAS_CODE = #{casCode}
		    <!-- 除去费样、除去已上报、且进行了实验室编码的 -->
		    AND NSI.SAMPLE_STATUS = '4'
		<!-- 搜索条件-Strat -->
		<!-- 样品名称 -->
		<if test="sampleName != '' and sampleName != null ">
		    AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
		</if>
		<!-- 实验室编码 -->
		<if test="labCode != '' and labCode != null ">
		    AND NSI.LAB_CODE like '%' || #{labCode} || '%'
		</if>
		<!-- 是否detail数据 -->
		<if test="isDetail != '' and isDetail != null ">
		   AND NDI.DETECTION_VALUE != 0
		</if>
		<!-- 搜索条件-End -->
		  ORDER BY NSI.LAB_CODE
	</select>
	
	<!-- 设置当前污染物对应的全部的样品检出值=未检 -->
	<update id="setAllWithUnDetection" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
		UPDATE NKY_DETECTION_INFORMATION UNDI
		   SET UNDI.DETECTION_VALUE = -1
		 WHERE EXISTS (SELECT NDI.ID
		          FROM NKY_DETECTION_INFORMATION NDI
		         INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
				 INNER JOIN (SELECT NSI.ID,
										     CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE
									    FROM NKY_SAMPLING_INFO NSI
									   INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
									   INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
									   WHERE NMP.PROJECT_CODE = #{projectCode}
									  ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID
						  INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE
		         INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE)
		                                                      AND MDT.POLL_CAS = NDI.CAS_CODE
		          LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = MDT.PROJECT_CODE)
		         WHERE MDT.PROJECT_CODE = #{projectCode}
		           AND OI.ID = #{orgCode}
		           AND NDI.CAS_CODE = #{casCode}
		           <!-- 除去费样、除去已上报、且进行了实验室编码的 -->
		           AND NSI.SAMPLE_STATUS = '4'
		           AND UNDI.ID = NDI.ID)
	</update>
	
	<!-- 取得要更新的样品 -->
	<select id="getDetectionUpdateSampleCode" resultType="java.lang.String" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
      SELECT
         NSI.SAMPLE_CODE
      FROM
	     NKY_SAMPLING_INFO NSI
	     INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
	     INNER JOIN NKY_ORGANIZATION_INFO NOI ON NSI.DETECTION_CODE = NOI.CODE
	     <if test="labCode == '' or labCode == null ">
	     	inner join  NKY_DETECTION_INFORMATION NDI ON (NSI.SAMPLE_CODE = NDI.SAMPLE_CODE)
	     </if>
	  WHERE 
	      NMT.PROJECT_CODE = #{projectCode}
	      AND NOI.ID = #{orgCode}
	      <if test="labCode != '' and labCode != null ">
	      	AND NSI.LAB_CODE = #{labCode}
	      </if>
	       <if test="labCode == '' or labCode == null ">
	       AND NDI.IS_OVERPROOF = '3'
	       </if>
	      and nsi.sample_status in ('4','5')
	</select>
	
	<!-- 取得需要设置样品检测是否超标的记录 --> 
<!-- 	<update id="setOverproofRecord" parameterType="com.hippo.nky.entity.detection.DetectionEntity"> -->
<!-- 		UPDATE NKY_DETECTION_INFORMATION UNDI -->
<!-- 		   SET UNDI.IS_OVERPROOF = ( -->
<!-- 									SELECT CASE WHEN NDI.DETECTION_VALUE <![CDATA[<=]]> CASE WHEN JS.VALUE IS NULL THEN 0 ELSE JS.VALUE END THEN 0 ELSE 1 END AS ISOVERPROOF -->
<!-- 									  FROM NKY_DETECTION_INFORMATION NDI -->
<!-- 									 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE -->
<!-- 									 INNER JOIN (SELECT NSI.ID, -->
<!-- 															     CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE -->
<!-- 														    FROM NKY_SAMPLING_INFO NSI -->
<!-- 														   INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!-- 														   INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!-- 														   WHERE NMP.PROJECT_CODE = #{projectCode} -->
<!-- 														  ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID -->
<!-- 									 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE -->
<!-- 									 INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE) -->
<!-- 									                                              AND MDT.POLL_CAS = NDI.CAS_CODE -->
<!-- 									 LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = MDT.PROJECT_CODE) -->
<!-- 									  LEFT JOIN V_NKY_MONITORING_POLL PP ON (PP.CAS = NDI.CAS_CODE AND PP.PROJECT_CODE = MDT.PROJECT_CODE) -->
<!-- 									  LEFT JOIN V_NKY_MONITORING_JUDGE JS ON (JS.AGRID = AGR.ID -->
<!-- 									                                 AND JS.POLLID = PP.ID -->
<!-- 									                                 AND JS.PROJECT_CODE = MDT.PROJECT_CODE) -->
<!-- 									 WHERE NDI.IS_OVERPROOF = '3' -->
<!-- 									   AND OI.ID = #{orgCode} -->
<!-- 									   AND MDT.PROJECT_CODE = #{projectCode} -->
<!-- 									   除去费样、除去已上报、且进行了实验室编码的 -->
<!-- 									   AND NSI.SAMPLE_STATUS IN ('4','5') -->
<!-- 									   <if test="labCode != '' and labCode != null "> -->
<!-- 									   AND NSI.LAB_CODE = #{labCode} -->
<!-- 									   </if> -->
<!-- 									   AND UNDI.ID = NDI.ID -->
<!-- 									) -->
<!-- 		 WHERE EXISTS ( -->
<!-- 		 		SELECT NDI.ID -->
<!-- 				  FROM NKY_DETECTION_INFORMATION NDI -->
<!-- 				 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE -->
<!-- 				 INNER JOIN (SELECT NSI.ID, -->
<!-- 										     CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE -->
<!-- 									    FROM NKY_SAMPLING_INFO NSI -->
<!-- 									   INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!-- 									   INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!-- 									   WHERE NMP.PROJECT_CODE = #{projectCode} -->
<!-- 									  ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID -->
<!-- 				 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE -->
<!-- 				 INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE) -->
<!-- 				                                              AND MDT.POLL_CAS = NDI.CAS_CODE -->
<!-- 				  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = MDT.PROJECT_CODE) -->
<!-- 				  LEFT JOIN V_NKY_MONITORING_POLL PP ON (PP.CAS = NDI.CAS_CODE AND PP.PROJECT_CODE = MDT.PROJECT_CODE) -->
<!-- 				  LEFT JOIN V_NKY_MONITORING_JUDGE JS ON JS.AGRID = AGR.ID -->
<!-- 				                                 AND JS.POLLID = PP.ID -->
<!-- 				                                 AND JS.PROJECT_CODE = MDT.PROJECT_CODE -->
<!-- 				 WHERE NDI.IS_OVERPROOF = '3' -->
<!-- 				   AND OI.ID = #{orgCode} -->
<!-- 				   AND MDT.PROJECT_CODE = #{projectCode} -->
<!-- 				   除去费样、除去已上报、且进行了实验室编码的 -->
<!-- 				   AND NSI.SAMPLE_STATUS IN ('4','5') -->
<!-- 				   <if test="labCode != '' and labCode != null "> -->
<!-- 				   AND NSI.LAB_CODE = #{labCode} -->
<!-- 				   </if> -->
<!-- 				   AND UNDI.ID = NDI.ID -->
<!-- 		 ) -->
<!-- 	</update> -->
	
	
		<!-- 取得需要设置样品检测是否超标的记录 -->
	<update id="setOverproofRecord" parameterType="java.lang.String">
		UPDATE NKY_DETECTION_INFORMATION UNDI
		   SET UNDI.IS_OVERPROOF = (
<!-- 		   						SELECT DECODE(SUM(ISOVERPROOF),0,0,1) -->
		   						SELECT ISOVERPROOF
     							 from (
									SELECT CASE WHEN NDI.DETECTION_VALUE <![CDATA[<=]]> CASE WHEN JS.VALUE IS NULL THEN 0 ELSE JS.VALUE END THEN 0 ELSE 1 END AS ISOVERPROOF,
											NDI.ID AS ID
									  FROM NKY_DETECTION_INFORMATION NDI
									 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
									 INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
									  INNER JOIN V_NKY_MONITORING_POLL PP ON (PP.CAS = NDI.CAS_CODE AND PP.PROJECT_CODE = NMT.PROJECT_CODE)
									  INNER JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMT.PROJECT_CODE)
									  INNER JOIN V_NKY_MONITORING_JUDGE JS ON (JS.AGRID = AGR.ID
									                                 AND JS.POLLID = PP.ID
									                                 AND JS.PROJECT_CODE = NMT.PROJECT_CODE)
									 WHERE NDI.IS_OVERPROOF = '3'
									 AND NSI.SAMPLE_CODE = #{sampleCode}
									) T
									where UNDI.ID = T.ID
								)
		 WHERE EXISTS (
		 		SELECT NDI.ID
				   FROM NKY_DETECTION_INFORMATION NDI
									 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
									 WHERE NDI.IS_OVERPROOF = '3'
									 AND NSI.SAMPLE_CODE = #{sampleCode}
									 AND UNDI.ID = NDI.ID
		 )
	</update>
	
 	<!-- 更新超标样品 -->
<!-- 	<update id="updateOverproofSampleInfo" parameterType="com.hippo.nky.entity.detection.DetectionEntity"> -->
<!-- 		UPDATE NKY_SAMPLING_INFO UNSI -->
<!-- 		   SET UNSI.IS_QUALIFIED = (SELECT CASE WHEN COUNT(NDI.ID) > 0 THEN 1 ELSE 0 END -->
<!-- 		                              FROM NKY_DETECTION_INFORMATION NDI -->
<!-- 		                             INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE -->
<!-- 		                             INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!-- 		                             INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!-- 		                             INNER JOIN (SELECT NSI.ID, -->
<!-- 		                                                CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE -->
<!-- 		                                           FROM NKY_SAMPLING_INFO NSI -->
<!-- 		                                          INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!-- 		                                          INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!-- 		                                          WHERE NMP.PROJECT_CODE = #{projectCode}) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID -->
<!-- 		                             INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE -->
<!-- 		                             WHERE NMP.PROJECT_CODE = #{projectCode} -->
<!-- 		                               AND OI.ID = #{orgCode} -->
<!-- 		                               <if test="labCode != '' and labCode != null "> -->
<!-- 									   AND NSI.LAB_CODE = #{labCode} -->
<!-- 									   </if> -->
<!-- 		                               AND NDI.IS_OVERPROOF = '1' -->
<!-- 		                               ) -->
<!-- 		 WHERE EXISTS -->
<!-- 		 (SELECT DISTINCT NSI.ID -->
<!--             FROM NKY_DETECTION_INFORMATION NDI -->
<!--            INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE -->
<!--            INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!--            INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!--            INNER JOIN (SELECT NSI.ID, -->
<!--                               CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE -->
<!--                          FROM NKY_SAMPLING_INFO NSI -->
<!--                         INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE -->
<!--                         INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE -->
<!--                         WHERE NMP.PROJECT_CODE = #{projectCode}) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID -->
<!--            INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE -->
<!--            WHERE NMP.PROJECT_CODE = #{projectCode} -->
<!--              AND OI.ID = #{orgCode} -->
<!--              <if test="labCode != '' and labCode != null "> -->
<!--              AND NSI.LAB_CODE = #{labCode} -->
<!--              </if> -->
<!--              AND NDI.IS_OVERPROOF = '1' -->
<!--              AND UNSI.ID = NSI.ID -->
<!-- 		 ) -->
<!-- 	</update> -->
	
		<!-- 更新超标样品 -->
	<update id="updateOverproofSampleInfo" parameterType="java.lang.String">
		UPDATE NKY_SAMPLING_INFO UNSI
		   SET UNSI.IS_QUALIFIED = (
									SELECT DECODE(SUM(ISOVERPROOF),0,0,1)
     							 from (
									SELECT CASE WHEN NDI.DETECTION_VALUE <![CDATA[<=]]> CASE WHEN JS.VALUE IS NULL THEN 0 ELSE JS.VALUE END THEN 0 ELSE 1 END AS ISOVERPROOF
									  FROM NKY_DETECTION_INFORMATION NDI
									 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
									 INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
									 INNER JOIN V_NKY_MONITORING_POLL PP ON (PP.CAS = NDI.CAS_CODE AND PP.PROJECT_CODE = NMT.PROJECT_CODE)
									 INNER JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMT.PROJECT_CODE)
									 INNER JOIN V_NKY_MONITORING_JUDGE JS ON (JS.AGRID = AGR.ID
									                                 AND JS.POLLID = PP.ID
									                                 AND JS.PROJECT_CODE = NMT.PROJECT_CODE)
									 AND NSI.SAMPLE_CODE = #{sampleCode}
									)
					)
		 WHERE EXISTS (
		 		SELECT NSI.ID
				   FROM
						NKY_SAMPLING_INFO NSI	 
				   where NSI.SAMPLE_CODE = #{sampleCode}
				   AND UNSI.ID = NSI.ID
		 )
	</update>
	
	<!-- 取得上报的污染物title -->
	<select id="getProjectPollInfo" resultType="com.hippo.nky.entity.detection.DetectionEntity" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
		SELECT MDT.POLL_CAS    AS casCode
			  ,PD.POPCNAME     AS pollName 
		  FROM NKY_MONITORING_DECTION_TEMPLET MDT
		  LEFT JOIN NKY_POLL_DICTIONARY PD ON PD.CAS = MDT.POLL_CAS
		WHERE MDT.PROJECT_CODE = #{projectCode}
		GROUP BY MDT.POLL_CAS,PD.POPCNAME
		ORDER BY PD.POPCNAME
	</select>
	<resultMap type="java.util.LinkedHashMap" id="detectionReportResult">
	</resultMap>
	<!-- 取得上报的数据 -->
	<select id="getReportList" parameterType="java.util.HashMap" statementType="CALLABLE">
          <![CDATA[
	          {call PKG_detection_info.report(
	           #{projectCode,mode=IN,jdbcType=VARCHAR}
	          ,#{orgCode,mode=IN,jdbcType=VARCHAR}
	          ,#{selCondtion,mode=IN,jdbcType=VARCHAR}
	          ,#{result,mode=OUT,jdbcType=CURSOR,resultMap=detectionReportResult}
	          )}
          ]]> 
	</select>
	<!-- 新的取得上报的数据 -->
	<resultMap type="java.util.HashMap" id="getReportListNewMap">
		<result column="lab_code" property="labCode" />
		<result column="CNAME" property="cname" />
		<result column="DETERESULT" property="deteResult" />
	</resultMap>

	<select id="getReportListNew" parameterType="java.util.HashMap"
		resultMap="getReportListNewMap">
		SELECT NSI.LAB_CODE,
		       NAC.CNAME,
		       WM_CONCAT(NDI.CAS_CODE || '#EM#' || NDI.DETECTION_VALUE || '#EM#' || NDI.IS_OVERPROOF) AS DETERESULT
		FROM   NKY_SAMPLING_INFO NSI,
		       NKY_MONITORING_PROJECT NMP,
		       NKY_MONITORING_TASK NMT,
			   NKY_DETECTION_INFORMATION NDI,
			   NKY_AGR_CATEGORY NAC,
			   NKY_STANDARD_VERSION NSV,
			   NKY_ORGANIZATION_INFO NOI
		WHERE  NSI.SAMPLE_STATUS = '4'
		   AND NSI.TASK_CODE = NMT.TASK_CODE
		   AND NMT.PROJECT_CODE = NMP.PROJECT_CODE
		   AND NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
		   AND NAC.CODE = NSI.AGR_CODE
		   AND NAC.VERSIONID = NSV.AGR_VERSION_ID
		   AND NSV.ID = NMP.JUDGE_VERSION_ID
		   AND NMT.ORG_CODE = NOI.CODE
		<if test="projectCode != '' and projectCode != null ">
			AND NMT.PROJECT_CODE = #{projectCode}
		</if>
		<if test="orgCode != '' and orgCode != null ">
			AND NOI.ID = #{orgCode}
		</if>
		<choose>
			<when test="selCondtion != null and selCondtion == 1">
				AND NSI.SAMPLE_CODE IN (SELECT DISTINCT NDI.SAMPLE_CODE
					FROM NKY_DETECTION_INFORMATION NDI,
						 NKY_SAMPLING_INFO NSI,
						 NKY_MONITORING_TASK NMT,
						 NKY_ORGANIZATION_INFO NOI
				   WHERE NSI.SAMPLE_STATUS = '4'
					 AND NSI.TASK_CODE = NMT.TASK_CODE
					 AND NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
					 AND NMT.ORG_CODE = NOI.CODE
				<if test="projectCode != '' and projectCode != null ">
					AND NMT.PROJECT_CODE = #{projectCode}
				</if>
				<if test="orgCode != '' and orgCode != null ">
					AND NOI.ID = #{orgCode}
				</if>
				AND NDI.DETECTION_VALUE > 0)
			</when>
			<when test="selCondtion != null and selCondtion == 2">
				AND NSI.SAMPLE_CODE IN (SELECT DISTINCT NDI.SAMPLE_CODE
					FROM NKY_DETECTION_INFORMATION NDI,
						 NKY_SAMPLING_INFO NSI,
						 NKY_MONITORING_TASK NMT,
						 NKY_ORGANIZATION_INFO NOI
				   WHERE NSI.SAMPLE_STATUS = '4'
					 AND NSI.TASK_CODE = NMT.TASK_CODE
					 AND NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
					 AND NMT.ORG_CODE = NOI.CODE
				<if test="projectCode != '' and projectCode != null ">
					AND NMT.PROJECT_CODE = #{projectCode}
				</if>
				<if test="orgCode != '' and orgCode != null ">
					AND NOI.ID = #{orgCode}
				</if>
				AND NDI.IS_OVERPROOF = '1')
			</when>
			<when test="selCondtion != null and selCondtion == 3">
				AND NSI.SAMPLE_CODE IN (SELECT DISTINCT NDI.SAMPLE_CODE
					FROM NKY_DETECTION_INFORMATION NDI,
						 NKY_SAMPLING_INFO NSI,
						 NKY_MONITORING_TASK NMT,
						 NKY_ORGANIZATION_INFO NOI
				   WHERE NSI.SAMPLE_STATUS = '4'
					 AND NSI.TASK_CODE = NMT.TASK_CODE
					 AND NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
					 AND NMT.ORG_CODE = NOI.CODE
				<if test="projectCode != '' and projectCode != null ">
					AND NMT.PROJECT_CODE = #{projectCode}
				</if>
				<if test="orgCode != '' and orgCode != null ">
					AND NOI.ID = #{orgCode}
				</if>
				AND NDI.DETECTION_VALUE <![CDATA[<]]>
				0)
			</when>
		</choose>
		GROUP BY NSI.LAB_CODE, NAC.CNAME
	</select>
	
	<!-- 设置样品的状态为上报完成-->
	<update id="setDetectionReported" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
		UPDATE NKY_SAMPLING_INFO UNSI
		   SET UNSI.SAMPLE_STATUS = '5', UNSI.DETECTION_REPORTING_DATE = #{detectionReportingDate}
		 WHERE EXISTS
		 (SELECT NSI.ID
		          FROM NKY_SAMPLING_INFO NSI
		         INNER JOIN NKY_DETECTION_INFORMATION NDI ON NDI.SAMPLE_CODE = NSI.SAMPLE_CODE
		         INNER JOIN (SELECT NSI.ID,
										     CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE
									    FROM NKY_SAMPLING_INFO NSI
									   INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
									   INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
									   WHERE NMP.PROJECT_CODE = #{projectCode}
									  ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID
				 INNER JOIN NKY_ORGANIZATION_INFO OI ON OI.CODE = T_COMPETENCE.COMPETENCE_CODE
		         INNER JOIN NKY_MONITORING_DECTION_TEMPLET MDT ON MDT.AGR_CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,NSI.AGR_CODE)
		                                                      AND MDT.POLL_CAS = NDI.CAS_CODE
		         WHERE MDT.PROJECT_CODE = #{projectCode}
		           AND OI.ID = #{orgCode}
		           <!-- 除去费样、除去已上报、且进行了实验室编码的 -->
		           AND NSI.SAMPLE_STATUS = '4'
		           AND UNSI.ID = NSI.ID)
	</update>
	
	<!-- 检测完成情况统计 ===================================================================-->
	<select id="getDetectionStatistical" resultType="com.hippo.nky.entity.detection.DetectionStatisticalEntity" parameterType="java.util.HashMap">
	SELECT * 
	FROM(
	  SELECT NOI2.OGRNAME AS dectectionOrgName,
	  		 NMT.TASKNAME AS taskName,
<!-- 	  		 COUNT(NSI.ID) AS taskCount,  -->
			 NMT.SAMPLING_COUNT AS taskCount,
	  		 SUM(DECODE(NSI.SAMPLE_STATUS,'5', 1, 0)) AS actualCount, 
	  		 TO_CHAR(NSI.DETECTION_REPORTING_DATE,'YYYY-MM-DD') AS reportingDate
			FROM NKY_SAMPLING_INFO NSI
			INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 			INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
			LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
           WHERE 1=1
           AND NSI.SAMPLE_STATUS <![CDATA[>=]]> 4
            <if test="qt != '' and qt != null">
<!--             	AND NSI.DETECTION_CODE = #{qt} -->
<!--           		AND NMO.ORG_CODE = #{qt} -->
            </if>
            <if test="pt != '' and pt != null">
            	AND NSI.DETECTION_CODE = #{pt}
<!--           		AND NMO.ORG_CODE = #{pt} -->
            </if>
	       AND NMP.PROJECT_CODE = #{projectCode} 
		   GROUP BY NSI.DETECTION_CODE,NSI.TASK_CODE,NOI2.OGRNAME,NMT.TASKNAME,NMT.SAMPLING_COUNT,TO_CHAR(NSI.DETECTION_REPORTING_DATE,'YYYY-MM-DD')
	       ORDER BY NSI.DETECTION_CODE,NSI.TASK_CODE
	 )
	 <if test="selCondtion != '' and selCondtion != null and selCondtion == 1">
	 WHERE actualCount = taskCount
	 </if>
	 <if test="selCondtion != '' and selCondtion != null and selCondtion == 2">
	 WHERE actualCount  <![CDATA[<]]> taskCount
	 </if>
	</select>
	
	<select id="getAgrStatistical" resultType="com.hippo.nky.entity.detection.DetectionStatisticalEntity" parameterType="java.util.HashMap">
	 SELECT 
	      AGR.CNAME AS agrName,
	      NOI2.OGRNAME dectectionOrgName,
	      NMT.TASKNAME AS taskName,
	      COUNT(NSI.ID) AS taskCount, 
	      SUM(DECODE(NSI.SAMPLE_STATUS,'5', 1, 0)) AS actualCount
	    FROM NKY_SAMPLING_INFO NSI
	    INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	    INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	    INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 	    INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
	    LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
	    LEFT JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
	    LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
	    INNER JOIN(
	           SELECT *
	           FROM
	           (
	             SELECT
	                dectectionOrgName,
	                taskName,
	                SUM(taskCount) AS TCOUNT,
	                SUM(actualCount) AS ACOUNT
	                FROM(
	                    SELECT 
	                        AGR.CNAME AS agrName,
	                        NOI2.OGRNAME dectectionOrgName,
	                        NMT.TASKNAME AS taskName,
	                        COUNT(NSI.ID) AS taskCount, 
	                        SUM(DECODE(NSI.SAMPLE_STATUS,'5', 1, 0)) AS actualCount
	                      FROM NKY_SAMPLING_INFO NSI
	                      INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	                      INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	                      LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
	                      INNER JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
	                      INNER JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
	                      WHERE NMP.PROJECT_CODE = #{projectCode} 
	                      GROUP BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE,AGR.CNAME, NOI2.OGRNAME,NMT.TASKNAME
	                      ORDER BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE
	                  )
	                  GROUP BY dectectionOrgName,taskName
	          )
	          <if test="selCondtion != '' and selCondtion != null and selCondtion == 1">
	          WHERE ACOUNT = TCOUNT
	          </if>
	         <if test="selCondtion != '' and selCondtion != null and selCondtion == 2">
	          WHERE ACOUNT <![CDATA[<]]> TCOUNT
	          </if>
	) T1 ON (T1.dectectionOrgName = NOI2.OGRNAME AND T1.taskName = NMT.TASKNAME)
	WHERE NMP.PROJECT_CODE = #{projectCode} 
	AND NSI.SAMPLE_STATUS <![CDATA[>=]]> 4
          <if test="qt != '' and qt != null">
          	AND NSI.DETECTION_CODE = #{qt}
<!--         		AND NMO.ORG_CODE = #{qt} -->
          </if>
          <if test="pt != '' and pt != null">
          	AND NSI.DETECTION_CODE = #{pt}
<!--         		AND NMO.ORG_CODE = #{pt} -->
  		 </if>
	GROUP BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE,AGR.CNAME, NOI2.OGRNAME,NMT.TASKNAME
	ORDER BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE
	</select>
	
	<!-- 取得表头中所能出现的农产品列表 -->
	<select id="getAgrTableHeader" resultType="java.lang.String" parameterType="java.util.HashMap">
          SELECT agrName 
			 FROM(
			 SELECT 
			      AGR.CODE AS agrCode,
			      AGR.CNAME AS agrName
			    FROM NKY_SAMPLING_INFO NSI
			    INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			    INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			    INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 	    		INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
			    INNER JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			    INNER JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
			    INNER JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
			    INNER JOIN(
			           SELECT *
			           FROM
			           (
			             SELECT
			                dectectionOrgName,
			                taskName,
			                SUM(taskCount) AS TCOUNT,
			                SUM(actualCount) AS ACOUNT
			                FROM(
			                    SELECT 
			                        AGR.CNAME AS agrName,
			                        NOI2.OGRNAME dectectionOrgName,
			                        NMT.TASKNAME AS taskName,
			                        COUNT(NSI.ID) AS taskCount, 
			                        SUM(DECODE(NSI.SAMPLE_STATUS,'5', 1, 0)) AS actualCount
			                      FROM NKY_SAMPLING_INFO NSI
			                      INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			                      INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			                      LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			                      INNER JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
			                      INNER JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = NSI.DETECTION_CODE
			                      WHERE NMP.PROJECT_CODE = #{projectCode}
			                      GROUP BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE,AGR.CNAME, NOI2.OGRNAME,NMT.TASKNAME
			                      ORDER BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE
			                  )
			                  GROUP BY dectectionOrgName,taskName
			          )
			          <if test="selCondtion != '' and selCondtion != null and selCondtion == 1">
	          			WHERE ACOUNT = TCOUNT
	          		  </if>
		         	  <if test="selCondtion != '' and selCondtion != null and selCondtion == 2">
		          	    WHERE ACOUNT <![CDATA[<]]> TCOUNT
		          	  </if>
			) T1 ON (T1.dectectionOrgName = NOI2.OGRNAME AND T1.taskName = NMT.TASKNAME)
			WHERE 1=1
			AND NSI.SAMPLE_STATUS <![CDATA[>=]]> 4
          <if test="qt != '' and qt != null">
          	AND NSI.DETECTION_CODE = #{qt}
<!--         		AND NMO.ORG_CODE = #{qt} -->
          </if>
          <if test="pt != '' and pt != null">
          	AND NSI.DETECTION_CODE = #{pt}
<!--         		AND NMO.ORG_CODE = #{pt} -->
  		 </if>
			GROUP BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE,AGR.CNAME, NOI2.OGRNAME,NMT.TASKNAME
			ORDER BY NSI.DETECTION_CODE,NSI.TASK_CODE, AGR.CODE
			)
			GROUP BY agrCode,agrName
			ORDER BY agrCode
	</select>
	<!-- ============================================================================= -->
	
	<resultMap type="java.util.HashMap" id="exportWordResult">
		<result column="DETECTION_VALUE" property="detectionValue"/> 
		<result column="POLL_NAME" property="pollName"/> 
		<result column="SYSTEM_UNIT" property="systemUnit"/>
		<result column="JUDGE_QUOTA" property="judgeQuota"/>
		<result column="JUDGE_VALUE" property="judgeValue"/>
		<result column="JUDGE_RESULT" property="judgeResult"/>
	</resultMap>
	<select id="getExportWordResult" resultMap="exportWordResult" parameterType="java.util.HashMap">
		SELECT DISTINCT NDI.ID,
		                NVL(VNMP.POPCNAME, '')                                AS POLL_NAME,
		                DICT.TYPENAME                                         AS SYSTEM_UNIT,
		                CASE
		                  WHEN VNMH.VALUE is null THEN
		                   ' '
		                  ELSE
		                   '≤' || TO_CHAR(VNMH.VALUE, 'FM9990.099999')
		                  END                                                 AS JUDGE_QUOTA,
	                    CASE
		                  WHEN VNMH.VALUE is null THEN
		                   ' '
		                  ELSE
		                   TO_CHAR(VNMH.VALUE, 'FM9990.099999')
		                  END                                                 AS JUDGE_VALUE,
		                CASE
		                  WHEN NDI.DETECTION_VALUE <![CDATA[<]]> 0 THEN
		                   '未检'
		                  WHEN NDI.DETECTION_VALUE = 0 THEN
		                   '未检出'
		                  ELSE
		                   TO_CHAR(NDI.DETECTION_VALUE, 'FM9990.099999')
		                END                                                   AS DETECTION_VALUE,
		                CASE
		                  WHEN NDI.DETECTION_VALUE <![CDATA[<]]> 0 THEN
		                   ''
		                  WHEN NDI.DETECTION_VALUE = 0 THEN
		                   '符合'
		                  ELSE
		                   CASE
		                  WHEN NDI.IS_OVERPROOF = '1' THEN
		                   '不符合'
		                  ELSE
		                   '符合'
		                END END                                           AS JUDGE_RESULT
		  FROM NKY_DETECTION_INFORMATION NDI
		 INNER JOIN NKY_SAMPLING_INFO NSI ON NSI.SAMPLE_CODE = NDI.SAMPLE_CODE
		 INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
		 INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
		  LEFT JOIN V_NKY_MONITORING_AGR VNMA ON VNMA.CODE = NSI.AGR_CODE AND VNMA.PROJECT_CODE = NMP.PROJECT_CODE
		  LEFT JOIN V_NKY_MONITORING_POLL VNMP ON VNMP.CAS = NDI.CAS_CODE AND VNMP.PROJECT_CODE = NMP.PROJECT_CODE
		  LEFT JOIN V_NKY_MONITORING_JUDGE VNMH ON VNMH.AGRID = VNMA.ID AND VNMH.POLLID = VNMP.ID AND VNMH.PROJECT_CODE = NMP.PROJECT_CODE
		  LEFT JOIN (SELECT TY.TYPECODE, TY.TYPENAME 
					   FROM T_S_TYPEGROUP TG,T_S_TYPE TY 
					  WHERE TG.TYPEGROUPCODE = 'unit' 
					    AND TG.ID = TY.TYPEGROUPID) DICT ON DICT.TYPECODE = VNMH.UNITS
		 WHERE NDI.SAMPLE_CODE = #{sampleCode}
		 <if test="projectCode != null and projectCode != ''">
		   AND NMP.PROJECT_CODE = #{projectCode}
		 </if>
	</select>
	
	<resultMap type="java.util.HashMap" id="sampleCollectInfoResult">
		<result column="ID" property="id"/>
		<result column="D_CODE" property="dCode"/>
		<result column="SAMPLE_CODE" property="sampleCode"/>
		<result column="TASKNAME" property="taskName"/>
		<result column="SP_CODE" property="spCode"/>
		<result column="CNAME" property="cName"/>
		<result column="UNIT_FULLNAME" property="unitFullname"/>
		<result column="MONITORING_LINK" property="monitoringLink"/>
		<result column="UNIT_ADDRESS" property="unitAddress"/>
		<result column="SAMPLE_AREA" property="sampleArea"/>
		<result column="SAMPLING_DATE" property="samplingDate"/>
		<result column="SAMPLING_OGRNAME" property="samplingOgrname"/>
		<result column="DETECTION_ORGNAME" property="detectionOgrname"/>
		<result column="INDUSTRY_CODE" property="industryCode"/>
		<result column="DETECT_POLL" property="detectPoll"/>
		<result column="RN" property="rn"/>
		<result column="IS_OVERPROOF" property="isOverproof"/>
	</resultMap>
	<select id="getSampleCollectInfo" resultMap="sampleCollectInfoResult" parameterType="java.util.HashMap">
		SELECT NSI.ID,
		       NSI.D_CODE,
		       NSI.SAMPLE_CODE,
		       NMT.TASKNAME,
		       NSI.SP_CODE,
		       AGR.CNAME,
		       NSI.UNIT_FULLNAME,
		       NSI.MONITORING_LINK,
		       NSI.UNIT_ADDRESS,
		       CITY_SYAC.AREANAME || COUNTRY_SYAC.AREANAME AS SAMPLE_AREA,
		       TO_CHAR(NSI.SAMPLING_DATE, 'YYYY-MM-DD') AS SAMPLING_DATE,
		       NOI1.OGRNAME AS SAMPLING_OGRNAME,
		       NOI2.OGRNAME AS DETECTION_ORGNAME,
		       NMP.INDUSTRY_CODE AS INDUSTRY_CODE,
		       SUBSTR(STR_SUM(VNMP.POPCNAME || '、'),0,LENGTH(STR_SUM(VNMP.POPCNAME || '、'))-1) AS DETECT_POLL,
		       DECODE(SUM(DECODE(NDI.IS_OVERPROOF, '0', 0, '1', 1)), 0, '0', '1') AS IS_OVERPROOF
		  FROM NKY_SAMPLING_INFO NSI
		  LEFT JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
		  LEFT JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
		  LEFT JOIN NkY_MONITORING_PLAN NMPL ON NMPL.PLAN_CODE = NMP.PLAN_CODE
		  LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON NMP.PROJECT_CODE = NMO.PROJECT_CODE
		  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
		  LEFT JOIN SYS_AREA_CODE CITY_SYAC ON NSI.CITY_CODE = CITY_SYAC.CODE
		  LEFT JOIN SYS_AREA_CODE COUNTRY_SYAC ON NSI.COUNTY_CODE = COUNTRY_SYAC.CODE
		 INNER JOIN (SELECT NSI.ID,
						    CASE WHEN NMP.DETACHED = '0' THEN NSI.SAMPLING_ORG_CODE ELSE NSI.DETECTION_CODE END AS COMPETENCE_CODE
					   FROM NKY_SAMPLING_INFO NSI
					  INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
					  INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
					  WHERE NMP.PROJECT_CODE = #{projectCode}
					  ) T_COMPETENCE ON T_COMPETENCE.ID = NSI.ID
		 INNER JOIN NKY_ORGANIZATION_INFO NOI1 ON NOI1.CODE = NSI.SAMPLING_ORG_CODE
		 INNER JOIN NKY_ORGANIZATION_INFO NOI2 ON NOI2.CODE = T_COMPETENCE.COMPETENCE_CODE
		 INNER JOIN NKY_DETECTION_INFORMATION NDI ON NDI.SAMPLE_CODE = NSI.SAMPLE_CODE
		 INNER JOIN V_NKY_MONITORING_POLL VNMP ON VNMP.CAS = NDI.CAS_CODE AND VNMP.PROJECT_CODE = NMP.PROJECT_CODE
		 WHERE 1 = 1
		   AND NSI.SAMPLE_STATUS = '5'
		<if test="projectCode != '' and projectCode != null ">
		   AND NMP.PROJECT_CODE = #{projectCode}
		</if>
		<if test="sampleId != '' and sampleId != null ">
		   AND NSI.ID = #{sampleId}
		</if>
		GROUP BY NSI.ID,NSI.D_CODE,NSI.SAMPLE_CODE, NMT.TASKNAME, NSI.SP_CODE,AGR.CNAME, NSI.UNIT_FULLNAME, NSI.MONITORING_LINK,NSI.UNIT_ADDRESS,CITY_SYAC.AREANAME,COUNTRY_SYAC.AREANAME,SAMPLING_DATE,
		         NOI1.OGRNAME,NOI2.OGRNAME,NMP.INDUSTRY_CODE
	</select>
	
	<!-- 验证实验室编码 -->
	<select id="checkLabCode" resultType="java.lang.Integer" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
		SELECT COUNT(NSI.LAB_CODE) AS TOTAL
		  FROM NKY_SAMPLING_INFO NSI
		  LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		 WHERE NSI.LAB_CODE = #{labCode}
		   AND NSI.DETECTION_CODE = #{orgCode}
		   AND NMT.PROJECT_CODE = #{projectCode}
		   AND NSI.ID != #{id}
	</select>
	
	<!-- 重置实验室编码 -->
	<update id="resetProjectLabCode" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
		UPDATE 
			NKY_SAMPLING_INFO NSI
		SET
			NSI.LAB_CODE = '',
			NSI.SAMPLE_STATUS = '3'
		WHERE
		 	NSI.TASK_CODE IN (
		 		SELECT TASK_CODE FROM NKY_MONITORING_TASK WHERE PROJECT_CODE = #{projectCode}
		 	) 
		 	AND NSI.DETECTION_CODE = #{orgCode}
		 	AND NSI.SAMPLE_STATUS = '4'
	</update>
	
	<!-- 取得未接收样品信息 -->
	<select id="getNotRecvSample" resultType="java.lang.String" parameterType="com.hippo.nky.entity.detection.DetectionEntity">
		SELECT 
			NSI.ID
		  FROM NKY_SAMPLING_INFO NSI
		  LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		  LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		 WHERE NSI.SAMPLE_STATUS = '3'
		   AND NSI.SAMPLING_ORG_CODE = #{orgCode}
		   AND NMT.PROJECT_CODE = #{projectCode}
	</select>
	
	
		
	<resultMap type="java.util.HashMap" id="detectionSetBackResult">
	    <result column="RN" property="rn"/>
		<result column="ID" property="id"/>    
		<result column="CODE" property="code"/>  
		<result column="STATUS" property="status"/>  
        <result column="CNAME" property="agrName"/>
        <result column="UNIT_FULLNAME" property="unitFullName"/>
        <result column="OGRNAME" property="ogrName"/>
    </resultMap>  
	<!-- 检测信息退回列表SIZE取得-->
	<select id="getDetectionSetBackCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT
			COUNT(1)
			FROM
			   NKY_DETECTION_SETBACK NDS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NDS.CODE = NSI.LAB_CODE and NDS.OGRCODE = NSI.DETECTION_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NDS.STATUS IN ('1','3')
			   AND NSI.DETECTION_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 4 -->
			<if test="labCode != '' and labCode != null">
			 	AND NSI.LAB_CODE LIKE '%' || #{labCode} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
	</select>
	<!-- 检测信息退回列表取得 -->
	<select id="getDetectionSetBack" resultMap="detectionSetBackResult" parameterType="java.util.HashMap">
	SELECT * FROM (
			SELECT
			   ROWNUM AS RN,
			   NDS.ID,
			   NDS.CODE,
			   NDS.STATUS,
			   AGR.CNAME
			FROM
			   NKY_DETECTION_SETBACK NDS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NDS.CODE = NSI.LAB_CODE and NDS.OGRCODE = NSI.DETECTION_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NDS.STATUS IN ('1','3')
			   AND NSI.DETECTION_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 4 -->
			<if test="labCode != '' and labCode != null">
			 	AND NSI.LAB_CODE LIKE '%' || #{labCode} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
		) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	
	<!-- 检测信息退回列表SIZE取得(审核已通过已退回)-->
	<select id="getDetectionSetBackCount2" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT
			COUNT(1)
			FROM
			   NKY_DETECTION_SETBACK NDS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NDS.CODE = NSI.LAB_CODE and NDS.OGRCODE = NSI.DETECTION_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NDS.STATUS = '2'
			   AND NSI.DETECTION_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 4 -->
			<if test="labCode != '' and labCode != null">
			 	AND NSI.LAB_CODE LIKE '%' || #{labCode} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			AND NMP.STATE = '1'
	</select>
	<!-- 检测信息退回列表取得 (审核已通过已退回)-->
	<select id="getDetectionSetBack2" resultMap="detectionSetBackResult" parameterType="java.util.HashMap">
	SELECT * FROM (
			SELECT
			   ROWNUM AS RN,
			   NDS.ID,
			   NDS.CODE,
			   NDS.STATUS,
			   AGR.CNAME
			FROM
			   NKY_DETECTION_SETBACK NDS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NDS.CODE = NSI.LAB_CODE and NDS.OGRCODE = NSI.DETECTION_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NDS.STATUS = '2'
			   AND NSI.DETECTION_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 4 -->
			<if test="labCode != '' and labCode != null">
			 	AND NSI.LAB_CODE LIKE '%' || #{labCode} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			AND NMP.STATE = '1'
		) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	
	<select id="getAddSetBackData" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		  SELECT NSI.ID,
		         NSI.SAMPLE_CODE,
		         NSI.LAB_CODE,
		         NSI.D_CODE,
		         NSI.SP_CODE,
		         AGR.CNAME
		    FROM NKY_SAMPLING_INFO NSI
		    LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		    LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
<!-- 		    LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON (NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
<!-- 		    LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NMO.ORG_CODE = NOI.CODE) -->
		    LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND NMP.PROJECT_CODE = AGR.PROJECT_CODE)
       	WHERE NSI.DETECTION_CODE = #{orgCode} 
       	<if test="labCode != '' and labCode != null">
       	 AND NSI.LAB_CODE = #{labCode} 
       	</if>
        <if test="dCode != '' and dCode != null">
       	 AND NSI.D_CODE = #{dCode} 
       	</if>
       	 AND NSI.SAMPLE_STATUS > 4
       	 AND NMP.STATE = '1'
	</select>
	
	<!-- 取得样品主要信息(退回时编辑样品信息用) -->
	<select id="getDetectionKeyInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
		    NSI.ID,
		    NMT.PROJECT_CODE,
		    NSI.AGR_CODE
		 FROM NKY_SAMPLING_INFO NSI
		 LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		 LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		 WHERE NSI.LAB_CODE = #{labCode}
		 AND NSI.DETECTION_CODE = #{ogrCode}
		 AND NMP.STATE = '1'
	</select>
	
  <resultMap type="java.util.HashMap" id="detectionSetBackCheckResult">
	    <result column="RN" property="rn"/>
		<result column="ID" property="id"/>    
		<result column="D_CODE" property="code"/>  
		<result column="STATUS" property="status"/>  
        <result column="NAME" property="projectName"/>  
        <result column="CNAME" property="agrName"/>
        <result column="UNIT_FULLNAME" property="unitFullName"/>
        <result column="SAMPLING_DATE" property="samplingDate"/>
        <result column="OGRNAME" property="ogrName"/>
    </resultMap>  
	<!-- 检测信息退回审核列表SIZE取得-->
	<select id="getDetectionSetBackCheckCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT
			   COUNT(1)
			FROM
			   NKY_DETECTION_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.LAB_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			   INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.DETECTION_CODE = NOI.CODE)
			WHERE
			   NSS.STATUS = '1'
			AND NMP.LEADUNIT = #{leadunit}
<!-- 			AND NSI.SAMPLE_STATUS > 4 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="ogrName != '' and ogrName != null">
			    AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
			</if>
	</select>
	<!-- 检测信息退回审核列表取得 -->
	<select id="getDetectionSetBackCheck" resultMap="detectionSetBackCheckResult" parameterType="java.util.HashMap">
	SELECT * FROM (
			SELECT
			   ROWNUM AS RN,
			   NSS.ID,
			   NSI.D_CODE,
			   NSS.STATUS,
			   NMP.NAME,
			   AGR.CNAME,
			   NSI.UNIT_FULLNAME,
			   TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
			   NOI.OGRNAME
			FROM
			   NKY_DETECTION_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.LAB_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			   INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.DETECTION_CODE = NOI.CODE)
			WHERE
			   NSS.STATUS = '1'
			   AND NMP.LEADUNIT = #{leadunit}
<!-- 			AND NSI.SAMPLE_STATUS > 4 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="ogrName != '' and ogrName != null">
			    AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
			</if>
			
		) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	
	<!-- 验证实验室编码前缀 -->
	<select id="selectInfoByLabPreAndDetectionCode" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT count(1)
		    FROM NKY_SAMPLING_INFO NSI
       	WHERE NSI.DETECTION_CODE = #{ogrCode} 
       	AND NSI.LAB_CODE like #{labPre} || '-%'
	</select>
	
	<!--实验室编码管理列表页面导出 -->
	<select id="getLabSampleForExport" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT ROWNUM AS RN,T.*
		FROM(
			SELECT
                     (CASE NMP.DETACHED
                        WHEN '1' THEN
                       		 NSI.SP_CODE
                        ELSE
                        	 NSI.D_CODE
                     	END) AS CODE,
                     AGR.CNAME,
                     NSI.LAB_CODE,
 					 NSI.UNIT_FULLNAME
            FROM NKY_SAMPLING_INFO NSI
            LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE =
                                                 NMT.TASK_CODE)
            LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE =
                                                    NMT.PROJECT_CODE)
<!--             LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON (NMP.PROJECT_CODE = -->
<!--                                                          NMO.PROJECT_CODE) -->
<!--             LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NMO.ORG_CODE = -->
<!--                                                    NOI.CODE) -->
            LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE =
                                                  NSI.AGR_CODE AND
                                                  AGR.PROJECT_CODE =
                                                  NMP.PROJECT_CODE)
        WHERE 1 = 1
        AND NMP.PROJECT_CODE = #{projectCode}
        AND NSI.SAMPLE_STATUS = '4'
		AND NSI.DETECTION_CODE = #{orgCode}
		 <!-- 样品名称 -->
         <if test=" sampleName != '' and sampleName != null ">
			 AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
		 </if>
		 <if test="labCode != '' and labCode != null ">
			 AND NSI.LAB_CODE LIKE '%' || #{labCode} || '%'
		 </if>				
         ORDER BY substr(NSI.LAB_CODE,1,inStr(NSI.LAB_CODE,'-',-1)-1),to_number(substr(NSI.LAB_CODE,inStr(NSI.LAB_CODE,'-',-1)+1))
         ) T
	</select>
	
	<!-- 取得样品主要信息(牵头单位修改检测信息取得样品信息) -->
	<select id="getTargetSampleInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
		    NSI.AGR_CODE AS AGRCODE,
		    NSI.LAB_CODE AS LABCODE,
		    NSI.D_CODE AS DCODE,
		    NSI.SAMPLE_CODE AS SAMPLECODE,
		    NOI.ID AS OGRID
		 FROM
		   NKY_SAMPLING_INFO NSI
		   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
		   LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.DETECTION_CODE = NOI.CODE)
		 WHERE 1=1
		 AND NMT.PROJECT_CODE = #{projectCode}
		 <if test=" spCode != '' and spCode != null">
		   AND NSI.SP_CODE = #{spCode}
		 </if>
		 <if test=" labCode != '' and labCode != null">
		   AND NSI.LAB_CODE = #{labCode}
		 </if>
		 <if test=" dCode != '' and dCode != null">
		   AND NSI.D_CODE = #{dCode}
		 </if>
	</select>
	
	<resultMap type="java.util.HashMap" id="monitoringDectionListMap">
		<result column="SAMPLE_CODE" property="sampleCode" />
		<result column="CNAME" property="cname" />
		<result column="TYPENAME" property="typeName" />
		<result column="CITYNAME" property="cityName" />
		<result column="COUNTYNAME" property="countyName" />
		<result column="UNIT_ADDRESS" property="unitAddress" />
		<result column="UNIT_FULLNAME" property="unitFullName" />
		<result column="DETERESULT" property="deteResult" />
		<result column="SAMPLING_ADDRESS" property="samplingAddress"/>
	</resultMap>
	
	<select id="selectMonitoringDectionListCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		SELECT count(distinct NSI.SAMPLE_CODE)
  		FROM NKY_SAMPLING_INFO NSI,
       		 NKY_MONITORING_PROJECT MONPROJECT,
       		 NKY_MONITORING_TASK NMP,
       		 (SELECT TY.TYPECODE, TY.TYPENAME
          		 FROM T_S_TYPEGROUP TG, T_S_TYPE TY
         		 WHERE TG.TYPEGROUPCODE = 'allmonLink'
           		 AND TG.ID = TY.TYPEGROUPID) LINKTYPE,
       		 SYS_AREA_CODE CITY,
       		 SYS_AREA_CODE COUNTY,
       		 NKY_AGR_CATEGORY AGR,
       		 NKY_STANDARD_VERSION JUDGEVERSION
		WHERE 
			<!-- 检测信息已上报 -->
		  NSI.SAMPLE_STATUS = '5'
		  	<if test="projectCode != '' and projectCode != null ">
				AND MONPROJECT.PROJECT_CODE = #{projectCode}
          	</if>
			<if test="qt != '' and qt != null ">
				AND NMP.LEADUNIT = #{qt}
          	</if>
          	<if test="pt != '' and pt != null ">
          		AND NSI.SAMPLING_ORG_CODE = #{pt}
          	</if>
		  AND NSI.TASK_CODE = NMP.TASK_CODE
		  AND MONPROJECT.PROJECT_CODE = NMP.PROJECT_CODE
		  AND LINKTYPE.TYPECODE = NSI.MONITORING_LINK
		  AND CITY.CODE = NSI.CITY_CODE
		  AND COUNTY.CODE = NSI.COUNTY_CODE
		  AND AGR.CODE = NSI.AGR_CODE
		  AND AGR.VERSIONID = JUDGEVERSION.AGR_VERSION_ID
		  AND JUDGEVERSION.ID = MONPROJECT.JUDGE_VERSION_ID
	</select>
	
	<select id="selectMonitoringDectionListWithCount" parameterType="java.util.HashMap" resultMap="monitoringDectionListMap">
	SELECT *
  FROM (SELECT T.*, ROWNUM AS RN
          FROM (SELECT NSI.SAMPLE_CODE,
                       NVL(AGR.CALIAS, AGR.CNAME) AS CNAME,
                       LINKTYPE.TYPENAME,
                       CITY.AREANAME AS CITYNAME,
                       COUNTY.AREANAME AS COUNTYNAME,
                       NSI.UNIT_ADDRESS,
                       NSI.UNIT_FULLNAME,
                       NSI.SAMPLING_ADDRESS,
                       WM_CONCAT(DETEINFO.CAS_CODE || '#EM#' ||
                                 DETEINFO.DETECTION_VALUE || '#EM#' ||
                                 DETEINFO.IS_OVERPROOF) AS DETERESULT
                  FROM NKY_SAMPLING_INFO NSI,
                       NKY_DETECTION_INFORMATION DETEINFO,
                       NKY_MONITORING_PROJECT MONPROJECT,
                       NKY_MONITORING_TASK NMP,
                       (SELECT TY.TYPECODE, TY.TYPENAME
                          FROM T_S_TYPEGROUP TG, T_S_TYPE TY
                         WHERE TG.TYPEGROUPCODE = 'allmonLink'
                           AND TG.ID = TY.TYPEGROUPID) LINKTYPE,
                       SYS_AREA_CODE CITY,
                       SYS_AREA_CODE COUNTY,
                       NKY_AGR_CATEGORY AGR,
                       NKY_STANDARD_VERSION JUDGEVERSION
                 WHERE NSI.SAMPLE_STATUS = '5'
                   <if test="projectCode != '' and projectCode != null ">
						AND MONPROJECT.PROJECT_CODE = #{projectCode}
				   </if>
				   <if test="qt != '' and qt != null ">
						AND NMP.LEADUNIT = #{qt}
				   </if>
				   <if test="pt != '' and pt != null ">
						AND NSI.SAMPLING_ORG_CODE = #{pt}
				   </if>
                   AND NSI.SAMPLE_CODE = DETEINFO.SAMPLE_CODE
                   AND NSI.TASK_CODE = NMP.TASK_CODE
                   AND MONPROJECT.PROJECT_CODE = NMP.PROJECT_CODE
                   AND LINKTYPE.TYPECODE = NSI.MONITORING_LINK
                   AND CITY.CODE = NSI.CITY_CODE
                   AND COUNTY.CODE = NSI.COUNTY_CODE
                   AND AGR.CODE = NSI.AGR_CODE
                   AND AGR.VERSIONID = JUDGEVERSION.AGR_VERSION_ID
                   AND JUDGEVERSION.ID = MONPROJECT.JUDGE_VERSION_ID
                 GROUP BY NSI.SAMPLE_CODE,
                          NVL(AGR.CALIAS, AGR.CNAME),
                          LINKTYPE.TYPENAME,
                          CITY.AREANAME,
                          COUNTY.AREANAME,
                          NSI.UNIT_ADDRESS,
                          NSI.UNIT_FULLNAME,
                          NSI.SAMPLING_ADDRESS) T)
 				WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]> #{endIndex} 
	</select>
</mapper>