<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hippo.nky.entity.report.PlantSituationEntity">
	<resultMap type="java.util.HashMap" id="plantResult">
        <result column="NAME" property="projectName"/>
        <result column="PROJECT_CODE" property="projectCode"/>
        <result column="INDUSTRY_CODE" property="industryCode"/>
        <result column="PLEVEL" property="projectLevel"/>
        <result column="orgCode" property="orgCode"/>
        <result column="YEAR" property="year"/>
        <result column="RN" property="rn"/>
        <result column="CODE" property="code"/>
        <result column="AREANAME" property="areaname"/>
        <result column="TOTALSUM" property="totalSum"/>
        <result column="ISQUALSUM" property="isQualSum"/>
        <result column="PCTSUM" property="pctSum"/>
        <result column="TYPECODE" property="typecode"/>
        <result column="TYPENAME" property="typename"/>
        <result column="OVERSUM" property="overSum"/>
        <result column="OVERPCT" property="overPct"/>
        <result column="CLSNO" property="clsNo"/>
        <result column="PUBLISH_DATE" property="publishDate"/>
    </resultMap>
    
	<!--管理单位下  监测地区及数量 (区县)-->	
	<select id="getAreaCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*) FROM (
			SELECT DISTINCT NVL2(NSI.COUNTY_CODE,NSI.COUNTY_CODE,NSI.CITY_CODE) AS CODE 
	        FROM NKY_SAMPLING_INFO NSI
	        LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	        LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			<where>
				AND NSI.SAMPLE_STATUS != 2
				AND SUBSTR(NSI.COUNTY_CODE,5) != '01'
				AND NMT.PROJECT_CODE IN
		         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				 </foreach> 
				<if test="pt != '' and pt != null ">
					AND NSI.DETECTION_CODE = #{pt}
				</if>
			</where>
		)
	</select>
	
	<!--管理单位下  监测地区及数量(市辖区) -->	
	<select id="getAreaCount1" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*) FROM (
			SELECT DISTINCT NVL2(NSI.COUNTY_CODE,NSI.COUNTY_CODE,NSI.CITY_CODE) AS CODE 
	        FROM NKY_SAMPLING_INFO NSI
	        LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	        LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			<where>
				AND NSI.SAMPLE_STATUS != 2
				AND SUBSTR(NSI.COUNTY_CODE,5) = '01'
				AND NMT.PROJECT_CODE IN
		         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				 </foreach> 
				<if test="pt != '' and pt != null ">
					AND NSI.DETECTION_CODE = #{pt}
				</if>
			</where>
		)
	</select>
	<!--管理单位下  农产品数量 -->
	<select id="getArgCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*) FROM (
			SELECT DISTINCT NSI.AGR_CODE
				FROM NKY_SAMPLING_INFO NSI
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			<where>
				AND NSI.SAMPLE_STATUS != 2
				AND NMT.PROJECT_CODE IN
		         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				 </foreach> 
				<if test="pt != '' and pt != null ">
					AND NSI.DETECTION_CODE = #{pt}
				</if>
			</where>
		)
	</select>
	
	<!--管理单位下  样品数量 全部数量/合格数量  -->
	<select id="getSampleCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		 SELECT COUNT(NSI.ID)
				FROM NKY_SAMPLING_INFO NSI
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		<where>
			AND NSI.SAMPLE_STATUS != 2
			AND NMT.PROJECT_CODE IN
		         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				 </foreach> 
	    	<if test="isQualified != '' and isQualified != null ">
				AND NSI.IS_QUALIFIED = #{isQualified}
			</if>
			<if test="pt != '' and pt != null ">
				AND NSI.DETECTION_CODE = #{pt}
			</if>
		</where>
	</select>
	
	<!--管理单位下  样品数量 全部数量/合格数量 (区县) -->
	<select id="getSampleCount1" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		 SELECT COUNT(NSI.ID)
				FROM NKY_SAMPLING_INFO NSI
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		<where>
			AND NSI.SAMPLE_STATUS != 2
			AND SUBSTR(NSI.COUNTY_CODE,5) != '01'
			AND NMT.PROJECT_CODE IN
		         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				 </foreach> 
	    	<if test="isQualified != '' and isQualified != null ">
				AND NSI.IS_QUALIFIED = #{isQualified}
			</if>
			<if test="pt != '' and pt != null ">
				AND NSI.DETECTION_CODE = #{pt}
			</if>
		</where>
	</select>
	
	<!--管理单位下 污染物数量 -->
	<select id="getPollCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*) FROM (
			SELECT DISTINCT NMDT.POLL_CAS FROM NKY_MONITORING_DECTION_TEMPLET NMDT
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMDT.PROJECT_CODE = NMP.PROJECT_CODE)
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
        		LEFT JOIN NKY_SAMPLING_INFO NSI ON (NSI.TASK_CODE = NMT.TASK_CODE)
			<where>
				1 = 1
				AND NMT.PROJECT_CODE IN
		         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				 </foreach> 
				<if test="pt != '' and pt != null ">
					AND NSI.DETECTION_CODE = #{pt}
				</if>
			</where>
		)
	</select>

	<select id="getProjectCodeForDepartment" resultMap="plantResult" parameterType="java.util.HashMap">
		SELECT 
			NMP.PROJECT_CODE,
			NMP.NAME || '  (' || to_char(NMP.PUBLISH_DATE,'yyyyMMdd') || ')' AS NAME
		    FROM NKY_MONITORING_PROJECT NMP 
		    INNER JOIN NKY_MONITORING_PLAN NMPL ON (NMP.PLAN_CODE = NMPL.PLAN_CODE)
			INNER JOIN T_S_DEPART TSD ON (NMPL.RELEASEUNIT = TSD.ID)
		<where>
			1=1
			 AND (
		   	(NMPL.RELEASEUNIT = #{orgId} AND (NMP.STATE = '1' OR NMP.STATE = '2'))
		   	<if test="gl_g != '' and gl_g != null and gl_g == 1" >
			    OR (TSD.GRADE = '2' AND substr(TSD.CODE,1,3) = substr(#{gl_code1},1,3) AND NMP.STATE = '3') 
			    OR (TSD.GRADE = '3' AND NMP.STATE = '3'
			    	AND EXISTS(
			    		select *
			    		from NKY_MONITORING_PROJECT nmp1
			    		inner join NKY_MONITORING_PLAN nmpl1 on (nmp1.PLAN_CODE = nmpl1.PLAN_CODE)
			    		inner join T_S_DEPART tsd1 on (nmpl1.RELEASEUNIT = tsd1.ID)
			    		where tsd1.grade = '2'
			    		and substr(tsd1.CODE,1,3) = substr(#{gl_code1},1,3) AND nmp1.STATE = '3'
			    		and tsd1.CODE = TSD.CODE
			    	)
			    )
			</if>
			<if test="gl_g != '' and gl_g != null and gl_g == 2" >
			    OR (TSD.GRADE = '3' AND substr(TSD.AREACODE2,1,4) = substr(#{gl_code2},1,4) AND NMP.STATE = '3') 
			</if>
		    )
			<if test="industryCode != null and industryCode != '' ">
			AND NMP.INDUSTRY_CODE = #{industryCode}
			</if>
			AND NMPL.TYPE = #{type}
	      	<if test="year != null and year != '' ">
				AND TO_CHAR(NMP.STARTTIME,'YYYY') = #{year}
			</if>
	    	<if test="projectLevel != null and projectLevel != '' ">
				AND NMPL.PLEVEL = #{projectLevel}
			</if>
			ORDER BY NMP.PUBLISH_DATE DESC NULLS LAST 
		</where>
	</select>

	<select id="getProjectCode" resultMap="plantResult" parameterType="java.util.HashMap">
		SELECT 
			   distinct(NMP.PROJECT_CODE),
			   NMP.NAME || '  (' || to_char(NMP.PUBLISH_DATE,'yyyyMMdd') || ')' AS NAME,
			   NMP.PUBLISH_DATE
			FROM NKY_MONITORING_PROJECT NMP 
			LEFT JOIN NKY_MONITORING_PLAN NMPL ON (NMP.PLAN_CODE = NMPL.PLAN_CODE)
			<if test="orgCode != null and orgCode != '' ">
			INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON (NMP.PROJECT_CODE = NMO.PROJECT_CODE)
			INNER JOIN NKY_ORGANIZATION_INFO NOI ON (NMO.ORG_CODE = NOI.CODE)
			</if> 
		<where>
			1=1
			AND (NMP.STATE = '1' OR NMP.STATE = '2' OR NMP.STATE = '3')
			AND NMPL.TYPE = #{type}
			<if test="industryCode != null and industryCode != '' ">
			AND	NMP.INDUSTRY_CODE = #{industryCode}
			</if>
	      	<if test="year != null and year != '' ">
				AND TO_CHAR(NMP.STARTTIME,'YYYY') = #{year}
			</if>
	    	<if test="projectLevel != null and projectLevel != '' ">
				AND NMPL.PLEVEL = #{projectLevel}
			</if>
			<if test="orgCode != null and orgCode != '' ">
				AND (NOI.CODE = #{orgCode} OR NMP.LEADUNIT = #{orgCode})
			</if>
			ORDER BY NMP.PUBLISH_DATE DESC NULLS LAST 
		</where>
	</select>
	
	<!-- chenyingqin↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓-->
	<!-- 例行监测  不同蔬菜来源超标情况统计表-->
	<select id="getVegetablesMonitoringLinkOverStanderd" resultType="com.hippo.nky.entity.report.VegetablesSituationEntity" parameterType="java.util.HashMap">
	SELECT
	  monitoringLink,
	  unitCount,
	  samplingCount,
	  overStanderdCount,
	  100*ROUND(overStanderdCount/samplingCount,3)||'%' AS overStanderdRate,
	  detetionCount
	FROM(
	  SELECT
	      T.MONITORING_LINKK AS monitoringLink,
	      COUNT(1) AS unitCount,
	      SUM(T.spCount) AS samplingCount,
	      SUM(T.overStanderdCount) AS overStanderdCount,
	      SUM(T.detetionCount) AS detetionCount
	      FROM
	      (
	      SELECT
<!-- 	           NSI.MONITORING_LINK AS MONITORING_LINKK, -->
	           TST.TYPENAME AS MONITORING_LINKK,
	           NSI.UNIT_FULLNAME,
	           count(1) AS spCount,
	           SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount,
	           SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount
	           FROM NKY_SAMPLING_INFO NSI
	           LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	           LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	           LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
	           LEFT JOIN T_S_TYPE TST ON (TST.TYPECODE =  NSI.MONITORING_LINK)
		       LEFT JOIN T_S_TYPEGROUP TSTG ON (TSTG.ID = TST.TYPEGROUPID)  
	           LEFT JOIN (
	               SELECT
	                    NDI.SAMPLE_CODE,
	                    SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount,
	                    SUM(
						  CASE
							 WHEN NDI.DETECTION_VALUE > 0 THEN 1
							 ELSE 0
						  END
						  ) AS detetionCount
	               FROM 
	               NKY_DETECTION_INFORMATION NDI
	               GROUP BY NDI.SAMPLE_CODE
	           ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
	        WHERE 1=1 
	        AND NMP.PROJECT_CODE IN
	         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     	#{item}
			 </foreach>  
<!-- 	        NMP.PROJECT_CODE = #{projectCode} -->
            <if test="pt != '' and pt != null">
            	AND NSI.DETECTION_CODE = #{pt}
            </if>
	        AND TSTG.TYPEGROUPCODE = 'allmonLink'
	        AND NSI.SAMPLE_STATUS != '2'
	        GROUP BY TST.TYPENAME,NSI.UNIT_FULLNAME
	       ) T
	       GROUP BY T.MONITORING_LINKK
	   )
	</select>
	<select id="getVegetablesMonitoringLinkOverStanderdForExport" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	SELECT
	  monitoringLink AS monitoringLink,
	  TO_CHAR(unitCount) AS unitCount,
	  TO_CHAR(samplingCount) AS samplingCount,
	  TO_CHAR(overStanderdCount) AS overStanderdCount,
	  100*ROUND(overStanderdCount/samplingCount,3)||'%' AS overStanderdRate,
	  TO_CHAR(detetionCount) AS detetionCount
	FROM(
	  SELECT
	      T.MONITORING_LINKK AS monitoringLink,
	      COUNT(1) AS unitCount,
	      SUM(T.spCount) AS samplingCount,
	      SUM(T.overStanderdCount) AS overStanderdCount,
	      SUM(T.detetionCount) AS detetionCount
	      FROM
	      (
	      SELECT
<!-- 	           NSI.MONITORING_LINK AS MONITORING_LINKK, -->
	           TST.TYPENAME AS MONITORING_LINKK,
	           NSI.UNIT_FULLNAME,
	           count(1) AS spCount,
	           SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount,
	           SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount
	           FROM NKY_SAMPLING_INFO NSI
	           LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	           LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	           LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
	           LEFT JOIN T_S_TYPE TST ON (TST.TYPECODE =  NSI.MONITORING_LINK)
		       LEFT JOIN T_S_TYPEGROUP TSTG ON (TSTG.ID = TST.TYPEGROUPID)  
	           LEFT JOIN (
	               SELECT
	                    NDI.SAMPLE_CODE,
	                    SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount,
	                    SUM(
						  CASE
							 WHEN NDI.DETECTION_VALUE > 0 THEN 1
							 ELSE 0
						  END
						  ) AS detetionCount
	               FROM 
	               NKY_DETECTION_INFORMATION NDI
	               GROUP BY NDI.SAMPLE_CODE
	           ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
	       	WHERE 1=1 
   			AND NMP.PROJECT_CODE IN
	         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     	#{item}
			 </foreach>  
	        <if test="pt != '' and pt != null">
            	AND NSI.DETECTION_CODE = #{pt}
            </if>
	        AND TSTG.TYPEGROUPCODE = 'allmonLink'
	        AND NSI.SAMPLE_STATUS != '2'
	        GROUP BY TST.TYPENAME,NSI.UNIT_FULLNAME
	       ) T
	       GROUP BY T.MONITORING_LINKK
	   )
	</select>
	<!-- 例行监测  不同蔬菜类别超标情况统计表  -->
	<select id="getVegetablesCategoryOverStanderd" resultType="com.hippo.nky.entity.report.VegetablesSituationEntity" parameterType="java.util.HashMap">
	 SELECT 
         AGR.CNAME AS category,
         T1.samplingCount,
         t1.detetionCount,
         t1.overStanderdCount,
         100*ROUND(t1.overStanderdCount/t1.samplingCount,3)||'%' AS overStanderdRate
    FROM V_NKY_MONITORING_AGR AGR
    INNER JOIN(
       SELECT
          COUNT(1) AS samplingCount,
          SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount,
          AGR.PID,
          AGR.PROJECT_CODE,
          SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount
       FROM NKY_SAMPLING_INFO NSI
       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
       INNER JOIN (
             SELECT
                  NDI.SAMPLE_CODE,
                  SUM(
                  CASE
                     WHEN NDI.DETECTION_VALUE > 0 THEN 1
                     ELSE 0
                  END
                  ) AS detetionCount,
                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
             FROM 
             NKY_DETECTION_INFORMATION NDI
             GROUP BY NDI.SAMPLE_CODE
       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)  
       WHERE NMP.PROJECT_CODE IN
       	<foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>  
   	    <if test="pt != '' and pt != null">
        	AND NSI.DETECTION_CODE = #{pt}
        </if>
       AND AGR.PID != '0'
       AND NSI.SAMPLE_STATUS != '2'
       GROUP BY AGR.PID,AGR.PROJECT_CODE
     ) T1 ON (T1.PID = AGR.ID AND T1.PROJECT_CODE = AGR.PROJECT_CODE)
     </select>
     
    <select id="getVegetablesCategoryOverStanderdForExport" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	 SELECT 
         AGR.CNAME AS category,
         TO_CHAR(T1.samplingCount) AS samplingCount,
         TO_CHAR(t1.detetionCount) AS detetionCount,
         TO_CHAR(t1.overStanderdCount) AS overStanderdCount,
         100*ROUND(t1.overStanderdCount/t1.samplingCount,3)||'%' AS overStanderdRate
    FROM V_NKY_MONITORING_AGR AGR
    INNER JOIN(
       SELECT
          COUNT(1) AS samplingCount,
          SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount,
          AGR.PID,
          AGR.PROJECT_CODE,
          SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount
       FROM NKY_SAMPLING_INFO NSI
       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
       INNER JOIN (
             SELECT
                  NDI.SAMPLE_CODE,
                   SUM(
                  CASE
                     WHEN NDI.DETECTION_VALUE > 0 THEN 1
                     ELSE 0
                  END
                  ) AS detetionCount,
                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
             FROM 
             NKY_DETECTION_INFORMATION NDI
             GROUP BY NDI.SAMPLE_CODE
       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)  
       WHERE NMP.PROJECT_CODE IN
        <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
	     	#{item}
		</foreach> 
       <if test="pt != '' and pt != null">
          AND NSI.DETECTION_CODE = #{pt}
       </if>
       AND AGR.PID != '0'
       AND NSI.SAMPLE_STATUS != '2'
       GROUP BY AGR.PID,AGR.PROJECT_CODE
     ) T1 ON (T1.PID = AGR.ID AND T1.PROJECT_CODE = AGR.PROJECT_CODE)
	</select>
	
	<!-- 例行监测  不同蔬菜品种超标情况统计表 -->
	<select id="getVegetablesVarietyOverStanderd" resultType="com.hippo.nky.entity.report.VegetablesSituationEntity" parameterType="java.util.HashMap">
	SELECT
	  agrName,
	  samplingCount,
	  detetionCount,
	  overStanderdCount,
	  100*ROUND(overStanderdCount/samplingCount,3)||'%' AS overStanderdRate,
	  100*ROUND(detetionCount/samplingCount,3)||'%' AS detetionRate
	FROM
	(
       SELECT
          AGR.CNAME AS agrName,
          COUNT(1) AS samplingCount,
          SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount,
          SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount
       FROM NKY_SAMPLING_INFO NSI
       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
       INNER JOIN (
             SELECT
                  NDI.SAMPLE_CODE,
                   SUM(
                  CASE
                     WHEN NDI.DETECTION_VALUE > 0 THEN 1
                     ELSE 0
                  END
                  ) AS detetionCount,
                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
             FROM 
             NKY_DETECTION_INFORMATION NDI
             GROUP BY NDI.SAMPLE_CODE
       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)  
       WHERE NMP.PROJECT_CODE IN
       	<foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			 #{item}
	    </foreach>  
       <if test="pt != '' and pt != null">
          AND NSI.DETECTION_CODE = #{pt}
       </if>
       AND NSI.SAMPLE_STATUS != '2'
       GROUP BY AGR.CNAME
	 )
	</select>
	
	<select id="getVegetablesVarietyOverStanderdForExport" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	SELECT
	  agrName,
	  TO_CHAR(samplingCount) AS samplingCount,
	  TO_CHAR(detetionCount) AS detetionCount,
	  TO_CHAR(overStanderdCount) AS overStanderdCount,
	  100*ROUND(overStanderdCount/samplingCount,3)||'%' AS overStanderdRate,
	  100*ROUND(detetionCount/samplingCount,3)||'%' AS detetionRate
	FROM
	(
       SELECT
          AGR.CNAME AS agrName,
          COUNT(1) AS samplingCount,
          SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount,
          SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount
       FROM NKY_SAMPLING_INFO NSI
       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
       INNER JOIN (
             SELECT
                  NDI.SAMPLE_CODE,
                   SUM(
                  CASE
                     WHEN NDI.DETECTION_VALUE > 0 THEN 1
                     ELSE 0
                  END
                  ) AS detetionCount,
                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
             FROM 
             NKY_DETECTION_INFORMATION NDI
             GROUP BY NDI.SAMPLE_CODE
       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)  
       WHERE NMP.PROJECT_CODE IN
        <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			 #{item}
	    </foreach>  
       <if test="pt != '' and pt != null">
          AND NSI.DETECTION_CODE = #{pt}
       </if>
       AND NSI.SAMPLE_STATUS != '2'
       GROUP BY AGR.CNAME
	 )
	</select>
	
	<!-- 各省辖市批发市场超标情况表(详表) -->	
	<select id="getProvincialCitiesOverStandardDetail" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	select 
		cityArea,
		samplingCount,
		overStanderdCount,
		overStanderdRate,
		qualifiedRate,
		rank,
		detetionCount,
		detetionRate,
		con3DetetionCount,
		con3DetetionRate 
	from (
	  SELECT
	    cityArea,
	    show_order AS show_order,
	    TO_CHAR(samplingCount) AS samplingCount,
	    TO_CHAR(overStanderdCount) AS overStanderdCount,
	    ' ' AS overStanderdRate,
	    ' ' AS qualifiedRate,
	    RANK() OVER(ORDER BY overStanderdCount/samplingCount asc) AS rank,
	    TO_CHAR(detetionCount) AS detetionCount,
	    ' ' AS detetionRate,
	    TO_CHAR(con3DetetionCount) AS con3DetetionCount,
	    ' ' AS con3DetetionRate
	  FROM
		 (
       SELECT
          AREA.AREANAME AS cityArea,
          AREA.SHOW_ORDER AS show_order,
          COUNT(1) AS samplingCount,
          SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount,
          SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount, 
          SUM(
              CASE
                 WHEN T2.detetionCount >= 3 THEN 1
                 ELSE 0
              END
           ) AS con3DetetionCount     
       FROM NKY_SAMPLING_INFO NSI
       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
      LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
       LEFT JOIN SYS_AREA_CODE AREA ON NSI.CITY_CODE = AREA.CODE
       INNER JOIN (
             SELECT
                  NDI.SAMPLE_CODE,
                  SUM(
                    CASE
                       WHEN NDI.DETECTION_VALUE > 0 THEN 1
                       ELSE 0
                    END
                    ) AS detetionCount,
                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
             FROM 
             NKY_DETECTION_INFORMATION NDI
             GROUP BY NDI.SAMPLE_CODE
       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
       WHERE NMP.PROJECT_CODE IN
        <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			 #{item}
	    </foreach>  
       AND SUBSTR(NSI.COUNTY_CODE,5) = '01'
       <if test="pt != '' and pt != null">
          AND NSI.DETECTION_CODE = #{pt}
       </if>
       AND NSI.SAMPLE_STATUS != '2'
       GROUP BY AREA.AREANAME,AREA.SHOW_ORDER
  	 )	
  	 )order by show_order,rank
  	 		
	</select>
	
	<!-- 各区县超标情况表（详情） -->	
	<select id="getCountiesOverStandardDetail" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	select 
		countyArea,
		samplingCount,
		overStanderdCount,
		overStanderdRate,
		qualifiedRate,
		rank,
		detetionCount,
		detetionRate,
		con3DetetionCount,
		con3DetetionRate
		from(
	  SELECT
	    countyArea,
	    show_order AS show_order,
	    TO_CHAR(samplingCount) AS samplingCount,
	    TO_CHAR(overStanderdCount) AS overStanderdCount,
	    ' ' AS overStanderdRate,
	    ' ' AS qualifiedRate,
	    RANK() OVER(ORDER BY overStanderdCount/samplingCount asc) AS rank,
	    TO_CHAR(detetionCount) AS detetionCount,
	    ' ' AS detetionRate,
	    TO_CHAR(con3DetetionCount) AS con3DetetionCount,
	    ' ' AS con3DetetionRate
	  FROM
		 (
       SELECT
          AREA.AREANAME AS countyArea,
          AREA.SHOW_ORDER AS show_order,
          COUNT(1) AS samplingCount,
          SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount,
          SUM(DECODE(T2.detetionCount,0,0,'',0,1)) AS detetionCount, 
          SUM(
              CASE
                 WHEN T2.detetionCount >= 3 THEN 1
                 ELSE 0
              END
           ) AS con3DetetionCount     
       FROM NKY_SAMPLING_INFO NSI
       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
       LEFT JOIN SYS_AREA_CODE AREA ON NSI.COUNTY_CODE = AREA.CODE
       INNER JOIN (
             SELECT
                  NDI.SAMPLE_CODE,
                  SUM(
                    CASE
                       WHEN NDI.DETECTION_VALUE > 0 THEN 1
                       ELSE 0
                    END
                    ) AS detetionCount,
                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
             FROM 
             NKY_DETECTION_INFORMATION NDI
             GROUP BY NDI.SAMPLE_CODE
       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
       WHERE NMP.PROJECT_CODE IN
      	<foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
		    #{item}
		</foreach>  
      <if test="pt != '' and pt != null">
          AND NSI.DETECTION_CODE = #{pt}
       </if>
       AND SUBSTR(NSI.COUNTY_CODE,5) != '01'
       AND NSI.SAMPLE_STATUS != '2'
       GROUP BY AREA.AREANAME,AREA.SHOW_ORDER
<!--        ORDER BY AREA.SHOW_ORDER -->
  	 )
  	 )order by show_order,rank	
  	 	
	</select>
	<!-- chenyingqin↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑ -->
	
	<select id="getOverProofSampleInfoCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(VNSI.D_CODE)
		  FROM NKY_SAMPLING_INFO VNSI
		 INNER JOIN NKY_MONITORING_TASK NMT ON NMT.TASK_CODE = VNSI.TASK_CODE
		 INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
		 INNER JOIN NKY_MONITORING_PLAN NMPL ON NMPL.PLAN_CODE = NMP.PLAN_CODE
		 INNER JOIN (SELECT NSI.ID AS ID,
		                    STR_SUM(NPD.POPCNAME || ':' ||
		                            to_char(NDI.DETECTION_VALUE, 'FM9990.099999') || ',') AS POLL_VALUE
		               FROM NKY_SAMPLING_INFO NSI
		              INNER JOIN NKY_DETECTION_INFORMATION NDI ON NDI.SAMPLE_CODE = NSI.SAMPLE_CODE
		               LEFT JOIN NKY_POLL_DICTIONARY NPD ON NPD.CAS = NDI.CAS_CODE
		              WHERE NDI.IS_OVERPROOF = '1'
		              GROUP BY NSI.ID) POLL ON POLL.ID = VNSI.ID
		  LEFT JOIN NKY_ORGANIZATION_INFO NOI ON NOI.CODE = VNSI.DETECTION_CODE
		  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = VNSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
		 WHERE VNSI.SAMPLE_STATUS != '2'
		   AND NMP.PROJECT_CODE IN
		     <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     #{item}
			 </foreach>  
		   <!-- 权限 -->
		   <if test="pt != '' and pt != null">
		   AND VNSI.DETECTION_CODE = #{pt}
		   </if>
	</select>
	
	<select id="getOverProofSampleInfo" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	SELECT ROWNUM AS RN
		   ,SAMPLE_AREA_NAME
		   ,D_CODE
		   ,SP_CODE
		   ,UNIT_FULLNAME
		   ,CNAME
		   ,MONITORING_LINK
		   ,POLL_VALUE
		   ,OGRNAME
	  FROM
	  (
		SELECT 
			   CITY_SYAC.AREANAME || COUNTRY_SYAC.AREANAME             AS SAMPLE_AREA_NAME
	           ,VNSI.D_CODE                                            AS D_CODE
	           ,NVL(VNSI.SP_CODE,' ')                                           AS SP_CODE
	           ,VNSI.UNIT_FULLNAME                                     AS UNIT_FULLNAME
	           ,AGR.CNAME                                              AS CNAME
	           ,VNSI.MONITORING_LINK                                   AS MONITORING_LINK
	           ,SUBSTR(POLL.POLL_VALUE,1,LENGTH(POLL.POLL_VALUE)-1)    AS POLL_VALUE
	           ,NOI.OGRNAME                                            AS OGRNAME
		  FROM NKY_SAMPLING_INFO VNSI
		 INNER JOIN NKY_MONITORING_TASK NMT ON NMT.TASK_CODE = VNSI.TASK_CODE
		 INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
		 INNER JOIN NKY_MONITORING_PLAN NMPL ON NMPL.PLAN_CODE = NMP.PLAN_CODE
		 INNER JOIN (SELECT NSI.ID AS ID,
		                    STR_SUM(NPD.POPCNAME || ':' ||
		                            to_char(NDI.DETECTION_VALUE, 'FM9990.099999') || ',') AS POLL_VALUE
		               FROM NKY_SAMPLING_INFO NSI
		              INNER JOIN NKY_DETECTION_INFORMATION NDI ON NDI.SAMPLE_CODE = NSI.SAMPLE_CODE
		               LEFT JOIN NKY_POLL_DICTIONARY NPD ON NPD.CAS = NDI.CAS_CODE
		              WHERE NDI.IS_OVERPROOF = '1'
		              GROUP BY NSI.ID) POLL ON POLL.ID = VNSI.ID
		  LEFT JOIN NKY_ORGANIZATION_INFO NOI ON NOI.CODE = VNSI.DETECTION_CODE
		  LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = VNSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
		  LEFT JOIN SYS_AREA_CODE CITY_SYAC ON VNSI.CITY_CODE = CITY_SYAC.CODE
		  LEFT JOIN SYS_AREA_CODE COUNTRY_SYAC ON VNSI.COUNTY_CODE = COUNTRY_SYAC.CODE
		 WHERE VNSI.SAMPLE_STATUS != '2'
		   <!-- 项目code -->
		   AND NMP.PROJECT_CODE IN
		   	 <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     #{item}
			 </foreach> 
		   <!-- 权限 -->
		   <if test="pt != '' and pt != null">
		   AND VNSI.DETECTION_CODE = #{pt}
		   </if>
		   ORDER BY CITY_SYAC.SHOW_ORDER,COUNTRY_SYAC.SHOW_ORDER
	)
	</select>
	
<!-- 	<select id="getSjzlLstForCounty" resultMap="plantResult" parameterType="java.util.HashMap"> -->
<!-- 		SELECT distinct t.typecode,t.typename FROM V_NKY_county_SAMPLE vnns -->
<!-- 			INNER JOIN t_s_type t ON (t.typecode = vnns.monitoring_link) -->
<!-- 			LEFT JOIN t_s_typegroup tp ON (tp.id = t.typegroupid)  -->
<!-- 		<where> -->
<!-- 			vnns.code NOT LIKE '____01' -->
<!-- 	   		<if test="industryCode != '' and industryCode != null "> -->
<!-- 				AND vnns.INDUSTRY_CODE = #{industryCode}  -->
<!-- 			</if> -->
<!-- 			AND vnns.PROJECT_CODE = #{projectCode} -->
<!-- 			and tp.typegroupcode = 'allmonLink' -->
<!-- 			ORDER BY t.typecode,t.typename -->
<!-- 		</where> -->
<!-- 	</select> -->
	
<!-- 	<select id="getSampleOverProof" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap"> -->
<!-- 			SELECT * -->
<!-- 				  FROM (SELECT T.CODE, T.AREANAME, T2.TOTALSUM, T2.ISQUALSUM, T2.PCTSUM -->
<!-- 				          FROM (SELECT S_AREA.CODE, S_AREA.AREANAME -->
<!-- 				                  FROM SYS_AREA_CODE S_AREA -->
<!-- 				                 WHERE 1 = 1 -->
<!-- 				                   AND S_AREA.CODE NOT LIKE '____01' -->
<!-- 				                   AND S_AREA.CODE NOT LIKE '____00' -->
<!-- 				                 AND s_area.code LIKE #{areaCode} || '%' -->
<!-- 				                 GROUP BY S_AREA.CODE, S_AREA.AREANAME -->
<!-- 				                 ORDER BY S_AREA.CODE) T -->
<!-- 				          INNER JOIN ( -->
<!-- 							SELECT DECODE(VNCS.CODE, NULL, '汇总', VNCS.CODE) AS CODE, -->
<!-- 	                           SUM(VNCS.TOTALCOUNT) AS TOTALSUM, -->
<!-- 	                           NVL(SUM(NSI2.ISQUAL),0) AS ISQUALSUM, -->
<!-- 	                           100*ROUND(NVL(SUM(NSI2.ISQUAL),0)/NVL(SUM(VNCS.TOTALCOUNT),0),3) AS PCTSUM -->
<!-- 	                      	FROM V_NKY_COUNTY_SAMPLE VNCS -->
<!-- 	                      	LEFT JOIN (  -->
<!-- 	                           SELECT VNCS2.CODE,COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_COUNTY_SAMPLE VNCS2   -->
<!-- 									WHERE VNCS2.CODE IS NOT NULL -->
<!-- 			                 			<if test="industryCode != '' and industryCode != null "> -->
<!-- 											AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 										</if> -->
<!-- 										<if test="pt != '' and pt != null "> -->
<!-- 											AND VNCS2.DETECTION_CODE = #{pt} -->
<!-- 										</if>  -->
<!-- 										AND VNCS2.IS_QUALIFIED = 0  -->
<!-- 	                          			AND vncs2.sample_status = 5 -->
<!-- 	                          			AND VNCS2.PROJECT_CODE = #{projectCode} -->
<!-- 	                           GROUP BY vncs2.code -->
<!-- 	                      ) NSI2 ON(NSI2.code = vncs.code) -->
<!-- 		                     WHERE 1 = 1 -->
<!-- 		                       	AND VNCS.CODE NOT LIKE '____01' -->
<!--       							<if test="industryCode != '' and industryCode != null "> -->
<!-- 									AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 								</if> -->
<!-- 								<if test="pt != '' and pt != null "> -->
<!-- 									and vncs.detection_code = #{pt} -->
<!-- 								</if> -->
<!-- 								AND vncs.sample_status = 5 -->
<!-- 			      				AND VNCS.PROJECT_CODE = #{projectCode} -->
<!-- 		                     AND vncs.code LIKE #{areaCode} || '%' -->
<!-- 		                     GROUP BY VNCS.CODE) T2 ON (T2.CODE = T.CODE) -->
<!-- 				         ORDER BY T.CODE) T -->
<!-- 				UNION ALL -->
<!-- 				SELECT TT.CODE, '' AS AREANAME, TT.TOTALSUM, TT.ISQUALSUM, TT.PCTSUM -->
<!-- 				  FROM (SELECT DECODE(VNCS.CODE, NULL, '汇总', VNCS.CODE) AS CODE, -->
<!-- 				               SUM(VNCS.TOTALCOUNT) AS TOTALSUM, -->
<!-- 				                NVL(SUM(NSI2.ISQUAL),0) AS ISQUALSUM, -->
<!--                					100*ROUND(NVL(SUM(NSI2.ISQUAL),0)/NVL(SUM(VNCS.TOTALCOUNT),0),3) AS PCTSUM -->
<!-- 							FROM V_NKY_COUNTY_SAMPLE VNCS -->
<!--            					LEFT JOIN (  -->
<!--                            		SELECT VNCS2.CODE,COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_COUNTY_SAMPLE VNCS2   -->
<!--                            			WHERE VNCS2.CODE IS NOT NULL  -->
<!--                           			AND VNCS2.IS_QUALIFIED = 0  -->
<!--                           			<if test="industryCode != '' and industryCode != null "> -->
<!-- 										AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 									</if> -->
<!-- 									<if test="pt != '' and pt != null "> -->
<!-- 										AND VNCS2.DETECTION_CODE = #{pt} -->
<!-- 									</if> -->
<!--                           			AND VNCS2.SAMPLE_STATUS = 5 -->
<!--                           			AND VNCS2.PROJECT_CODE = #{projectCode} -->
<!--                            		GROUP BY VNCS2.CODE -->
<!--                       		) NSI2 ON(NSI2.CODE = VNCS.CODE) -->
                      
<!-- 				         WHERE 1 = 1 -->
<!-- 				           	AND VNCS.CODE NOT LIKE '____01' -->
<!-- 		      			    <if test="industryCode != '' and industryCode != null "> -->
<!-- 								AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 							</if> -->
<!-- 							<if test="pt != '' and pt != null "> -->
<!-- 								and vncs.detection_code = #{pt} -->
<!-- 							</if> -->
<!-- 							AND vncs.sample_status = 5 -->
<!-- 					      	AND VNCS.PROJECT_CODE = #{projectCode} -->
<!-- 				         AND vncs.code LIKE #{areaCode} || '%' -->
<!-- 				         GROUP BY ROLLUP(VNCS.CODE)) TT -->
<!-- 				 WHERE TT.CODE = '汇总' -->
<!-- 	</select> -->
	
	<select id="getSampleOverProof" resultType="com.hippo.nky.entity.report.SampleOverProofEntity" parameterType="java.util.HashMap">
		 SELECT
		    countyArea,
		    TO_CHAR(samplingCount) AS samplingCount,
		    TO_CHAR(qualifiedCount) AS qualifiedCount
		  FROM
			 (
	       SELECT
	          AREA.AREANAME AS countyArea,
	          COUNT(1) AS samplingCount,
	          SUM(DECODE(T2.overStanderdCount,0,1,'',1,0)) AS qualifiedCount 
	       FROM NKY_SAMPLING_INFO NSI
	       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
	       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
	       LEFT JOIN SYS_AREA_CODE AREA ON NSI.COUNTY_CODE = AREA.CODE
	       INNER JOIN (
	             SELECT
	                  NDI.SAMPLE_CODE,
	                  SUM(
	                    CASE
	                       WHEN NDI.DETECTION_VALUE > 0 THEN 1
	                       ELSE 0
	                    END
	                    ) AS detetionCount,
	                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
	             FROM 
	             NKY_DETECTION_INFORMATION NDI
	             GROUP BY NDI.SAMPLE_CODE
	       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
	       WHERE 1=1 
	       AND NMP.PROJECT_CODE IN
	         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     	#{item}
			 </foreach>  
	      <if test="pt != '' and pt != null">
	          AND NSI.DETECTION_CODE = #{pt}
	       </if>
	       AND SUBSTR(NSI.COUNTY_CODE,5) != '01'
	       AND NSI.SAMPLE_STATUS != '2'
	       GROUP BY AREA.AREANAME,AREA.SHOW_ORDER
<!-- 	       ORDER BY AREA.AREANAME -->
 		   ORDER BY AREA.SHOW_ORDER
	  	 )			
	</select>
	
    <select id="getSjzlLstForCounty" resultType="java.lang.String" parameterType="java.util.HashMap">
		SELECT distinct t.typename FROM V_NKY_county_SAMPLE vnns
			INNER JOIN t_s_type t ON (t.typecode = vnns.monitoring_link)
			LEFT JOIN t_s_typegroup tp ON (tp.id = t.typegroupid) 
		<where>
			vnns.code NOT LIKE '____01'
	   		<if test="industryCode != '' and industryCode != null ">
				AND vnns.INDUSTRY_CODE = #{industryCode} 
			</if>
		   <if test="pt != '' and pt != null">
	          AND vnns.DETECTION_CODE = #{pt}
	       </if>
			AND vnns.PROJECT_CODE IN
	         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     	#{item}
			 </foreach>  
			and tp.typegroupcode = 'allmonLink'
			ORDER BY t.typename
		</where>
	</select>
	
	<select id="getSampleOverProofRight" resultType="com.hippo.nky.entity.report.SampleOverProofEntity" parameterType="java.util.HashMap">
	SELECT
       AREA.AREANAME AS countyArea,
       TST.TYPENAME AS monitoringLink,
       COUNT(1) AS samplingCount,
       SUM(DECODE(T2.overStanderdCount,0,1,'',1,0)) AS qualifiedCount 
         FROM NKY_SAMPLING_INFO NSI
         LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
         LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
         LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
         LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
         LEFT JOIN SYS_AREA_CODE AREA ON NSI.COUNTY_CODE = AREA.CODE
         LEFT JOIN T_S_TYPE TST ON (TST.TYPECODE =  NSI.MONITORING_LINK)
         LEFT JOIN T_S_TYPEGROUP TSTG ON (TSTG.ID = TST.TYPEGROUPID)  
         INNER JOIN (
               SELECT
                    NDI.SAMPLE_CODE,
                    SUM(
                      CASE
                         WHEN NDI.DETECTION_VALUE > 0 THEN 1
                         ELSE 0
                      END
                      ) AS detetionCount,
                    SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
               FROM 
               NKY_DETECTION_INFORMATION NDI
               GROUP BY NDI.SAMPLE_CODE
         ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
         where SUBSTR(NSI.COUNTY_CODE,5) != '01'
        <if test="pt != '' and pt != null">
	        AND NSI.DETECTION_CODE = #{pt}
	     </if>
         AND NMP.PROJECT_CODE IN
	         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     	#{item}
			 </foreach>  
         AND TSTG.TYPEGROUPCODE = 'allmonLink'
         AND NSI.SAMPLE_STATUS != '2'
         GROUP BY AREA.AREANAME,AREA.SHOW_ORDER,TST.TYPENAME
<!--          order by AREA.AREANAME,TST.TYPENAME -->
         order by AREA.SHOW_ORDER,TST.TYPENAME
	</select>
	
<!-- 	<select id="getSampleOverProofRight" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap"> -->
<!-- 		SELECT * -->
<!-- 		  FROM (SELECT T.CODE, -->
<!-- 		               T.AREANAME, -->
<!-- 		               T2.TYPENAME, -->
<!-- 		               T2.TOTALSUM, -->
<!-- 		               T2.ISQUALSUM, -->
<!-- 		               T2.PCTSUM -->
<!-- 		          FROM (SELECT S_AREA.CODE, S_AREA.AREANAME -->
<!-- 		                  FROM SYS_AREA_CODE S_AREA -->
<!-- 		                 WHERE 1 = 1 -->
<!-- 		                   AND S_AREA.CODE NOT LIKE '____01' -->
<!-- 		                   AND S_AREA.CODE NOT LIKE '____00' -->
<!-- 		                 AND s_area.code LIKE #{areaCode} || '%' -->
<!-- 		                 GROUP BY S_AREA.CODE, S_AREA.AREANAME -->
<!-- 		                 ORDER BY S_AREA.CODE) T -->
<!-- 		          inner JOIN (SELECT VNCS.CODE, -->
<!-- 		                       T.TYPENAME, -->
<!-- 		                       NVL(SUM(VNCS.TOTALCOUNT),0) AS TOTALSUM, -->
<!-- 		                       NVL(SUM(NSI2.ISQUAL),0) AS ISQUALSUM, -->
<!-- 	                           100*ROUND(NVL(SUM(NSI2.ISQUAL),0)/NVL(SUM(VNCS.TOTALCOUNT),0),3) AS PCTSUM -->
<!-- 	                      	FROM V_NKY_COUNTY_SAMPLE VNCS -->
<!-- 	                      	LEFT JOIN (  -->
<!-- 	                           SELECT VNCS2.CODE,COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_COUNTY_SAMPLE VNCS2   -->
<!-- 									WHERE VNCS2.CODE IS NOT NULL  -->
<!-- 										AND VNCS2.IS_QUALIFIED = 0  -->
<!-- 										<if test="industryCode != '' and industryCode != null "> -->
<!-- 											AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 										</if> -->
<!-- 										<if test="pt != '' and pt != null "> -->
<!-- 											and vncs2.detection_code = #{pt} -->
<!-- 										</if> -->
<!-- 										AND VNCS2.monitoring_link = #{monitoringLink} -->
<!-- 	                          			AND VNCS2.PROJECT_CODE = #{projectCode} -->
<!-- 	                          			AND vncs2.sample_status = 5 -->
<!-- 	                           GROUP BY vncs2.code -->
<!-- 	                      ) NSI2 ON(NSI2.code = vncs.code) -->
<!-- 		                      LEFT JOIN T_S_TYPE T ON (T.TYPECODE = VNCS.MONITORING_LINK) -->
<!-- 		                      LEFT JOIN T_S_TYPEGROUP TP ON (TP.ID = T.TYPEGROUPID) -->
<!-- 		                     WHERE 1 = 1 -->
<!-- 		                       	AND VNCS.CODE NOT LIKE '____01' -->
<!-- 		                       	AND VNCS.monitoring_link = #{monitoringLink} -->
<!-- 		                       	AND TP.TYPEGROUPCODE = 'allmonLink' -->
<!-- 			      			    <if test="industryCode != '' and industryCode != null "> -->
<!-- 									AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 								</if> -->
<!-- 								<if test="pt != '' and pt != null "> -->
<!-- 									and vncs.detection_code = #{pt} -->
<!-- 								</if> -->
<!-- 								AND vncs.sample_status = 5 -->
<!-- 								AND VNCS.PROJECT_CODE = #{projectCode}  -->
<!-- 		                        AND VNCS.code LIKE #{areaCode} || '%' -->
<!-- 		                     GROUP BY VNCS.CODE, T.TYPENAME) T2 ON (T.CODE = T2.CODE) -->
<!-- 		         ORDER BY T.CODE) -->
<!-- 			UNION ALL -->
<!-- 			SELECT T3.CODE, -->
<!-- 			       T3.AREANAME, -->
<!-- 			       T3.TYPENAME, -->
<!-- 			       T3.TOTALSUM, -->
<!-- 			       T3.ISQUALSUM, -->
<!-- 			       T3.PCTSUM -->
<!-- 			  FROM (SELECT DECODE(VNCS.CODE, NULL, '', VNCS.CODE) AS CODE, -->
<!-- 			               '' AS AREANAME, -->
<!-- 			               '' AS TYPENAME, -->
<!-- 			               NVL(SUM(VNCS.TOTALCOUNT),0) AS TOTALSUM, -->
<!-- 	                       NVL(SUM(NSI2.ISQUAL),0) AS ISQUALSUM, -->
<!--                            100*ROUND(NVL(SUM(NSI2.ISQUAL),0)/NVL(SUM(VNCS.TOTALCOUNT),0),3) AS PCTSUM -->
<!--                       	FROM V_NKY_COUNTY_SAMPLE VNCS -->
<!--                       	LEFT JOIN (  -->
<!--                            SELECT VNCS2.CODE,COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_COUNTY_SAMPLE VNCS2   -->
<!-- 								WHERE VNCS2.CODE IS NOT NULL  -->
<!-- 									AND VNCS2.IS_QUALIFIED = 0  -->
<!-- 									<if test="industryCode != '' and industryCode != null "> -->
<!-- 										AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 									</if> -->
<!-- 									<if test="pt != '' and pt != null "> -->
<!-- 										and vncs2.detection_code = #{pt} -->
<!-- 									</if> -->
<!-- 									AND VNCS2.monitoring_link = #{monitoringLink} -->
<!--                           			AND VNCS2.PROJECT_CODE = #{projectCode} -->
<!--                           			AND vncs2.sample_status = 5 -->
<!--                            GROUP BY vncs2.code -->
<!--                       ) NSI2 ON(NSI2.code = vncs.code) -->
<!-- 			          LEFT JOIN T_S_TYPE T ON (T.TYPECODE = VNCS.MONITORING_LINK) -->
<!-- 			          LEFT JOIN T_S_TYPEGROUP TP ON (TP.ID = T.TYPEGROUPID) -->
<!-- 			         WHERE 1 = 1 -->
<!-- 			           	AND VNCS.CODE NOT LIKE '____01' -->
<!-- 			           	AND VNCS.monitoring_link = #{monitoringLink} -->
<!-- 			           	AND TP.TYPEGROUPCODE = 'allmonLink' -->
<!--      					<if test="industryCode != '' and industryCode != null "> -->
<!-- 							AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 						</if> -->
<!-- 						<if test="pt != '' and pt != null "> -->
<!-- 							and vncs.detection_code = #{pt} -->
<!-- 						</if> -->
<!-- 						AND vncs.sample_status = 5 -->
<!-- 						AND VNCS.PROJECT_CODE = #{projectCode} -->
<!-- 			         AND VNCS.code LIKE #{areaCode} || '%' -->
<!-- 			         GROUP BY ROLLUP(VNCS.CODE) -->
<!-- 			        ) T3 -->
<!-- 			 WHERE T3.CODE IS NULL -->
<!-- 	</select> -->

	<select id="getSuperMarketOverProof" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
			 SELECT *
				  FROM (SELECT T.CODE,
				               T.AREANAME,
				               T2.TOTALSUM,
				               T2.ISQUALSUM,
				               T2.PCTSUM,
				               T2.OVERSUM,
				               T2.OVERPCT,
				               T2.CLSNO
				          FROM (SELECT S_AREA.CODE, S_AREA.AREANAME
				                  FROM SYS_AREA_CODE S_AREA
				                 WHERE S_AREA.CODE LIKE '____01'
				                   AND S_AREA.CODE NOT LIKE '____00'
				                   <!-- AND S_AREA.CODE = #{areaCode} 预留-->
				                 GROUP BY S_AREA.CODE, S_AREA.AREANAME,S_AREA.SHOW_ORDER
				                 ORDER BY S_AREA.SHOW_ORDER) T
				          INNER JOIN (
							  SELECT VNCS.CODE,
		                           SUM(VNCS.TOTALCOUNT) AS TOTALSUM,
		                           NVL(NSI2.ISQUAL, 0) AS ISQUALSUM,
		                           NVL((CASE WHEN NSI2.ISQUAL = 0 THEN 0 WHEN NSI2.ISQUAL != 0 THEN 100 * ROUND((NSI2.ISQUAL / SUM(VNCS.TOTALCOUNT)), 3) END),0) AS PCTSUM,
		                           SUM(NVL2(T.OVERCOUNT, 1, 0)) AS OVERSUM,
		                           100 * ROUND((SUM(NVL2(T.OVERCOUNT, 1, 0)) / SUM(VNCS.TOTALCOUNT)), 3) AS OVERPCT,
		                           RANK() OVER(ORDER BY 100 * ROUND((SUM(NVL2(T.OVERCOUNT, 1, 0)) / SUM(VNCS.TOTALCOUNT)), 3) DESC) AS CLSNO
		                      FROM V_NKY_COUNTY_SAMPLE VNCS
		                      LEFT JOIN ( 
		                           SELECT vncs2.code,count(vncs2.sample_code) AS isQual FROM V_NKY_COUNTY_SAMPLE vncs2  
		                           WHERE vncs2.code IS NOT NULL 
		                           AND vncs2.sample_status != '2'
		                           AND vncs2.IS_QUALIFIED = 0
	                   			   <if test="industryCode != '' and industryCode != null ">
										AND VNCS2.INDUSTRY_CODE = #{industryCode} 
								   </if>
								   <if test="pt != '' and pt != null ">
										AND VNCS2.DETECTION_CODE = #{pt}
								   </if>  
		                           AND  VNCS2.PROJECT_CODE IN
		                           <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
									     #{item}
									</foreach>   
		                           GROUP BY vncs2.code
		                       )NSI2 ON(NSI2.CODE = VNCS.CODE)
				               LEFT JOIN (SELECT NDI.SAMPLE_CODE, COUNT(NDI.CAS_CODE) AS OVERCOUNT FROM NKY_DETECTION_INFORMATION NDI WHERE NDI.IS_OVERPROOF = 1 GROUP BY NDI.SAMPLE_CODE) 
				               T ON (VNCS.SAMPLE_CODE = T.SAMPLE_CODE)
				               WHERE 1 = 1
				               		AND VNCS.CODE LIKE '____01'
									AND vncs.sample_status != '2'
	                			   	<if test="industryCode != '' and industryCode != null ">
										AND VNCS.INDUSTRY_CODE = #{industryCode} 
								   	</if>
								   	<if test="pt != '' and pt != null ">
										AND VNCS.DETECTION_CODE = #{pt}
								   	</if>
					      			AND VNCS.PROJECT_CODE IN
					      			<foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
									     #{item}
									</foreach>   
				                    <!-- AND VNCS.CODE = #{areaCode} 预留-->
				                    GROUP BY VNCS.CODE,NSI2.ISQUAL
				               ) T2 ON (T2.CODE = T.CODE)
				         ORDER BY T.CODE)
			UNION ALL
			SELECT TT.CODE,
			       '' AS AREANAME,
			       TT.TOTALSUM,
			       TT.ISQUALSUM,
			       TT.PCTSUM,
			       TT.OVERSUM,
			       TT.OVERPCT,
			       NULL AS CLSNO
			  FROM (
			        SELECT DECODE(VNCS.CODE, NULL, '汇总', VNCS.CODE) AS CODE,
			               SUM(VNCS.TOTALCOUNT) AS TOTALSUM,
			               NVL(NSI2.ISQUAL, 0) AS ISQUALSUM,
                           NVL((CASE WHEN NSI2.ISQUAL = 0 THEN 0 WHEN NSI2.ISQUAL != 0 THEN 100 * ROUND((NSI2.ISQUAL / SUM(VNCS.TOTALCOUNT)), 3) END),0) AS PCTSUM,
			               SUM(NVL2(T.OVERCOUNT, 1, 0)) AS OVERSUM,
			               100 * ROUND((SUM(NVL2(T.OVERCOUNT, 1, 0)) / SUM(VNCS.TOTALCOUNT)),3) AS OVERPCT
			        
			          FROM V_NKY_COUNTY_SAMPLE VNCS
			          LEFT JOIN ( 
		                           SELECT VNCS2.CODE,COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_COUNTY_SAMPLE VNCS2  
		                           WHERE VNCS2.CODE IS NOT NULL 
		                           AND vncs2.sample_status = 5
		                           AND VNCS2.IS_QUALIFIED = 0
	                   			   <if test="industryCode != '' and industryCode != null ">
										AND VNCS2.INDUSTRY_CODE = #{industryCode} 
								   </if>
								   <if test="pt != '' and pt != null ">
										AND VNCS2.DETECTION_CODE = #{pt}
								   </if>  
		                           AND  VNCS2.PROJECT_CODE IN
		                           <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
									     #{item}
									</foreach>   
		                           GROUP BY VNCS2.CODE
		                       )NSI2 ON(NSI2.code = vncs.code)
			          LEFT JOIN (SELECT NDI.SAMPLE_CODE, COUNT(NDI.CAS_CODE) AS OVERCOUNT
			                       FROM NKY_DETECTION_INFORMATION NDI
			                      WHERE NDI.IS_OVERPROOF = 1
			                      GROUP BY NDI.SAMPLE_CODE) T ON (VNCS.SAMPLE_CODE = T.SAMPLE_CODE)
			         WHERE 1 = 1
							AND VNCS.CODE LIKE '____01'
							AND vncs.sample_status = 5
	           			   <if test="industryCode != '' and industryCode != null ">
								AND VNCS.INDUSTRY_CODE = #{industryCode} 
						   </if>
						   <if test="pt != '' and pt != null ">
								AND VNCS.DETECTION_CODE = #{pt}
						   </if>
		      				AND VNCS.PROJECT_CODE IN
      					    <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
							     #{item}
							</foreach>    
			           		<!-- AND VNCS.CODE = #{areaCode} 预留-->
			         GROUP BY ROLLUP(VNCS.CODE),NSI2.ISQUAL
			        ) TT
			 WHERE TT.CODE = '汇总'
	</select>
	
	<select id="getParentCityName" resultType="java.lang.String" parameterType="java.util.HashMap">
		SELECT t.areaname FROM SYS_AREA_CODE t WHERE t.id = (SELECT area.parentareaid FROM SYS_AREA_CODE area WHERE area.code = #{areaCode})
	</select>
	
<!-- 	<select id="getCitySampleOverProof" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap"> -->
<!-- 		SELECT * FROM ( -->
<!--         SELECT t.code,t.areaname,t2.totalSum,t2.isQualSum,t2.pctSum  FROM( -->
<!--                  SELECT substr(s_area.code,1,4) AS code,s_area.areaname FROM SYS_AREA_CODE s_area -->
<!--                     WHERE 1=1 -->
<!--                         AND s_area.code LIKE '____00'  -->
<!--                         AND s_area.code != '320000' -->
<!--                         AND substr(s_area.code,1,4) = #{areaCode} -->
<!--                      GROUP BY s_area.code,s_area.areaname -->
<!--                      ORDER BY s_area.code  -->
<!--               ) t -->
<!--               INNER JOIN             -->
<!--               (SELECT VNCS.CODE,SUM(VNCS.TOTALCOUNT) AS TOTALSUM,NVL(NSI2.ISQUAL, 0) AS ISQUALSUM, -->
<!--                     NVL((CASE WHEN NSI2.ISQUAL = 0 THEN 0 WHEN NSI2.ISQUAL != 0 THEN 100 * ROUND((NSI2.ISQUAL / SUM(VNCS.TOTALCOUNT)), 3) END), 0) AS PCTSUM -->
<!--                     FROM V_NKY_city_SAMPLE VNCS -->
<!--                     LEFT JOIN (SELECT VNCS2.CODE, COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_CITY_SAMPLE VNCS2 -->
<!-- 		                WHERE VNCS2.SAMPLE_STATUS = 5 AND VNCS2.IS_QUALIFIED = 0 -->
<!-- 						<if test="industryCode != '' and industryCode != null "> -->
<!-- 							AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 					   </if> -->
<!-- 					   <if test="pt != '' and pt != null "> -->
<!-- 							AND VNCS2.DETECTION_CODE = #{pt} -->
<!-- 					   </if> -->
<!--                       AND VNCS2.PROJECT_CODE = #{projectCode} -->
<!--                     GROUP BY VNCS2.CODE) NSI2 ON (NSI2.CODE = VNCS.CODE) -->
<!--                     WHERE 1=1 -->
<!--                    		AND vncs.sample_status = 5 -->
<!--            			   <if test="industryCode != '' and industryCode != null "> -->
<!-- 							AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 					   </if> -->
<!-- 					   <if test="pt != '' and pt != null "> -->
<!-- 							AND VNCS.DETECTION_CODE = #{pt} -->
<!-- 					   </if> -->
<!-- 						AND VNCS.PROJECT_CODE = #{projectCode} -->
<!--                       	AND VNCS.CODE = #{areaCode} 预留 -->
<!--                     GROUP BY VNCS.CODE, NSI2.ISQUAL -->
<!--                     ORDER BY VNCS.CODE -->
<!--         ) t2 ON (t2.code = t.code )  -->
<!-- 		) t3   -->
<!-- 		UNION ALL  -->
<!--         SELECT T4.CODE, -->
<!--                    '' AS AREANAME, -->
<!--                    T4.TOTALSUM, -->
<!--                    T4.ISQUALSUM, -->
<!--                    T4.PCTSUM -->
<!--               FROM ( -->
<!--               SELECT DECODE(VNCS.CODE,NULL,'汇总',VNCS.CODE) AS CODE,SUM(VNCS.TOTALCOUNT) AS TOTALSUM,NVL(NSI2.ISQUAL, 0) AS ISQUALSUM, -->
<!--                     NVL((CASE WHEN NSI2.ISQUAL = 0 THEN 0 WHEN NSI2.ISQUAL != 0 THEN 100 * ROUND((NSI2.ISQUAL / SUM(VNCS.TOTALCOUNT)), 3) END), 0) AS PCTSUM -->
<!--                     FROM  V_NKY_CITY_SAMPLE VNCS -->
<!--                     LEFT JOIN (SELECT VNCS2.CODE, COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_CITY_SAMPLE VNCS2 -->
<!-- 		                WHERE VNCS2.SAMPLE_STATUS = 5 AND VNCS2.IS_QUALIFIED = 0 -->
<!-- 						<if test="industryCode != '' and industryCode != null "> -->
<!-- 							AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 					   </if> -->
<!-- 					   <if test="pt != '' and pt != null "> -->
<!-- 							AND VNCS2.DETECTION_CODE = #{pt} -->
<!-- 					   </if> -->
<!--                       AND VNCS2.PROJECT_CODE = #{projectCode} -->
<!--                     GROUP BY VNCS2.CODE) NSI2 ON (NSI2.CODE = VNCS.CODE) -->
<!--                   WHERE 1=1 -->
<!--                   	AND VNCS.SAMPLE_STATUS = 5 -->
<!--                  	<if test="industryCode != '' and industryCode != null "> -->
<!-- 						AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 				   </if> -->
<!-- 				   <if test="pt != '' and pt != null "> -->
<!-- 						AND VNCS.DETECTION_CODE = #{pt} -->
<!-- 				   </if> -->
<!-- 					AND VNCS.PROJECT_CODE = #{projectCode} -->
<!--                   	AND VNCS.CODE = #{areaCode} 预留 -->
<!--             GROUP BY ROLLUP(vncs.CODE),NSI2.ISQUAL -->
<!-- 		) t4      -->
<!-- 		WHERE T4.CODE = '汇总' -->
<!-- 	</select> -->
	
	
	<select id="getCitySampleOverProof" resultType="com.hippo.nky.entity.report.SampleOverProofEntity" parameterType="java.util.HashMap">
		 SELECT
		    countyArea,
		    TO_CHAR(samplingCount) AS samplingCount,
		    TO_CHAR(qualifiedCount) AS qualifiedCount
		  FROM
			 (
	       SELECT
	          AREA.AREANAME AS countyArea,
	          COUNT(1) AS samplingCount,
	          SUM(DECODE(T2.overStanderdCount,0,1,'',1,0)) AS qualifiedCount 
	       FROM NKY_SAMPLING_INFO NSI
	       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
	       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
	       LEFT JOIN SYS_AREA_CODE AREA ON NSI.CITY_CODE = AREA.CODE
	       INNER JOIN (
	             SELECT
	                  NDI.SAMPLE_CODE,
	                  SUM(
	                    CASE
	                       WHEN NDI.DETECTION_VALUE > 0 THEN 1
	                       ELSE 0
	                    END
	                    ) AS detetionCount,
	                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
	             FROM 
	             NKY_DETECTION_INFORMATION NDI
	             GROUP BY NDI.SAMPLE_CODE
	       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
	       WHERE NMP.PROJECT_CODE IN
	       	 <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     #{item}
			 </foreach> 
	      <if test="pt != '' and pt != null">
	          AND NSI.DETECTION_CODE = #{pt}
	       </if>
	       AND NSI.SAMPLE_STATUS != '2'
	       GROUP BY AREA.AREANAME,AREA.SHOW_ORDER
<!-- 	       ORDER BY AREA.AREANAME -->
		   ORDER BY AREA.SHOW_ORDER
	  	 )			
	</select>
	
<!-- 	<select id="getSjzlLstForCity" resultMap="plantResult" parameterType="java.util.HashMap"> -->
<!-- 		SELECT distinct t.typecode,t.typename FROM V_NKY_city_SAMPLE vncs -->
<!--       		INNER JOIN t_s_type t ON (t.typecode = vncs.monitoring_link) -->
<!--       		INNER JOIN t_s_typegroup tp ON (tp.id = t.typegroupid)  -->
<!-- 		<where> -->
<!-- 			AND VNCS.PROJECT_CODE = #{projectCode} -->
<!-- 			and tp.typegroupcode = 'allmonLink' -->
<!-- 		</where> -->
<!-- 		ORDER BY t.typecode -->
<!-- 	</select> -->
	
	<select id="getSjzlLstForCity" resultType="java.lang.String" parameterType="java.util.HashMap">
		SELECT distinct t.typename FROM V_NKY_city_SAMPLE vncs
      		INNER JOIN t_s_type t ON (t.typecode = vncs.monitoring_link)
      		INNER JOIN t_s_typegroup tp ON (tp.id = t.typegroupid) 
		where 1=1
			AND VNCS.PROJECT_CODE IN
			 <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			     #{item}
			 </foreach> 
		   <if test="pt != '' and pt != null">
	          AND VNCS.DETECTION_CODE = #{pt}
	       </if>
			and tp.typegroupcode = 'allmonLink'
		ORDER BY t.typename
	</select>
	
<!-- 	<select id="getCityOverProofRight" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap"> -->
<!-- 		SELECT * FROM (    -->
<!-- 	       SELECT t.code,t.areaname,t2.typename,t2.totalSum,t2.isQualSum,t2.pctSum FROM ( -->
<!-- 	             SELECT SUBSTR(s_area.code,1,4) AS code,s_area.areaname FROM SYS_AREA_CODE s_area -->
<!-- 	                    WHERE 1=1 -->
<!-- 	                        AND s_area.code LIKE '____00'  -->
<!-- 	                        AND s_area.code != '320000' -->
<!-- 	                      	AND SUBSTR(s_area.code,1,4) = #{areaCode} -->
<!-- 	                     GROUP BY s_area.code,s_area.areaname -->
<!-- 	                     ORDER BY  s_area.code  -->
<!-- 	         ) t -->
<!-- 	         INNER JOIN  -->
<!--        		( -->
<!--                SELECT VNCS.CODE,T.TYPENAME,SUM(VNCS.TOTALCOUNT) AS TOTALSUM,NVL(NSI2.ISQUAL, 0) AS ISQUALSUM, -->
<!--                       NVL((CASE WHEN NSI2.ISQUAL = 0 THEN 0 WHEN NSI2.ISQUAL != 0 THEN 100 * ROUND((NSI2.ISQUAL / SUM(VNCS.TOTALCOUNT)), 3) END),0) AS PCTSUM -->
<!--                       FROM V_NKY_CITY_SAMPLE VNCS -->
<!--                       LEFT JOIN (SELECT VNCS2.CODE,COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_CITY_SAMPLE VNCS2 -->
<!-- 							WHERE VNCS2.SAMPLE_STATUS = 5 AND VNCS2.IS_QUALIFIED = 0 -->
<!-- 							AND vncs2.monitoring_link = #{monitoringLink} -->
<!--                           <if test="industryCode != '' and industryCode != null "> -->
<!-- 								AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 						   </if> -->
<!-- 						   <if test="pt != '' and pt != null "> -->
<!-- 								AND VNCS2.DETECTION_CODE = #{pt} -->
<!-- 						   </if> -->
<!--                             AND VNCS2.PROJECT_CODE =  #{projectCode} -->
<!--                     GROUP BY VNCS2.CODE) NSI2 ON (NSI2.CODE = VNCS.CODE) -->
<!-- 					LEFT JOIN T_S_TYPE T ON (T.TYPECODE = VNCS.MONITORING_LINK) -->
<!-- 					LEFT JOIN T_S_TYPEGROUP TP ON (TP.ID = T.TYPEGROUPID)   -->
<!--            			WHERE 1=1 -->
<!--            			AND VNCS.SAMPLE_STATUS = 5 -->
<!--            			AND VNCS.MONITORING_LINK = #{monitoringLink} -->
<!--            			AND TP.TYPEGROUPCODE = 'allmonLink' -->
<!--            		   <if test="industryCode != '' and industryCode != null "> -->
<!-- 						AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 				   </if> -->
<!-- 				   <if test="pt != '' and pt != null "> -->
<!-- 						AND VNCS.DETECTION_CODE = #{pt} -->
<!-- 				   </if> -->
<!-- 					AND VNCS.PROJECT_CODE = #{projectCode} -->
<!-- 					AND VNCS.CODE = #{areaCode} 预留 -->
<!-- 					GROUP BY VNCS.CODE, T.TYPENAME,NSI2.ISQUAL -->
<!-- 					) T2 ON (T.CODE = T2.CODE) ORDER BY T.CODE) -->
<!-- 		    UNION ALL -->
<!-- 		    SELECT t3.code,'' AS areaname,'' AS typename,t3.totalSum,t3.isQualSum,t3.pctSum FROM ( -->
<!-- 		        SELECT vncs.code,SUM(vncs.totalCount) AS totalSum,NVL(NSI2.ISQUAL, 0) AS ISQUALSUM, -->
<!-- 		        NVL((CASE WHEN NSI2.ISQUAL = 0 THEN 0 WHEN NSI2.ISQUAL != 0 THEN 100 * ROUND((NSI2.ISQUAL / SUM(VNCS.TOTALCOUNT)), 3) END),0) AS PCTSUM -->
<!--                       FROM V_NKY_CITY_SAMPLE VNCS -->
<!--                       LEFT JOIN (SELECT VNCS2.CODE,COUNT(VNCS2.SAMPLE_CODE) AS ISQUAL FROM V_NKY_CITY_SAMPLE VNCS2 -->
<!-- 							WHERE VNCS2.SAMPLE_STATUS = 5 AND VNCS2.IS_QUALIFIED = 0 -->
<!-- 							AND vncs2.monitoring_link = #{monitoringLink} -->
<!--                           <if test="industryCode != '' and industryCode != null "> -->
<!-- 								AND VNCS2.INDUSTRY_CODE = #{industryCode}  -->
<!-- 						   </if> -->
<!-- 						   <if test="pt != '' and pt != null "> -->
<!-- 								AND VNCS2.DETECTION_CODE = #{pt} -->
<!-- 						   </if> -->
<!--                             AND VNCS2.PROJECT_CODE =  #{projectCode} -->
<!--                 GROUP BY VNCS2.CODE) NSI2 ON (NSI2.CODE = VNCS.CODE) -->
<!-- 		        LEFT JOIN T_S_TYPE T ON (T.TYPECODE = VNCS.MONITORING_LINK) -->
<!-- 		        LEFT JOIN T_S_TYPEGROUP TP ON (TP.ID = T.TYPEGROUPID)   -->
<!-- 		        WHERE 1=1 -->
<!-- 		        	and VNCS.SAMPLE_STATUS = 5 -->
<!-- 					AND vncs.monitoring_link = #{monitoringLink} -->
<!-- 		            AND TP.TYPEGROUPCODE = 'allmonLink' -->
<!--                    <if test="industryCode != '' and industryCode != null "> -->
<!-- 						AND VNCS.INDUSTRY_CODE = #{industryCode}  -->
<!-- 				   </if> -->
<!-- 				   <if test="pt != '' and pt != null "> -->
<!-- 						AND VNCS.DETECTION_CODE = #{pt} -->
<!-- 				   </if> -->
<!-- 					AND VNCS.PROJECT_CODE = #{projectCode} -->
<!-- 		       		AND VNCS.CODE = #{areaCode} 预留 -->
<!-- 		    GROUP BY ROLLUP(vncs.code),NSI2.ISQUAL -->
<!-- 			) t3 WHERE t3.code IS NULL -->
<!-- 	</select> -->
	
	<select id="getCityOverProofRight" resultType="com.hippo.nky.entity.report.SampleOverProofEntity" parameterType="java.util.HashMap">
	SELECT
       AREA.AREANAME AS countyArea,
       TST.TYPENAME AS monitoringLink,
       COUNT(1) AS samplingCount,
       SUM(DECODE(T2.overStanderdCount,0,1,'',1,0)) AS qualifiedCount 
         FROM NKY_SAMPLING_INFO NSI
         LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
         LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
         LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
         LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
         LEFT JOIN SYS_AREA_CODE AREA ON NSI.CITY_CODE = AREA.CODE
         LEFT JOIN T_S_TYPE TST ON (TST.TYPECODE =  NSI.MONITORING_LINK)
         LEFT JOIN T_S_TYPEGROUP TSTG ON (TSTG.ID = TST.TYPEGROUPID)  
         INNER JOIN (
               SELECT
                    NDI.SAMPLE_CODE,
                    SUM(
                      CASE
                         WHEN NDI.DETECTION_VALUE > 0 THEN 1
                         ELSE 0
                      END
                      ) AS detetionCount,
                    SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
               FROM 
               NKY_DETECTION_INFORMATION NDI
               GROUP BY NDI.SAMPLE_CODE
         ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
         where 1=1
        <if test="pt != '' and pt != null">
	        AND NSI.DETECTION_CODE = #{pt}
	     </if>
         and NMP.PROJECT_CODE IN
         <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
		     #{item}
		 </foreach> 
         AND TSTG.TYPEGROUPCODE = 'allmonLink'
         AND NSI.SAMPLE_STATUS != '2'
         GROUP BY AREA.AREANAME,AREA.SHOW_ORDER,TST.TYPENAME
<!--          order by AREA.AREANAME,TST.TYPENAME -->
		 order by AREA.SHOW_ORDER,TST.TYPENAME
	</select>
	
	<resultMap type="java.util.LinkedHashMap" id="countryAndOverResultF">
	</resultMap>
	<!-- 取得药物检出及超标情况报表 -->
	<select id="getCountryAndOverList" parameterType="java.util.HashMap" statementType="CALLABLE">
          <![CDATA[
	          {CALL PKG_PALNT_SITUATION.GET_POLL_DETECTION_INFO(
	           #{projectCode,mode=IN,jdbcType=VARCHAR}
	          ,#{selCondtion,mode=IN,jdbcType=VARCHAR}
	          ,#{pt,mode=IN,jdbcType=VARCHAR}
	          ,#{result,mode=OUT,jdbcType=CURSOR,resultMap=countryAndOverResultF}
	          )}
          ]]> 
	</select>
	
	
	<!-- 各省辖市批发市场超标情况表20141120add -->	
	<select id="getProvincialCitiesOverStandard" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	select 
		cityArea,
		samplingCount,
		overStanderdCount,
		overStanderdRate,
		qualifiedCount,
		qualifiedRate,
		rank
	from (
	  SELECT
	    cityArea,
	    show_order AS show_order,
	    TO_CHAR(samplingCount) AS samplingCount,
	    TO_CHAR(overStanderdCount) AS overStanderdCount,
	    ' ' AS overStanderdRate,
	    to_char(samplingCount - overStanderdCount) AS qualifiedCount,
	    ' ' AS qualifiedRate,
	    RANK() OVER(ORDER BY overStanderdCount/samplingCount) AS rank
	  FROM
		 (
       SELECT
          AREA.AREANAME AS cityArea,
          AREA.SHOW_ORDER AS show_order,
          COUNT(1) AS samplingCount,
          SUM(DECODE(T2.overStanderdCount,0,0,'',0,1)) AS overStanderdCount
       FROM NKY_SAMPLING_INFO NSI
       LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
       LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
       LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
      LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
       LEFT JOIN SYS_AREA_CODE AREA ON NSI.CITY_CODE = AREA.CODE
       INNER JOIN (
             SELECT
                  NDI.SAMPLE_CODE,
                  SUM(
                    CASE
                       WHEN NDI.DETECTION_VALUE > 0 THEN 1
                       ELSE 0
                    END
                    ) AS detetionCount,
                  SUM(DECODE(NDI.IS_OVERPROOF,'1', 1, 0)) AS overStanderdCount
             FROM 
             NKY_DETECTION_INFORMATION NDI
             GROUP BY NDI.SAMPLE_CODE
       ) T2 ON (T2.SAMPLE_CODE = NSI.SAMPLE_CODE)
       WHERE NMP.PROJECT_CODE IN
        <foreach collection="projectCode" index="index" item="item" open="(" separator="," close=")">
			 #{item}
	    </foreach>  
       AND SUBSTR(NSI.COUNTY_CODE,5) = '01'
       <if test="pt != '' and pt != null">
          AND NSI.DETECTION_CODE = #{pt}
       </if>
       AND NSI.SAMPLE_STATUS != '2'
       GROUP BY AREA.AREANAME,AREA.SHOW_ORDER
  	 )	
  	 )order by show_order,rank
  	 		
	</select>
</mapper>