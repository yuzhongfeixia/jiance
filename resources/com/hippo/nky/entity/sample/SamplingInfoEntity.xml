<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hippo.nky.entity.sample.SamplingInfoEntity">
	<resultMap type="java.util.HashMap" id="sampleResult">
		<result column="ID" property="id"/>    
        <result column="UNIT_FULLNAME" property="unitFullname"/>  
        <result column="SAMPLE_CODE" property="sampleCode"/>  
        <result column="SAMPLING_DATE" property="samplingDate"/>  
        <result column="MONITORING_LINK" property="monitoringLink"/>
        <result column="TASK_CODE" property="taskCode"/>
        <result column="CNAME" property="agrname"/>
        <result column="NAME" property="projectName"/>
        <result column="PROJECT_CODE" property="projectCode"/>
        <result column="county_code" property="countycode"/>
        <result column="d_code" property="dcode"/>
        <result column="SP_CODE" property="spCode"/>
        <result column="rn" property="rn"/>
        <result column="CITY_AND_COUNTRY" property="cityAndCountry"/>
        <result column="OGRNAME" property="samplingOrgName"/>
        <result column="REPORTING_DATE" property="reportingDate"/>
    </resultMap>  
	<select id="getSampleCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
<!-- 				<if test="samplingOrgCode == '' or samplingOrgCode == null "> -->
				INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
				INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
<!-- 				</if> -->
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
				LEFT JOIN SYS_AREA_CODE AREA1 ON NSI.CITY_CODE = AREA1.CODE
				LEFT JOIN SYS_AREA_CODE AREA2 ON NSI.COUNTY_CODE = AREA2.CODE
<!-- 				<if test="samplingOrgCode != '' and samplingOrgCode != null "> -->
<!-- 				INNER JOIN NKY_ORGANIZATION_INFO NOI ON NOI.CODE = NSI.SAMPLING_ORG_CODE -->
<!-- 				</if> -->
            WHERE 1=1
<!--             <if test="samplingOrgCode == '' or samplingOrgCode == null "> -->
<!--             	AND NOI.ID = #{orgId} -->
            AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
            AND NMO.ORG_CODE = #{samplingOrgCode}
<!--             </if> -->
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
	        <if test="agrName != '' and agrName != null">
				AND AGR.CNAME LIKE '%' || #{agrName} || '%'
			</if>
			<if test=" unitFullname != '' and unitFullname != null ">
				AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="sampleStatus != '' and sampleStatus != null">
				AND NSI.SAMPLE_STATUS IN 
			    <foreach collection="sampleStatus" index="index" item="item" open="(" separator="," close=")">
			     	#{item}
			    </foreach>  
			</if>
			<if test="monitoringLink != '' and monitoringLink != null">
			 	AND NSI.MONITORING_LINK = #{monitoringLink}
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME = #{projectName}
			</if>
			<!-- 用户部门所在的行政区划 -->
	       	<if test="cityCode != '' and cityCode != null ">
				AND NSI.CITY_CODE = #{cityCode}
			</if>
			<!-- 搜索条件 -Start-->
			<!-- 地区 -->
			<if test=" countyCode != '' and countyCode != null ">
				AND NSI.COUNTY_CODE = #{countyCode}
			</if>
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
		    <!-- 质检机构code -->
  			<if test="orgCode != '' and orgCode != null ">
				AND NOI.CODE = #{orgCode}
			</if>
<!-- 			<if test="samplingOrgCode != '' and samplingOrgCode != null "> -->
<!--  				AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode} -->
<!-- 			</if> -->
			<if test="complete != '' and complete != null ">
 				AND NSI.COMPLETE = #{complete}
			</if>
         ) t	
	</select>
	
	<select id="getSample" resultMap="sampleResult" parameterType="java.util.HashMap">
		SELECT T.* 
		  FROM (SELECT NSI.ID,
				       NSI.UNIT_FULLNAME,
				       NSI.SAMPLE_CODE,
				       TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
				       NSI.MONITORING_LINK,
				       NSI.TASK_CODE,
				       NSI.COUNTY_CODE,
				       NSI.D_CODE,
				       NSI.SP_CODE,
				       AGR.CNAME,
				       NMP.NAME,
				       NMP.PROJECT_CODE,
				       ROWNUM AS RN,
				       AREA1.AREANAME || AREA2.AREANAME AS CITY_AND_COUNTRY,
				       NOI.OGRNAME,
				       TO_CHAR(NSI.REPORTING_DATE,'YYYY-MM-DD') AS REPORTING_DATE
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
<!-- 				<if test="samplingOrgCode == '' or samplingOrgCode == null "> -->
				INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
				INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
<!-- 				</if> -->
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
				LEFT JOIN SYS_AREA_CODE AREA1 ON NSI.CITY_CODE = AREA1.CODE
				LEFT JOIN SYS_AREA_CODE AREA2 ON NSI.COUNTY_CODE = AREA2.CODE
<!-- 				<if test="samplingOrgCode != '' and samplingOrgCode != null "> -->
<!-- 				INNER JOIN NKY_ORGANIZATION_INFO NOI ON NOI.CODE = NSI.SAMPLING_ORG_CODE -->
<!-- 				</if> -->
      			WHERE 1=1
      			AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
      			AND NMO.ORG_CODE = #{samplingOrgCode}
<!--                 <if test="samplingOrgCode == '' or samplingOrgCode == null "> -->
<!--             		AND NOI.ID = #{orgId} -->
<!--             	</if> -->
      			<if test="projectCode != '' and projectCode != null ">
	 				AND NMP.PROJECT_CODE = #{projectCode}
				</if>
		        <if test="agrName != '' and agrName != null">
					AND AGR.CNAME LIKE '%' || #{agrName} || '%'
				</if>
				<if test=" unitFullname != '' and unitFullname != null ">
				 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
				</if>
				<if test="sampleStatus != '' and sampleStatus != null">
					AND NSI.SAMPLE_STATUS IN 
				    <foreach collection="sampleStatus" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				    </foreach>  
				</if>
				<if test="monitoringLink != '' and monitoringLink != null">
				 	AND NSI.MONITORING_LINK = #{monitoringLink}
				</if>
				<if test="projectName != '' and projectName != null">
				 	AND NMP.NAME = #{projectName}
				</if>
				 <!-- 用户部门所在的行政区划 -->
		       	<if test="cityCode != '' and cityCode != null ">
					AND NSI.CITY_CODE = #{cityCode}
				</if>
				<!-- 搜索条件 -Start-->
				<!-- 地区 -->
				<if test=" countyCode != '' and countyCode != null ">
					AND NSI.COUNTY_CODE = #{countyCode}
				</if>
				<if test="dCode != '' and dCode != null">
				 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
				</if>
				 <!-- 质检机构code -->
	  			<if test="orgCode != '' and orgCode != null ">
					AND NOI.CODE = #{orgCode}
				</if>
<!-- 				<if test="samplingOrgCode != '' and samplingOrgCode != null "> -->
<!-- 	 				AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode} -->
<!-- 				</if> -->
				<if test="complete != '' and complete != null ">
 					AND NSI.COMPLETE = #{complete}
				</if>
      	) T
		 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	<select id="getUserMonintorProgaramForDepartment" resultType="com.hippo.nky.entity.monitoring.MonitoringProjectEntity" parameterType="java.util.HashMap">
		   SELECT 
	           T1.PROJECT_CODE AS PROJECTCODE,
	           T1.NAME || '  (' || to_char(T1.PUBLISH_DATE,'yyyyMMdd') || ')' AS NAME,
	           T1.SAMPLE_TEMPLET AS SAMPLETEMPLET,
	           T1.INDUSTRY_CODE AS INDUSTRYCODE,
	           T2.PLEVEL AS PLEVEL
	    	FROM NKY_MONITORING_PROJECT T1
	       INNER JOIN NKY_MONITORING_PLAN T2 ON (T1.PLAN_CODE = T2.PLAN_CODE)
	       <if test="gl_g != '' and gl_g != null">
			INNER JOIN T_S_DEPART T3 ON (T2.RELEASEUNIT = T3.ID)
	       </if>
		   WHERE 1=1 
		   AND (
		   	(T2.RELEASEUNIT = #{orgId} 
		   	 AND (T1.STATE = '1'
		   	 <if test="showCompleteFlg != '' and showCompleteFlg != null">
		   	 	OR T1.STATE = '2'
		   	 </if>
		   	  )
		   	)
		   	<if test="gl_g != '' and gl_g != null and gl_g == 1" >
			    OR (T3.GRADE = '2' AND substr(T3.CODE,1,3) = substr(#{gl_code1},1,3) AND T1.STATE = '3') 
			    OR (T3.GRADE = '3' AND T1.STATE = '3'
			    	AND EXISTS(
			    		select *
			    		from NKY_MONITORING_PROJECT nmp
			    		inner join NKY_MONITORING_PLAN nmpl on (nmp.PLAN_CODE = nmpl.PLAN_CODE)
			    		inner join T_S_DEPART tsd on (nmpl.RELEASEUNIT = tsd.ID)
			    		where tsd.grade = '2'
			    		and substr(tsd.CODE,1,3) = substr(#{gl_code1},1,3) AND nmp.STATE = '3'
			    		and tsd.CODE = T3.CODE
			    	)
			    )
			</if>
			<if test="gl_g != '' and gl_g != null and gl_g == 2" >
			    OR (T3.GRADE = '3' AND substr(T3.AREACODE2,1,4) = substr(#{gl_code2},1,4) AND T1.STATE = '3') 
			</if>
		   )
		<if test="monitorType != '' and monitorType != null">
		 	AND T2.TYPE = #{monitorType}
		</if>
		<if test="year != '' and year != null">
		 	AND TO_CHAR(T1.STARTTIME,'YYYY') = #{year}
		</if>
		ORDER BY T1.PUBLISH_DATE DESC
	</select>
	<select id="getUserMonintorProgaram" resultType="com.hippo.nky.entity.monitoring.MonitoringProjectEntity" parameterType="java.util.HashMap">
	    SELECT distinct(t1.PROJECT_CODE) as projectCode,
           t1.name || '  (' || to_char(T1.PUBLISH_DATE,'yyyyMMdd') || ')'  as name,
           t1.SAMPLE_TEMPLET as sampleTemplet,
           t1.INDUSTRY_CODE as industryCode,
           t2.PLEVEL as plevel,
           T1.PUBLISH_DATE
    	FROM NKY_MONITORING_PROJECT t1
   		LEFT JOIN Nky_MONITORING_PLAN T2 ON (t1.PLAN_CODE = t2.PLAN_CODE)
    	INNER JOIN NKY_MONITORING_ORGANIZATION t3 ON (t1.PROJECT_CODE = t3.PROJECT_CODE)
    	INNER JOIN NKY_ORGANIZATION_INFO t4 ON ( t3.ORG_CODE = t4.CODE) 
		WHERE 1= 1
		<if test="qtFlg != '' and qtFlg != null and qtFlg == 1">
		 AND (t1.LEADUNIT = #{orgCode} OR t4.ID = #{orgId})
		</if>
		<if test="qtFlg == '' or qtFlg == null">
		 AND t4.ID = #{orgId}
		</if>
		AND (T1.STATE = '1'
<!-- 		<if test="showCompleteFlg != '' and showCompleteFlg != null"> -->
		   	 OR T1.STATE = '2'
		   	 OR T1.STATE = '3'
<!-- 		</if> -->
		 )
		<if test="monitorType != '' and monitorType != null">
		 	AND T2.TYPE = #{monitorType}
		</if>
		<if test="year != '' and year != null">
		 	AND TO_CHAR(T1.STARTTIME,'YYYY') = #{year}
		</if>
		ORDER BY T1.PUBLISH_DATE DESC
	</select>

	<select id="getPadUserMonintorProgaram" resultType="com.hippo.nky.entity.monitoring.MonitoringProjectEntity" parameterType="java.util.HashMap">
	  SELECT t1.PROJECT_CODE as projectCode,
           t1.name as name,
           t1.SAMPLE_TEMPLET as sampleTemplet,
           t1.INDUSTRY_CODE as industryCode,
           t2.PLEVEL as plevel,
           t2.TYPE AS type,
           t7.cname AS projectBreed,
           T8.linkInfo as linkInfo
      FROM NKY_MONITORING_PROJECT t1
      INNER JOIN Nky_MONITORING_PLAN T2 ON (t1.PLAN_CODE = t2.PLAN_CODE)
      INNER JOIN NKY_MONITORING_ORGANIZATION t3 ON (t1.PROJECT_CODE = t3.PROJECT_CODE)
      INNER JOIN NKY_ORGANIZATION_INFO t4 ON ( t3.ORG_CODE = t4.CODE) 
      INNER JOIN NKY_MONITORING_TASK t5 ON (t1.project_code = t5.project_code)
      INNER JOIN NKY_MONITORING_TASK_DETAILS t6 ON (t5.task_code = t6.task_code)
      INNER JOIN (
          SELECT
             NMB.PROJECT_CODE,
             wmsys.wm_concat(AGR.CNAME) as CNAME
             FROM NKY_MONITORING_BREED NMB
             LEFT JOIN V_NKY_MONITORING_AGR AGR ON(NMB.AGR_CODE = AGR.CODE AND NMB.PROJECT_CODE = AGR.PROJECT_CODE)
             GROUP BY NMB.PROJECT_CODE
      ) t7 ON (t7.PROJECT_CODE = T1.PROJECT_CODE)
      INNER JOIN (
          SELECT
             NMS.PROJECT_CODE,
             wmsys.wm_concat(TST.TYPENAME) as linkInfo
             FROM NKY_MONITORING_SAMPLELINK NMS
             LEFT JOIN T_S_TYPE TST ON (TST.TYPECODE =  NMS.MONITORING_LINK)
			 LEFT JOIN T_S_TYPEGROUP TSTG ON (TSTG.ID = TST.TYPEGROUPID) 
			 WHERE TSTG.TYPEGROUPCODE = 'allmonLink'
             GROUP BY NMS.PROJECT_CODE
      ) t8 ON (t8.PROJECT_CODE = T1.PROJECT_CODE)
     WHERE t4.CODE = #{orgCode}
     AND T1.STATE = '1'
     AND to_char(T1.starttime,'yyyy')>= extract(year from sysdate) - 1
     AND T6.PAD_ID = #{padId}
     <if test="projectName != '' and projectName != null">
		AND t1.NAME LIKE '%' || #{projectName} || '%' 
	 </if>
    group by t1.PROJECT_CODE,t1.name,t1.SAMPLE_TEMPLET,t1.INDUSTRY_CODE,t2.plevel,t2.type,t1.PUBLISH_DATE,t7.cname,T8.linkInfo
  	ORDER BY t1.PUBLISH_DATE DESC
	</select>
	
	<resultMap type="java.util.HashMap" id="sampleMakeCodeResultGrid">
		<result column="ID" property="id"/>
		<result column="SP_CODE" property="spCode"/>  
		<result column="D_CODE" property="dCode"/>  
		<result column="CITY_CODE" property="cityCode"/>  
        <result column="COUNTY_CODE" property="countyCode"/>  
        <result column="UNIT_FULLNAME" property="unitFullname"/>  
        <result column="SAMPLE_CODE" property="sampleCode"/>  
        <result column="SAMPLING_DATE" property="samplingDate"/>  
        <result column="MONITORING_LINK" property="monitoringLink"/>
        <result column="CNAME" property="agrname"/>
        <result column="CITY_AND_COUNTRY" property="cityAndCountry"/>
        <result column="rn" property="rn"/>
    </resultMap>  
	<select id="getSampleMakeCodeGridCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  		  from (select nsi.id
         		 from nky_sampling_info nsi
         		 inner JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				 inner JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				 INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMO.PROJECT_CODE = NMP.PROJECT_CODE)
				 INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NOI.CODE = NMO.ORG_CODE)
		         LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
		         left join sys_area_code area1 on nsi.CITY_CODE = area1.code
				 Left join sys_area_code area2 on nsi.COUNTY_CODE = area2.code
       	 where 1=1
       	 <!-- 权限 -->
         AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
         AND NMO.ORG_CODE = #{samplingOrgCode}
       	 <!-- 除去费样 -->
			AND nsi.SAMPLE_STATUS != '2'
		 <!-- 只查抽检分离的数据 -->
			AND NMP.DETACHED = '1'
       	 <!-- 项目 -->
       	<if test="projectCode != '' and projectCode != null ">
			AND NMP.PROJECT_CODE = #{projectCode}
		</if>
		<!-- 搜索条件 -Start-->
		<!-- 地区 -->
       	<if test=" cityCode != '' and cityCode != null ">
			and nsi.CITY_CODE = #{cityCode}
		</if>
		<if test=" countyCode != '' and countyCode != null ">
			and nsi.COUNTY_CODE = #{countyCode}
		</if>
		<!-- 条 码 -->
		<if test=" dCode != '' and dCode != null ">
			and nsi.D_CODE like '%' || #{dCode} || '%'
		</if>
		<!-- 样品名称 -->
        <if test=" sampleName != '' and sampleName != null ">
			and agr.CNAME like '%' || #{sampleName} || '%'
		</if>
		<!-- 受检单位 -->
		<if test=" unitFullname != '' and unitFullname != null ">
			and nsi.UNIT_FULLNAME like '%' || #{unitFullname} || '%'
		</if>
		<!-- 抽样环节 -->
		<if test=" monitoringLink != '' and monitoringLink != null ">
			and nsi.MONITORING_LINK = #{monitoringLink} 
		</if>
		<if test="sampleStatus != '' and sampleStatus != null">
		 	AND NSI.SAMPLE_STATUS = #{sampleStatus}
		</if>
		<!-- 搜索条件 -ENd-->
         ) t	
	</select>
	
	<!-- 取得制样编码管理的datagrid的sql-->
	<select id="getSampleMakeCodeGrid" resultMap="sampleMakeCodeResultGrid" parameterType="java.util.HashMap">
		select t.* 
		  from (select nsi.id
		  			,nsi.D_CODE
		  			,substr(nsi.SP_CODE, instr(nsi.SP_CODE, '-', -1, 1) + 1) as SP_CODE
               		,nsi.UNIT_FULLNAME
              		,TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE
              		,nsi.MONITORING_LINK
              		,agr.cname
              		,rownum              as rn
              		,area1.AREANAME || area2.AREANAME as CITY_AND_COUNTRY
              		,nsi.CITY_CODE
              		,nsi.COUNTY_CODE
         		from nky_sampling_info nsi
         		inner JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				inner JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMO.PROJECT_CODE = NMP.PROJECT_CODE)
				INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NOI.CODE = NMO.ORG_CODE)
		        LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
		        left join sys_area_code area1 on nsi.CITY_CODE = area1.code
				Left join sys_area_code area2 on nsi.COUNTY_CODE = area2.code
		       	where 1=1
		       	<!-- 权限 -->
		        AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
                AND NMO.ORG_CODE = #{samplingOrgCode}
		       	<!-- 除去费样 -->
					AND nsi.SAMPLE_STATUS != '2'
				<!-- 只查抽检分离的数据 -->
				AND NMP.DETACHED = '1'
		       	<!-- 项目 -->
		       	<if test="projectCode != '' and projectCode != null ">
					AND NMP.PROJECT_CODE = #{projectCode}
				</if>
				<!-- 搜索条件 -Start-->
				<!-- 地区 -->
				<if test=" cityCode != '' and cityCode != null ">
					and nsi.CITY_CODE = #{cityCode}
				</if>
				<if test=" countyCode != '' and countyCode != null ">
					and nsi.COUNTY_CODE = #{countyCode}
				</if>
				<!-- 条 码 -->
				<if test=" dCode != '' and dCode != null ">
					and nsi.D_CODE like '%' || #{dCode} || '%'
				</if>
				<!-- 样品名称 -->
		        <if test=" sampleName != '' and sampleName != null ">
					and agr.CNAME like '%' || #{sampleName} || '%'
				</if>
				<!-- 受检单位 -->
				<if test=" unitFullname != '' and unitFullname != null ">
					and nsi.UNIT_FULLNAME like '%' || #{unitFullname} || '%'
				</if>
				<!-- 抽样环节 -->
				<if test=" monitoringLink != '' and monitoringLink != null ">
					and nsi.MONITORING_LINK = #{monitoringLink} 
				</if>
				<if test="sampleStatus != '' and sampleStatus != null">
				 	AND NSI.SAMPLE_STATUS = #{sampleStatus}
				</if>
				<!-- 搜索条件 -ENd-->
		  ) t
		 where rn > #{beginIndex} and rn <![CDATA[ <= ]]>  #{endIndex}
		 <!-- 默认以地区、条码顺序显示 -->
		 order by t.CITY_CODE, t.COUNTY_CODE NULLS FIRST, t.D_CODE, t.SP_CODE
	</select>
	
	<select id="findObsoleteByCode" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		  SELECT NSI.ID,
		         NSI.SAMPLE_CODE,
		         TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
		         NSI.D_CODE,
		         AGR.CNAME,
		         NMP.NAME,
		         ROWNUM AS RN
		    FROM NKY_SAMPLING_INFO NSI
		    LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		    LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
<!-- 		    LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON (NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
<!-- 		    LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NMO.ORG_CODE = NOI.CODE) -->
		    LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND NMP.PROJECT_CODE = AGR.PROJECT_CODE)
       	WHERE NSI.SAMPLING_ORG_CODE = #{orgCode} AND NSI.D_CODE = #{dcode}
	</select>	
	
	 <select id="getAddSetBackData" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		  SELECT NSI.ID,
		         NSI.SAMPLE_CODE,
		         TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
		         NSI.D_CODE,
		         AGR.CNAME,
		         NMP.NAME,
		         ROWNUM AS RN
		    FROM NKY_SAMPLING_INFO NSI
		    LEFT JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		    LEFT JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		    LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND NMP.PROJECT_CODE = AGR.PROJECT_CODE)
       	WHERE NSI.SAMPLING_ORG_CODE = #{orgCode} AND NSI.D_CODE = #{dcode} AND NSI.SAMPLE_STATUS >= 3
       	   AND NMP.STATE = '1'
	</select>
	
	<select id="checkCode" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT count(*)
		FROM NKY_SAMPLING_INFO T1
		WHERE T1.D_CODE = #{dcode}
	</select>
		
	<sql id="sampleInfoID">
		SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				LEFT JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
				LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
				LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
				LEFT JOIN SYS_AREA_CODE AREA1 ON NSI.CITY_CODE = AREA1.CODE
				LEFT JOIN SYS_AREA_CODE AREA2 ON NSI.COUNTY_CODE = AREA2.CODE
            WHERE 1=1 
	</sql>
	
	<select id="checkSampleDetached" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			<include refid="sampleInfoID"/>
			AND NSI.SAMPLE_STATUS = 1
			AND NMP.DETACHED = 1 
			AND NSI.SP_CODE IS NULL
		<if test="projectCode != '' and projectCode != null ">
			AND NMP.PROJECT_CODE = #{projectCode}
		</if>
		AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
        AND NMO.ORG_CODE = #{samplingOrgCode}
         ) t	
	</select>
	
	<select id="getSampleAllCountByStatus" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
			from (
  			SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			where 1=1
			AND NSI.SAMPLE_STATUS = 1
  		   	<if test="orgCode != '' and orgCode != null ">
		   		AND NSI.SAMPLING_ORG_CODE = #{orgCode}
		   	</if>
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
         ) t	
	</select>

	<select id="getSampleSubCountByStatus" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			where 1=1
			AND NSI.SAMPLE_STATUS = 1
			AND nsi.complete = 0
			<if test="orgCode != '' and orgCode != null ">
		   		AND NSI.SAMPLING_ORG_CODE = #{orgCode}
		   	</if>
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
         ) t	
	</select>
	
	<select id="getSampleSubCountByStatus1" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			where 1=1
			AND NSI.SAMPLE_STATUS = 1
			AND nsi.complete = 0
			AND NSI.ID IN (${sampleIdList})
         ) t	
	</select>

	<update id="toUpdateReport" parameterType="java.util.HashMap">
		UPDATE NKY_SAMPLING_INFO NSI 
		SET NSI.SAMPLE_STATUS = 3 
		,NSI.REPORTING_DATE = sysdate
		WHERE NSI.ID IN(
  			<include refid="sampleInfoID"/>
			AND NSI.SAMPLE_STATUS = 1
			AND nsi.complete = 1
		   	AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
       		AND NMO.ORG_CODE = #{samplingOrgCode}
			AND NMP.PROJECT_CODE = #{projectCode}
		)
	</update>
	
	<update id="toUpdateReport1" parameterType="java.util.HashMap">
		UPDATE NKY_SAMPLING_INFO NSI 
		SET NSI.SAMPLE_STATUS = 3 
		,NSI.REPORTING_DATE = sysdate
		WHERE NSI.ID IN (${sampleIdList})
		AND NSI.complete = 1
	</update>
	
	<resultMap type="java.util.HashMap" id="cityList">
		<result column="CODE" property="code"/>
		<result column="AREANAME" property="areaName"/>  
    </resultMap>  
    
	<!-- 取得对应项目下的所有地市集合 -->
	<select  id="getCityCodeList" resultMap="cityList" parameterType="java.util.HashMap">
		SELECT NSI.CITY_CODE AS CODE, AREA.AREANAME
			  FROM NKY_SAMPLING_INFO NSI
			 INNER JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
			 INNER JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE =
			                                          NMT.PROJECT_CODE)
			 INNER JOIN SYS_AREA_CODE AREA ON (NSI.CITY_CODE = AREA.CODE)
			 WHERE 1 = 1
				<!-- 项目 -->
				<if test="projectCode != '' and projectCode != null ">
					AND NMP.PROJECT_CODE = #{projectCode}
				</if>
			 GROUP BY NSI.CITY_CODE, AREA.AREANAME,AREA.SHOW_ORDER
			 ORDER BY AREA.SHOW_ORDER
	</select>
	
	<!-- 取得对应项目下的所有区县集合 -->
	<select  id="getCountryCodeList" resultMap="cityList" parameterType="java.util.HashMap">
		SELECT NSI.COUNTY_CODE AS CODE, AREA.AREANAME
			  FROM NKY_SAMPLING_INFO NSI
			 INNER JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
			 INNER JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE =
			                                          NMT.PROJECT_CODE)
			 INNER JOIN SYS_AREA_CODE AREA ON (NSI.COUNTY_CODE = AREA.CODE)
			 WHERE 1 = 1
				<!-- 项目 -->
				<if test="projectCode != '' and projectCode != null ">
					AND NMP.PROJECT_CODE = #{projectCode}
				</if>
				<!-- 地市 -->
				<if test="cityCode != '' and cityCode != null ">
					AND NSI.CITY_CODE = #{cityCode}
				</if>
			 GROUP BY NSI.COUNTY_CODE, AREA.AREANAME,AREA.SHOW_ORDER
			 ORDER BY AREA.SHOW_ORDER
	</select>
	
		<!-- 取得最新版本的农产品名称-->
	<select  id="getLastVersionAgrName" resultType="java.lang.String" parameterType="java.util.HashMap">
		SELECT V1.CNAME as cname
		  FROM V_NKY_MONITORING_AGR V1
		 WHERE V1.CODE = #{agrCode}
		 AND V1.PROJECT_CODE = #{projectCode}
	</select>
	
	<select id="getAgrVersionId" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT VERSION.AGR_VERSION_ID AS ID
		  FROM NKY_MONITORING_PROJECT PROJECT, NKY_STANDARD_VERSION VERSION
		 WHERE PROJECT.JUDGE_VERSION_ID = VERSION.ID
		   AND PROJECT.PROJECT_CODE = #{project_code}
	</select>
	<!-- 抽样完成情况统计 返回对象-->
	<resultMap type="java.util.HashMap" id="staResult">
        <result column="ORG_CODE" property="orgcode"/>  
        <result column="PROJECT_CODE" property="projectcode"/>  
        <result column="COUNT" property="count"/>
        <result column="OGRNAME" property="agrname"/>
      	<result column="REPORTCOUNT" property="reportcount"/>
        <result column="ROWNUM" property="rn"/>
    </resultMap>  
    
	<!-- 抽样完成情况统计 -->
	<select id="findForStatistics" resultMap="staResult" parameterType="java.util.HashMap">
	SELECT ROWNUM,t2.* FROM (
		SELECT NMO.ORG_CODE,NOI.OGRNAME,NVL(NMT.COUNT,0) AS COUNT,NVL(NSI.REPORTCOUNT,0) AS REPORTCOUNT
			FROM NKY_MONITORING_ORGANIZATION NMO 
		    INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
		    INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMO.PROJECT_CODE = NMP.PROJECT_CODE)
		    LEFT JOIN (
		    	SELECT ORG_CODE,SUM(SAMPLING_COUNT) AS COUNT FROM NKY_MONITORING_TASK 
		    	<where>
  		  			 <!-- 项目 -->
					 <if test="projectCode != '' and projectCode != null ">
						AND PROJECT_CODE = #{projectCode}
					 </if>
		    	</where>
		    	GROUP BY ORG_CODE
		    ) NMT ON (NMO.ORG_CODE = NMT.ORG_CODE) 
		    LEFT JOIN (
		         SELECT COUNT(NSI.ID) AS REPORTCOUNT,NSI.SAMPLING_ORG_CODE FROM NKY_SAMPLING_INFO NSI
		          INNER JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		          INNER JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		          WHERE NSI.SAMPLE_STATUS >= 3 
					<if test="qt != '' and qt != null ">
		           		AND NMP.LEADUNIT = #{qt}
		           	</if>
		           	<if test="pt != '' and pt != null ">
		           		AND NSI.SAMPLING_ORG_CODE = #{pt}
		           	</if>
		            <!-- 项目 -->
					<if test="projectCode != '' and projectCode != null ">
						AND NMP.PROJECT_CODE = #{projectCode}
					</if>
		          GROUP BY NSI.SAMPLING_ORG_CODE   
		    ) NSI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
		   WHERE 1=1
  			<if test="qt != '' and qt != null ">
           		AND NMP.LEADUNIT = #{qt}
           	</if>
           	<if test="pt != '' and pt != null ">
           		AND NOI.CODE = #{pt}
           	</if>
			<!-- 项目 -->
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
		   GROUP BY NMO.ORG_CODE,NMT.COUNT,NOI.OGRNAME,NSI.REPORTCOUNT
       	) t2
	</select>
	<!-- 抽样完成情况统计 size -->
	<select id="getCountForStatistics" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*) FROM (
		SELECT NMO.ORG_CODE
			FROM NKY_MONITORING_ORGANIZATION NMO 
		    INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
		    INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMO.PROJECT_CODE = NMP.PROJECT_CODE)
		    LEFT JOIN (
		    	SELECT ORG_CODE,SUM(SAMPLING_COUNT) AS COUNT FROM NKY_MONITORING_TASK 
		    	<where>
  		  			 <!-- 项目 -->
					 <if test="projectCode != '' and projectCode != null ">
						AND PROJECT_CODE = #{projectCode}
					 </if>
		    	</where>		    	
		    	GROUP BY ORG_CODE
		    ) NMT ON (NMO.ORG_CODE = NMT.ORG_CODE) 
		    LEFT JOIN (
		         SELECT COUNT(NSI.ID) AS REPORTCOUNT,NSI.SAMPLING_ORG_CODE FROM NKY_SAMPLING_INFO NSI
		          INNER JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
		          INNER JOIN NKY_MONITORING_PROJECT NMP ON (NMP.PROJECT_CODE = NMT.PROJECT_CODE)
		          WHERE NSI.SAMPLE_STATUS >= 3 
					<if test="qt != '' and qt != null ">
		           		AND NMP.LEADUNIT = #{qt}
		           	</if>
		           	<if test="pt != '' and pt != null ">
		           		AND NSI.SAMPLING_ORG_CODE = #{pt}
		           	</if>
		            <!-- 项目 -->
					<if test="projectCode != '' and projectCode != null ">
						AND NMP.PROJECT_CODE = #{projectCode}
					</if>
		          GROUP BY NSI.SAMPLING_ORG_CODE   
		    ) NSI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
		   WHERE 1=1
  			<if test="qt != '' and qt != null ">
           		AND NMP.LEADUNIT = #{qt}
           	</if>
           	<if test="pt != '' and pt != null ">
           		AND NOI.CODE = #{pt}
           	</if>
			<!-- 项目 -->
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
		   GROUP BY NMO.ORG_CODE,NMT.COUNT,NOI.OGRNAME,NSI.REPORTCOUNT
      	)
	</select>
	
    <!--样品分发  返回对象-->
	<resultMap type="java.util.HashMap" id="sampleDistributeResult">
	    <result column="PROJECT_CODE" property="id"/>  
        <result column="NAME" property="projectName"/>  
        <result column="PACKING_FLG" property="packingFlg"/>  
        <result column="DEPARTNAME" property="releaseunit"/>
        <result column="PUBLISH_DATE" property="publishDate"/>  
        <result column="COUN" property="count"/>
        <result column="DSCOUNT" property="dscount"/>
    </resultMap>  
	<!-- 样品分发 size -->
	<select id="getCountForSampleDistribute" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM(
			SELECT 
			  		   NMP.PROJECT_CODE,
					   NMP.NAME,
					   NMP.PACKING_FLG,
					   NMPL.RELEASEUNIT,
					   TO_CHAR(NMP.PUBLISH_DATE,'YYYY-MM-DD') AS PUBLISH_DATE,
		               COUNT(NSI.ID) AS COUN,
		               SUM(NVL2(NSI.DETECTION_CODE,1,0)) AS DSCOUNT
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
<!-- 				INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
<!-- 				INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE) -->
			WHERE
			1=1 
			AND NMP.LEADUNIT = #{leadunit}
<!-- 			NOI.ID = #{orgId} -->
			AND NMP.DETACHED = '1'
			AND NSI.SAMPLE_STATUS <![CDATA[ >= ]]> 3
			<if test="name != '' and name != null ">
				AND NMP.NAME LIKE '%' || #{name} || '%'
			</if>
			<if test="publishDate_begin != '' and publishDate_begin != null ">
				AND NMP.PUBLISH_DATE BETWEEN #{publishDate_begin} AND #{publishDate_end}
			</if>
			GROUP BY NMP.PROJECT_CODE, NMP.NAME, NMP.PACKING_FLG, NMP.PUBLISH_DATE, NMPL.RELEASEUNIT
		)
	</select>
	<!-- 样品分发 列表取得-->
	<select id="getSampleDistribute" resultMap="sampleDistributeResult" parameterType="java.util.HashMap">
	  SELECT *
	  FROM (
			SELECT T.*,ROWNUM AS RN
			FROM(
				SELECT 
					   NMP.PROJECT_CODE,
					   NMP.NAME,
					   NMP.PACKING_FLG,
					   TSD.DEPARTNAME,
					   TO_CHAR(NMP.PUBLISH_DATE,'YYYY-MM-DD') AS PUBLISH_DATE,
		               COUNT(NSI.ID) AS COUN,
		               SUM(NVL2(NSI.DETECTION_CODE,1,0)) AS DSCOUNT
				FROM NKY_SAMPLING_INFO NSI
					INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
					INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
					INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
<!-- 					INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
<!-- 					INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE) -->
					LEFT JOIN T_S_DEPART TSD ON(TSD.ID = NMPL.RELEASEUNIT)
				WHERE 
<!-- 				NOI.ID = #{orgId} -->
				1=1
				AND NMP.LEADUNIT = #{leadunit}
				AND NMP.DETACHED = '1'
				AND NMP.STATE = '1'
				AND NSI.SAMPLE_STATUS <![CDATA[ >= ]]> 3
				<if test="name != '' and name != null ">
					AND NMP.NAME LIKE '%' || #{name} || '%'
				</if>
				<if test="publishDate_begin != '' and publishDate_begin != null ">
					AND NMP.PUBLISH_DATE BETWEEN #{publishDate_begin} AND #{publishDate_end}
				</if>
				GROUP BY NMP.PROJECT_CODE, NMP.NAME, NMP.PACKING_FLG, NMP.PUBLISH_DATE,TSD.DEPARTNAME
				ORDER BY NMP.PUBLISH_DATE DESC
			) T
		)
		WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	<!-- 样品分发整包分发页面========================================================================================================== -->
	<resultMap type="java.util.HashMap" id="packingDistributeResult">
	    <result column="CODE" property="id"/>  
        <result column="OGRNAME" property="ogrname"/>  
        <result column="NAME" property="name"/>
        <result column="AREANAME" property="areaname"/>
        <result column="REPORTING_DATE" property="reportingDate"/>  
        <result column="RPTCOUNT" property="rpCount"/>
        <result column="ONAME" property="oname"/>
    </resultMap>
 
	<!-- 整包分发size -->
	<select id="getCountForPackkingDistribute" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM(
			SELECT
					NOI.CODE || ','|| AREA1.CODE || ','|| AREA2.CODE AS CODE,
					NOI.OGRNAME,
					AREA1.AREANAME || AREA2.AREANAME AS AREANAME,
					NMP.NAME,
					TO_CHAR(NSI.REPORTING_DATE, 'YYYY-MM-DD') AS REPORTING_DATE,
					SUM(DECODE(NSI.SAMPLE_STATUS,'3',1,'4',1,'5',1,0)) AS RPTCOUNT,
					TAB1.oname AS ONAME
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
<!-- 				LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
				INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
				INNER JOIN SYS_AREA_CODE AREA1 ON (NSI.CITY_CODE = AREA1.CODE)
                INNER JOIN SYS_AREA_CODE AREA2 ON (NSI.COUNTY_CODE = AREA2.CODE)
				LEFT JOIN (
					SELECT
					    T1.DETECTION_CODE AS detectionId,
						T2.OGRNAME AS oname
					FROM NKY_SAMPLING_INFO T1
					INNER JOIN NKY_ORGANIZATION_INFO T2
					ON T1.DETECTION_CODE = T2.CODE
					GROUP BY T1.DETECTION_CODE,T2.OGRNAME 
				) TAB1 ON (TAB1.detectionId = NSI.DETECTION_CODE)
				WHERE 
					NMP.PROJECT_CODE = #{projectCode}
				AND NMP.DETACHED = '1'
				AND NSI.SAMPLE_STATUS <![CDATA[ >= ]]> 3
				<if test="ogrname != '' and ogrname != null ">
	            	AND NOI.OGRNAME LIKE '%' || #{ogrname} || '%'
	         	</if>
	         	<if test="name != '' and name != null ">
	            	AND NMP.NAME LIKE '%' || #{name} || '%'
	         	</if>	
			     GROUP BY NOI.CODE || ','|| AREA1.CODE || ','|| AREA2.CODE,NOI.OGRNAME, AREA1.AREANAME || AREA2.AREANAME,NMP.PROJECT_CODE,NMP.NAME,NSI.REPORTING_DATE,ONAME,AREA1.SHOW_ORDER,AREA2.SHOW_ORDER
   				 ORDER BY NMP.PROJECT_CODE,NOI.CODE || ','|| AREA1.CODE || ','|| AREA2.CODE,AREA1.SHOW_ORDER,AREA2.SHOW_ORDER
		)
	</select>
	<!-- 整包分发页面列表数据取得 -->
	<select id="getPackingDistribute" resultMap="packingDistributeResult" parameterType="java.util.HashMap">
	SELECT *
	  FROM (
			SELECT T.*,ROWNUM AS RN
			FROM(
				SELECT
					NOI.CODE || ','|| AREA1.CODE || ','|| AREA2.CODE AS CODE,
					NOI.OGRNAME,
					AREA1.AREANAME || AREA2.AREANAME AS AREANAME,
					NMP.NAME,
					TO_CHAR(NSI.REPORTING_DATE, 'YYYY-MM-DD') AS REPORTING_DATE,
					SUM(DECODE(NSI.SAMPLE_STATUS,'3',1,'4',1,'5',1,0)) AS RPTCOUNT,
					TAB1.oname AS ONAME
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
<!-- 				LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
				INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
				INNER JOIN SYS_AREA_CODE AREA1 ON (NSI.CITY_CODE = AREA1.CODE)
                INNER JOIN SYS_AREA_CODE AREA2 ON (NSI.COUNTY_CODE = AREA2.CODE)
				LEFT JOIN (
					SELECT
					    T1.DETECTION_CODE AS detectionId,
						T2.OGRNAME AS oname
					FROM NKY_SAMPLING_INFO T1
					INNER JOIN NKY_ORGANIZATION_INFO T2
					ON T1.DETECTION_CODE = T2.CODE
					GROUP BY T1.DETECTION_CODE,T2.OGRNAME 
				) TAB1 ON (TAB1.detectionId = NSI.DETECTION_CODE)
				WHERE 
					NMP.PROJECT_CODE = #{projectCode}
				AND NMP.DETACHED = '1'
				AND NSI.SAMPLE_STATUS <![CDATA[ >= ]]> 3
				<if test="ogrname != '' and ogrname != null ">
	            	AND NOI.OGRNAME LIKE '%' || #{ogrname} || '%'
	         	</if>
	         	<if test="name != '' and name != null ">
	            	AND NMP.NAME LIKE '%' || #{name} || '%'
	         	</if>	
			     GROUP BY NOI.CODE || ','|| AREA1.CODE || ','|| AREA2.CODE,NOI.OGRNAME, AREA1.AREANAME || AREA2.AREANAME,NMP.PROJECT_CODE,NMP.NAME,NSI.REPORTING_DATE,ONAME,AREA1.SHOW_ORDER,AREA2.SHOW_ORDER
   				 ORDER BY NMP.PROJECT_CODE,NOI.CODE || ','|| AREA1.CODE || ','|| AREA2.CODE,AREA1.SHOW_ORDER,AREA2.SHOW_ORDER
			) T
		)
	WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	
	<!-- 整包分发前确认样品是否接收 -->
		<select id="getRecvCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM(
			SELECT DISTINCT(NSI.SAMPLING_ORG_CODE)
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			    INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
			AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
			AND NSI.CITY_CODE = #{cityCode}
			AND NSI.COUNTY_CODE = #{countyCode}
			AND NMP.DETACHED = '1'
			AND TO_NUMBER(NSI.SAMPLE_STATUS) <![CDATA[ >= ]]> 4
		)
	</select>
	
	
	<resultMap type="java.util.HashMap" id="unpackingDistributeResult">
	    <result column="ID" property="id"/>
	    <result column="SAMPLE_CODE" property="sampleCode"/>    
        <result column="CNAME" property="cname"/> 
        <result column="AREANAME" property="areaname"/>  
        <result column="SP_CODE" property="spCode"/>
        <result column="D_CODE" property="dCode"/>  
        <result column="CODE" property="orgCode"/> 
        <result column="OGRNAME" property="ogrname"/>
        <result column="REPORTING_DATE" property="reportingDate"/>
        <result column="ONAME" property="oname"/>
        <result column="RN" property="rn"/>
    </resultMap>
		<!-- 拆包分发size -->
	<select id="getCountForUnpackkingDistribute" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM(
			SELECT
				NSI.ID
			FROM NKY_SAMPLING_INFO NSI
			INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
<!-- 			LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
			INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
			LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			LEFT JOIN (
				SELECT
				    T1.DETECTION_CODE AS detectionId,
					T2.OGRNAME AS oname
				FROM NKY_SAMPLING_INFO T1
				INNER JOIN NKY_ORGANIZATION_INFO T2
				ON T1.DETECTION_CODE = T2.CODE
				GROUP BY T1.DETECTION_CODE,T2.OGRNAME 
			) TAB1 ON (TAB1.detectionId = NSI.DETECTION_CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
				AND NMP.DETACHED = '1'
				AND NSI.SAMPLE_STATUS <![CDATA[ >= ]]> 3
			<if test="ogrname != '' and ogrname != null ">
            	AND NOI.OGRNAME LIKE '%' || #{ogrname} || '%'
         	</if>
       		<if test="sampleName != '' and sampleName != null ">
            	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
         	</if>
         	<if test="dCode != '' and dCode != null ">
            	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
         	</if>
         	<if test="spCode != '' and spCode != null ">
            	AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
         	</if>	
		) 
	</select>

	<!-- 拆包分发页面列表数据取得 -->
	<select id="getUnpackingDistribute" resultMap="unpackingDistributeResult" parameterType="java.util.HashMap">
		SELECT T.*
		FROM(
			SELECT
			    NSI.ID,
			    NSI.SAMPLE_CODE,
			    AGR.CNAME,
			    NSI.SP_CODE,
				NSI.D_CODE,
				NOI.CODE,
				NOI.OGRNAME,
				TO_CHAR(NSI.REPORTING_DATE, 'YYYY-MM-DD') AS REPORTING_DATE,
				TAB1.oname AS ONAME,
			    ROWNUM AS RN
			FROM NKY_SAMPLING_INFO NSI
			INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
<!-- 			LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE) -->
			INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
			LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			LEFT JOIN (
				SELECT
				    T1.DETECTION_CODE AS detectionId,
					T2.OGRNAME AS oname
				FROM NKY_SAMPLING_INFO T1
				INNER JOIN NKY_ORGANIZATION_INFO T2
				ON T1.DETECTION_CODE = T2.CODE
				GROUP BY T1.DETECTION_CODE,T2.OGRNAME 
			) TAB1 ON (TAB1.detectionId = NSI.DETECTION_CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
				AND NMP.DETACHED = '1'
				AND NSI.SAMPLE_STATUS <![CDATA[ >= ]]> 3
			<if test="ogrname != '' and ogrname != null ">
            	AND NOI.OGRNAME LIKE '%' || #{ogrname} || '%'
         	</if>
         	<if test="sampleName != '' and sampleName != null ">
            	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
         	</if>
         	<if test="dCode != '' and dCode != null ">
            	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
         	</if>
         	<if test="spCode != '' and spCode != null ">
            	AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
         	</if>	
		) T
		 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	
		<!-- 拆包分发前确认样品是否已经接收 -->
	<select id="getRecvCount1" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM(
			SELECT
				NSI.ID
			FROM NKY_SAMPLING_INFO NSI
			INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
			INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
			LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			LEFT JOIN (
				SELECT
				    T1.DETECTION_CODE AS detectionId,
					T2.OGRNAME AS oname
				FROM NKY_SAMPLING_INFO T1
				INNER JOIN NKY_ORGANIZATION_INFO T2
				ON T1.DETECTION_CODE = T2.CODE
				GROUP BY T1.DETECTION_CODE,T2.OGRNAME 
			) TAB1 ON (TAB1.detectionId = NSI.DETECTION_CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
				AND NMP.DETACHED = '1'
				AND NSI.SAMPLE_STATUS <![CDATA[ >= ]]> 4
				AND NSI.ID IN (${sampleIdList})
		) 
	</select>
	
	<!-- 整包保存分发信息 -->
	<update id="saveSamplingDistribute" parameterType="java.util.HashMap">
		UPDATE NKY_SAMPLING_INFO NSI
			SET DETECTION_CODE = #{detectionOrgCode} 
			WHERE NSI.ID IN (
				SELECT T1.ID
				FROM
					 NKY_SAMPLING_INFO T1
				LEFT JOIN NKY_MONITORING_TASK T2 ON (T1.TASK_CODE = T2.TASK_CODE)
			    LEFT JOIN NKY_MONITORING_PROJECT T3 ON(T2.PROJECT_CODE = T3.PROJECT_CODE)
				WHERE
				    T1.SAMPLING_ORG_CODE = #{orgCode}
				AND T1.CITY_CODE = #{cityCode}
				AND T1.COUNTY_CODE = #{countyCode}
				AND T3.PROJECT_CODE = #{projectCode}
			)
	</update>

	<!-- 拆包保存分发信息 -->
	<update id="saveUnpSamplingDistribute" parameterType="java.util.HashMap">
		UPDATE NKY_SAMPLING_INFO NSI
           SET NSI.DETECTION_CODE = #{detectionOrgCode} 
         WHERE NSI.ID IN (${sampleIdList})
	</update>
	
	<!-- 设置项目整拆包FLG -->
	<update id="setProjectPackingFlg" parameterType="java.util.HashMap">
		UPDATE NKY_MONITORING_PROJECT NMP
           SET NMP.PACKING_FLG = #{flgValue} 
         WHERE NMP.PROJECT_CODE = #{projectCode} 
	</update>

	<resultMap type="java.util.HashMap" id="projectOrgResult">
	    <result column="CODE" property="id"/>  
        <result column="OGRNAME" property="ogrname"/>  
        <result column="LEADER" property="leader"/>
        <result column="CONTACTSTEL" property="contactstel"/>  
    </resultMap>
	<select id="getCountForProjectOrg" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM(
			SELECT NOI.ID
			FROM NKY_MONITORING_PROJECT NMP
			LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
			LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
<!-- 			AND	NOI.CODE != #{orgCode} -->
	        <if test="ogrname != '' and ogrname != null ">
            	AND NOI.OGRNAME = #{ogrname}
         	</if>			
		)
	</select>

	<select id="getProjectOrg" resultMap="projectOrgResult" parameterType="java.util.HashMap">
	SELECT *
	  FROM (
		SELECT T.*,ROWNUM AS RN
		FROM(
			SELECT
			    NOI.OGRNAME,
				NOI.CODE,
				NOI.LEADER,
				NOI.CONTACTSTEL
			FROM NKY_MONITORING_PROJECT NMP
			LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
			LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
<!-- 			AND	NOI.CODE != #{orgCode} -->
			<if test="ogrname != '' and ogrname != null ">
            	AND NOI.OGRNAME = #{ogrname}
         	</if>	
		) T
	 )
	WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	
	<select id="getCountForProjectOrg1" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM(
			SELECT NOI.ID
			FROM NKY_MONITORING_PROJECT NMP
			LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
			LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
			AND	NOI.CODE NOT IN(
				SELECT SAMPLING_ORG_CODE
				FROM NKY_SAMPLING_INFO NSI
				WHERE NSI.ID IN (${sampleIdList})
				GROUP BY SAMPLING_ORG_CODE
			)
	        <if test="ogrname != '' and ogrname != null ">
            	AND NOI.OGRNAME = #{ogrname}
         	</if>			
		)
	</select>

	<select id="getProjectOrg1" resultMap="projectOrgResult" parameterType="java.util.HashMap">
	SELECT *
	  FROM (
		SELECT T.*,ROWNUM AS RN
		FROM(
			SELECT
			    NOI.OGRNAME,
				NOI.CODE,
				NOI.LEADER,
				NOI.CONTACTSTEL
			FROM NKY_MONITORING_PROJECT NMP
			LEFT JOIN NKY_MONITORING_ORGANIZATION NMO ON(NMP.PROJECT_CODE = NMO.PROJECT_CODE)
			LEFT JOIN NKY_ORGANIZATION_INFO NOI ON(NMO.ORG_CODE = NOI.CODE)
			WHERE 
				NMP.PROJECT_CODE = #{projectCode}
			AND	NOI.CODE NOT IN(
				SELECT SAMPLING_ORG_CODE
				FROM NKY_SAMPLING_INFO NSI
				WHERE NSI.ID IN (${sampleIdList})
				GROUP BY SAMPLING_ORG_CODE
			)
			<if test="ogrname != '' and ogrname != null ">
            	AND NOI.OGRNAME = #{ogrname}
         	</if>	
		) T
	 )
	WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	<!-- ====================================================================================================================== -->
	
	<resultMap type="java.util.HashMap" id="ProjectAndSampleCountList">
		<result column="COUNT" property="count"/>
		<result column="SI_COUNT" property="siCount"/>  
    </resultMap>
    <!-- 取得项目设置的数量与抽样单的数量 -->
	<select id="getProjectAndSampleCount" resultMap="ProjectAndSampleCountList" parameterType="java.util.HashMap">
		SELECT COUNT(DISTINCT NSI.ID) AS sicount, COUNT(NAC.COUNT) AS account FROM  NKY_SAMPLING_INFO NSI 
		INNER JOIN NKY_MONITORING_TASK NMT ON NSI.TASK_CODE = NMT.TASK_CODE
		INNER JOIN NKY_MONITORING_PROJECT NMP ON NMP.PROJECT_CODE = NMT.PROJECT_CODE
		INNER JOIN NKY_MONITORING_AREA_COUNT NAC ON NAC.PROJECT_CODE = NMP.PROJECT_CODE
		WHERE 1 = 1
		  AND NAC.DISTRICTCODE IS NULL
		<!-- 除去费样 -->
		  AND NSI.SAMPLE_STATUS != '2'
		<!-- 项目 -->
		<if test="projectCode != '' and projectCode != null ">
		  AND NAC.PROJECT_CODE = #{projectCode}
		</if>
	</select>
	
	<!-- 设置制样编码[自定义编码-顺番] -->
	<select id="callUpdateSpCode" statementType="CALLABLE" parameterType="java.util.HashMap" >
	   <![CDATA[
         { CALL PKG_SAMPLE_MAKECODE.update_sp_code(
          #{projectCode,mode=IN,jdbcType=VARCHAR}
          )}
        ]]>
	</select>
	
	<!-- 取得污染物模板 -->
	<select id="getAgrPollTemplate" resultType="java.lang.String" parameterType="java.util.HashMap">
		SELECT 
			T.POLL_CAS as pollCas
		FROM 
		    NKY_MONITORING_DECTION_TEMPLET T
		WHERE
			T.PROJECT_CODE = #{projectCode}
		AND T.AGR_CODE = #{agrCode}
	</select>
	
	<!-- 递归取污染物模板 -->
	<select id="getAgrPollTemplate1" resultType="java.lang.String" parameterType="java.util.HashMap">
	  SELECT 
	    NMDT.POLL_CAS AS pollCas
	  FROM
	    NKY_MONITORING_DECTION_TEMPLET NMDT
	    inner join V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NMDT.AGR_CODE AND AGR.PROJECT_CODE = NMDT.PROJECT_CODE)
	  WHERE 
	  NMDT.PROJECT_CODE = #{projectCode}
	  AND AGR.CODE = pkg_detection_info.get_agr_ancestor(#{projectCode} ,#{agrCode}) 
<!-- 	  AND AGR.ID = ( -->
<!-- 	      SELECT ID -->
<!-- 	      FROM (     -->
<!-- 	        SELECT -->
<!-- 	             AGR.ID  AS ID -->
<!-- 	        FROM NKY_MONITORING_DECTION_TEMPLET NMDT -->
<!-- 	        inner join V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NMDT.AGR_CODE AND AGR.PROJECT_CODE = NMDT.PROJECT_CODE) -->
<!-- 	        where  -->
<!-- 	            NMDT.PROJECT_CODE = #{projectCode} -->
<!-- 	            START WITH (AGR.ID = (SELECT ID FROM V_NKY_MONITORING_AGR WHERE CODE= #{agrCode} AND PROJECT_CODE = #{projectCode}))   -->
<!-- 	            CONNECT BY PRIOR AGR.PID = AGR.ID -->
<!-- 	        ) -->
<!-- 	      WHERE ROWNUM = 1 -->
<!-- 	   )  -->
	</select>
	
	<!-- 通过判定标准设置污染物模版 -->
	<select id="getAgrPollTemplate2" resultType="java.lang.String" parameterType="java.util.HashMap">
	  SELECT
	    POLL.CAS
	  FROM
	    V_NKY_MONITORING_JUDGE JUD
	    INNER JOIN V_NKY_MONITORING_AGR AGR ON (AGR.ID = JUD.AGRID AND AGR.PROJECT_CODE = JUD.PROJECT_CODE)
	    INNER JOIN V_NKY_MONITORING_POLL POLL ON (POLL.ID = JUD.POLLID AND POLL.PROJECT_CODE = JUD.PROJECT_CODE)
	  WHERE
		AGR.CODE = #{agrCode}
	    AND JUD.PROJECT_CODE = #{projectCode} 
	    AND JUD.VALUE IS NOT NULL
	</select>
	
		<!-- 检查用户项目是否上报 -->
	<select id="checkReport" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT SUM(NVL2(NSI.REPORTING_DATE,1,0))
		FROM NKY_SAMPLING_INFO NSI
	    LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	    LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	    INNER JOIN NKY_MONITORING_ORGANIZATION NMO ON (NMO.PROJECT_CODE = NMP.PROJECT_CODE)
    	INNER JOIN NKY_ORGANIZATION_INFO NOI ON (NMO.ORG_CODE = NOI.CODE AND NSI.SAMPLING_ORG_CODE = NMO.ORG_CODE) 
	    WHERE
		    NMP.PROJECT_CODE = #{projectCode}
		AND NOI.CODE = #{orgCode}
	</select>
	
	<!-- 检查样品信息是否上报 -->
	<select id="checkSampleReport" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT DECODE(NSI.SAMPLE_STATUS,'3',1,0)
		FROM NKY_SAMPLING_INFO NSI
	    LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	    LEFT JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
	    WHERE
		    NSI.ID = #{samplingInfoId}
	</select>
	
    <!-- 受检单位模糊查询 -->
	<select id="getMonitoringSite" resultType="com.hippo.nky.entity.monitoring.NkyMonitoringSiteEntity" parameterType="java.util.HashMap">
		SELECT
			NMS.CODE AS code,
			NMS.NAME AS name
		FROM NKY_MONITORING_SITE NMS
		WHERE
		    NMS.NAME LIKE '%' || #{keyWords} || '%'
	</select>
	
	<!-- 抽样基本信息查看 -->
	<select id="getCommonSampleDetail" resultType="java.util.HashMap" parameterType="com.hippo.nky.entity.sample.SamplingInfoEntity">
		SELECT NSI.D_CODE,NSI.UNIT_FULLNAME,NSI.UNIT_ADDRESS,NSI.ZIP_CODE,NSI.LEGAL_PERSON,NSI.TELPHONE,AREA1.AREANAME || AREA2.AREANAME AS AREANAME,TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLINGDATE,NSI.REMARK,AGR.CNAME,T.TYPENAME
        FROM NKY_SAMPLING_INFO NSI
        LEFT JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
        LEFT JOIN t_s_type t ON (t.typecode = NSI.monitoring_link)
		LEFT JOIN t_s_typegroup tp ON (tp.id = t.typegroupid)  
		LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMt.PROJECT_CODE)
		LEFT JOIN SYS_AREA_CODE AREA1 ON NSI.CITY_CODE = AREA1.CODE
		LEFT JOIN SYS_AREA_CODE AREA2 ON NSI.COUNTY_CODE = AREA2.CODE
        WHERE TP.TYPEGROUPCODE = 'allmonLink'
		AND NMT.PROJECT_CODE = #{projectCode}
        AND NSI.SAMPLE_CODE = #{sampleCode}
	</select>
	
	<select id="getPadSampleMonitoringLink" resultType="jeecg.system.pojo.base.TSType" parameterType="java.lang.String">
		SELECT 
		   T1.typecode,
		   T1.typename
		FROM T_S_TYPE T1
		INNER JOIN t_s_typegroup T2 ON (T1.TYPEGROUPID = T2.ID)
		WHERE T2.TYPEGROUPCODE = #{param}	
	</select>
	
	<select id="getPadSampleMonitoringLinkName" resultType="java.lang.String" parameterType="java.util.HashMap">
		SELECT 
		   T1.typename
		FROM T_S_TYPE T1
		INNER JOIN t_s_typegroup T2 ON (T1.TYPEGROUPID = T2.ID)
		WHERE T2.TYPEGROUPCODE = 'allmonLink'
		AND	T1.typecode = #{param}	
	</select>
	
	
	<!-- 更新抽样信息表中的监测点code -->
	<update id="updateSamplingMonitorSiteCode" parameterType="java.util.HashMap">
		UPDATE 
			NKY_SAMPLING_INFO NSI
			SET NSI.UNIT_FULLCODE = #{unitFullCode}
		WHERE
			NSI.UNIT_FULLCODE is NULL
		AND NSI.UNIT_FULLNAME = #{unitFullName}		
	</update>
	
	<!--  抽样品种取得   -->
<!-- 	<select id="getMonitoringBreedForProject" resultType="com.hippo.nky.entity.monitoring.MonitoringBreedEntity" parameterType="java.util.HashMap"> -->
<!-- 	  	SELECT  -->
<!-- 	  	    AGR.CNAME AS agrName, -->
<!-- 	  	    NMB.AGR_CODE AS agrCode 		 -->
<!-- 	  	FROM NKY_MONITORING_BREED NMB -->
<!-- 	  	LEFT JOIN V_NKY_MONITORING_AGR AGR ON(NMB.AGR_CODE = AGR.CODE AND NMB.PROJECT_CODE = AGR.PROJECT_CODE) -->
<!-- 	  	WHERE NMB.PROJECT_CODE = #{projectCode}  -->
<!-- 	</select> -->
	
	
	<!--  抽样品种取得 (20140928新需求)  -->
	<select id="getMonitoringBreedForProject" resultType="java.lang.String" parameterType="java.util.HashMap">
	  	SELECT 
	  	    NMB.AGR_CODE AS agrCode 		
	  	FROM NKY_MONITORING_BREED NMB
	  	LEFT JOIN V_NKY_MONITORING_AGR AGR ON(NMB.AGR_CODE = AGR.CODE AND NMB.PROJECT_CODE = AGR.PROJECT_CODE)
	  	WHERE NMB.PROJECT_CODE = #{projectCode} 
	</select>
	
	<select id="getMonitoringBreeds" resultType="com.hippo.nky.entity.monitoring.MonitoringBreedEntity" parameterType="java.util.HashMap">
	SELECT distinct
		   agrName,
		   agrCode,
		   id,
		   pId
		FROM(
	  	SELECT
	  		distinct 
	  	    AGR.CNAME AS agrName,
	  	    AGR.CODE AS agrCode,
	  	    AGR.ID AS id,
	  	    AGR.PID AS pId,
	  	    CONNECT_BY_ISLEAF AS isLeaf  		
	  	FROM
	  	(select *
                  from V_NKY_MONITORING_AGR AGR
                 WHERE AGR.PROJECT_CODE = #{projectCode}
        ) AGR
	  	START WITH CODE = #{beedCode0}
	  	CONNECT BY PRIOR ID = PID
	  	<foreach collection="beedCodes" index="index" item="beedCode" open="" separator=" " close="">
		 UNION   
		     SELECT 
		     	distinct
		  	    AGR.CNAME AS agrName,
		  	    AGR.CODE AS agrCode,
		  	    AGR.ID AS id,
	  	        AGR.PID AS pId,
		  	    CONNECT_BY_ISLEAF AS isLeaf  		
		  	FROM
		  	(select *
                  from V_NKY_MONITORING_AGR AGR
                 WHERE AGR.PROJECT_CODE = #{projectCode}
        	) AGR
		  	START WITH CODE = #{beedCode}
		  	CONNECT BY PRIOR ID = PID   
	    </foreach>
	    ) T
	    WHERE T.isLeaf = '1'

	</select>
	
	<update id="saveProjectBreed" parameterType="com.hippo.nky.entity.monitoring.MonitoringBreedEntity">
		INSERT INTO
		NKY_PROJECT_BREED
		VALUES (
			#{id},
			#{agrCode},
			#{agrName},
			#{projectCode}
		)
	</update>
	
	<select id="getProjectBreed" resultType="com.hippo.nky.entity.monitoring.MonitoringBreedEntity" parameterType="java.lang.String">
	  	SELECT 
	  	    NPB.AGR_NAME AS agrName,
	  	    NPB.AGR_CODE AS agrCode 		
	  	FROM NKY_PROJECT_BREED NPB
	  	WHERE NPB.PROJECT_CODE = #{projectCode} 
	</select>
	
	
	<resultMap type="java.util.HashMap" id="samplingSetBackResult">
	    <result column="RN" property="rn"/>
		<result column="ID" property="id"/>    
		<result column="CODE" property="code"/>  
		<result column="STATUS" property="status"/>  
        <result column="NAME" property="projectName"/>  
        <result column="CNAME" property="agrName"/>
        <result column="SP_CODE" property="spCode"/>
        <result column="UNIT_FULLNAME" property="unitFullName"/>
        <result column="SAMPLING_DATE" property="samplingDate"/>
        <result column="OGRNAME" property="ogrName"/>
    </resultMap>  
	<!-- 抽样信息退回列表SIZE取得-->
	<select id="getSamplingSetBackCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT
			   COUNT(1)
			FROM
			   NKY_SAMPLING_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.D_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NSS.STATUS IN ('1','3')
			AND NSI.SAMPLING_ORG_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 3 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
	</select>
	<!-- 抽样信息退回列表取得 -->
	<select id="getSamplingSetBack" resultMap="samplingSetBackResult" parameterType="java.util.HashMap">
	SELECT * FROM (
			SELECT
			   ROWNUM AS RN,
			   NSS.ID,
			   NSS.CODE,
			   NSS.STATUS,
			   NMP.NAME,
			   AGR.CNAME,
			   NSI.SP_CODE,
			   NSI.UNIT_FULLNAME,
			    TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE
			FROM
			   NKY_SAMPLING_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.D_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NSS.STATUS IN ('1','3')
			   AND NSI.SAMPLING_ORG_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 3 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			
		) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	
	<!-- 抽样信息退回列表SIZE取得（审核通过已退回）-->
	<select id="getSamplingSetBackCount2" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT
			   COUNT(1)
			FROM
			   NKY_SAMPLING_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.D_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NSS.STATUS = '2'
			   AND NSI.SAMPLING_ORG_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 3 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
	</select>
	<!-- 抽样信息退回列表取得 （审核通过已退回）-->
	<select id="getSamplingSetBack2" resultMap="samplingSetBackResult" parameterType="java.util.HashMap">
		SELECT * FROM (
			SELECT
			   ROWNUM AS RN,
			   NSS.ID,
			   NSS.CODE,
			   NSS.STATUS,
			   NMP.NAME,
			   AGR.CNAME,
			   NSI.SP_CODE,
			   NSI.UNIT_FULLNAME,
			    TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE
			FROM
			   NKY_SAMPLING_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.D_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NSS.STATUS = '2'
			  AND NSI.SAMPLING_ORG_CODE = #{orgCode}
<!-- 			AND NSI.SAMPLE_STATUS > 3 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
		) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	<!-- 取得样品主要信息(退回时编辑样品信息用) -->
	<select id="getSamplingKeyInfo" resultType="java.util.HashMap" parameterType="java.lang.String">
		SELECT
		    NSI.ID,
		    NMT.PROJECT_CODE
		 FROM
		   NKY_SAMPLING_INFO NSI
		   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
		 WHERE NSI.D_CODE = #{dcode}
	</select>
	
	<!-- 抽样信息退回审核列表SIZE取得-->
	<select id="getSamplingSetBackCheckCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT
			   COUNT(1)
			FROM
			   NKY_SAMPLING_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.D_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			   INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
			WHERE
			   NSS.STATUS = '1'
			AND NMP.LEADUNIT = #{leadunit}
<!-- 			AND NSI.SAMPLE_STATUS > 3 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="ogrName != '' and ogrName != null">
			    AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
			</if>
	</select>
	<!-- 抽样信息退回审核列表取得 -->
	<select id="getSamplingSetBackCheck" resultMap="samplingSetBackResult" parameterType="java.util.HashMap">
	SELECT * FROM (
			SELECT
			   ROWNUM AS RN,
			   NSS.ID,
			   NSS.CODE,
			   NSS.STATUS,
			   NMP.NAME,
			   AGR.CNAME,
			   NSI.UNIT_FULLNAME,
			   TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
			   NOI.OGRNAME
			FROM
			   NKY_SAMPLING_SETBACK NSS
			   INNER JOIN NKY_SAMPLING_INFO NSI ON (NSS.CODE = NSI.D_CODE)
			   INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
			   INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE) 
			   LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
			   INNER JOIN NKY_ORGANIZATION_INFO NOI ON(NSI.SAMPLING_ORG_CODE = NOI.CODE)
			WHERE
			   NSS.STATUS = '1'
			   AND NMP.LEADUNIT = #{leadunit}
<!-- 			AND NSI.SAMPLE_STATUS > 3 -->
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME LIKE '%' || #{projectName} || '%'
			</if>
			<if test="sampleName != '' and sampleName != null">
			 	AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
			</if>
			<if test="unitFullname != '' and unitFullname != null">
			 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="ogrName != '' and ogrName != null">
			    AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
			</if>
			
		) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	
	
	<resultMap type="java.util.HashMap" id="samplingBlindResult">
	    <result column="RN" property="rn"/>
	    <result column="PROJECT_CODE" property="projectCode"/>  
	    <result column="NAME" property="projectName"/>
        <result column="AREANAME" property="areaName"/>  
        <result column="CNAME" property="cname"/>
        <result column="SP_CODE" property="spCode"/>
        <result column="SOGRNAME" property="sogrName"/>
        <result column="DOGRNAME" property="dogrName"/>
        <result column="SAMPLE_STATUS" property="sampleStatus"/>
        <result column="SAMPLE_CODE" property="sampleCode"/>
    </resultMap> 
	<!-- 取得盲样管理数据size -->
	<select id="getCountSamplingBlindData" resultType="java.lang.Integer" parameterType="java.util.HashMap">
	SELECT 
		count(1)
	FROM(
	  SELECT
          NMP.NAME,
          AREA1.AREANAME || AREA2.AREANAME AS AREANAME,
          AGR.CNAME,
          NSI.SP_CODE,
          NOI1.OGRNAME AS SOGRNAME,
          NOI2.OGRNAME AS DOGRNAME,
          NSI.SAMPLE_STATUS,
          NSI.SAMPLE_CODE
        FROM
           NKY_SAMPLING_INFO NSI
           INNER JOIN NKY_BLIND_SAMPLE NBS ON (NSI.SAMPLE_CODE = NBS.SAMPLE_CODE)
           INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
           INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMT.PROJECT_CODE = NMP.PROJECT_CODE)
           INNER JOIN NKY_ORGANIZATION_INFO NOI1 ON (NSI.SAMPLING_ORG_CODE = NOI1.CODE)
           LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON (NSI.DETECTION_CODE = NOI2.CODE)
           INNER JOIN SYS_AREA_CODE AREA1 ON (AREA1.CODE = NSI.CITY_CODE)
           INNER JOIN SYS_AREA_CODE AREA2 ON (AREA2.CODE = NSI.COUNTY_CODE)
           LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE) 
        WHERE
           1=1
           AND NMP.LEADUNIT = #{leadunit}
           AND NMP.DETACHED = '1'
           <if test="projectCode != null">
           	 AND NMP.PROJECT_CODE in
          	 <foreach item="item" index="index" collection="projectCode" open="(" separator="," close=")">
          	  #{item}
         	 </foreach>
	       </if>
           <if test="projectName != '' and projectName != null">
	         AND NMP.NAME LIKE '%' || #{projectName} || '%'
	       </if>
	       <if test="areaName != '' and areaName != null">
	         AND AREA1.AREANAME || AREA2.AREANAME LIKE '%' || #{areaName} || '%'
	       </if>
	       <if test="sampleName != '' and sampleName != null">
	          AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
	       </if>
	       <if test="spCode != '' and spCode != null">
	         AND NSI.SP_CODE = #{spCode}
	       </if>
	       <if test="unitFullname != '' and unitFullname != null">
	          AND NOI1.OGRNAME LIKE '%' || #{unitFullname} || '%'
	       </if>
	       <if test="remark != '' and remark != null">
	         AND NOI2.OGRNAME LIKE '%' || #{remark} || '%'
	       </if>
	 )
	</select>
	
	<!-- 取得盲样管理数据 -->
	<select id="getSamplingBlindData" resultMap="samplingBlindResult" parameterType="java.util.HashMap">
	SELECT * FROM (
	SELECT 
	     ROWNUM AS RN,
	     PROJECT_CODE,
	     NAME,
	     AREANAME,
	     CNAME,
	     SP_CODE,
	     SOGRNAME,
	     DOGRNAME,
	     SAMPLE_STATUS,
	     SAMPLE_CODE
	FROM(
	  SELECT
	      NMP.PROJECT_CODE,
          NMP.NAME,
          AREA1.AREANAME || AREA2.AREANAME AS AREANAME,
          AGR.CNAME,
          NSI.SP_CODE,
          NOI1.OGRNAME AS SOGRNAME,
          NOI2.OGRNAME AS DOGRNAME,
          NSI.SAMPLE_STATUS,
          NSI.SAMPLE_CODE
        FROM
           NKY_SAMPLING_INFO NSI
           INNER JOIN NKY_BLIND_SAMPLE NBS ON (NSI.SAMPLE_CODE = NBS.SAMPLE_CODE)
           INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
           INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMT.PROJECT_CODE = NMP.PROJECT_CODE)
           INNER JOIN NKY_ORGANIZATION_INFO NOI1 ON (NSI.SAMPLING_ORG_CODE = NOI1.CODE)
           LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON (NSI.DETECTION_CODE = NOI2.CODE)
           INNER JOIN SYS_AREA_CODE AREA1 ON (AREA1.CODE = NSI.CITY_CODE)
           INNER JOIN SYS_AREA_CODE AREA2 ON (AREA2.CODE = NSI.COUNTY_CODE)
           LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE) 
        WHERE
           1=1
           AND NMP.LEADUNIT = #{leadunit}
           AND NMP.DETACHED = '1'
           <if test="projectCode != null">
           	 AND NMP.PROJECT_CODE in
          	 <foreach item="item" index="index" collection="projectCode" open="(" separator="," close=")">
          	  #{item}
         	 </foreach>
	       </if>
           <if test="projectName != '' and projectName != null">
	         AND NMP.NAME LIKE '%' || #{projectName} || '%'
	       </if>
	       <if test="areaName != '' and areaName != null">
	         AND AREA1.AREANAME || AREA2.AREANAME LIKE '%' || #{areaName} || '%'
	       </if>
	       <if test="sampleName != '' and sampleName != null">
	          AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
	       </if>
	       <if test="spCode != '' and spCode != null">
	         AND NSI.SP_CODE = #{spCode}
	       </if>
	       <if test="unitFullname != '' and unitFullname != null">
	          AND NOI1.OGRNAME LIKE '%' || #{unitFullname} || '%'
	       </if>
	       <if test="remark != '' and remark != null">
	         AND NOI2.OGRNAME LIKE '%' || #{remark} || '%'
	       </if>
	 )
	 ) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	
	
	<resultMap type="java.util.HashMap" id="addSamplingBlindResult">
	    <result column="RN" property="rn"/>
	    <result column="TASK_CODE" property="taskCode"/>  
        <result column="TASKNAME" property="taskName"/>  
        <result column="OGRNAME" property="ogrName"/>
    </resultMap> 
		<!-- 取得添加盲样任务数据SIZE -->
	<select id="getCountForAddSamplingBlind" resultType="java.lang.Integer" parameterType="java.util.HashMap">
	SELECT 
	    COUNT(1)
	FROM(
	  SELECT
	         NMT.TASKNAME,
	         NOI.OGRNAME
	      FROM
	         NKY_SAMPLING_INFO NSI
	         INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	         INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMT.PROJECT_CODE = NMP.PROJECT_CODE)
	         INNER JOIN NKY_ORGANIZATION_INFO NOI ON (NMT.ORG_CODE = NOI.CODE)
	      WHERE
	         1=1
	         AND NMP.LEADUNIT = #{leadunit}
	         AND NMP.DETACHED = '1'
	         AND NSI.SAMPLE_STATUS = '3'
	         <if test="taskName != '' and taskName != null">
			 	AND NMT.TASKNAME LIKE '%' || #{taskName} || '%'
			 </if>
			 <if test="ogrName != '' and ogrName != null">
			    AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
			 </if>
	         GROUP BY NMP.PUBLISH_DATE,NMT.TASKNAME,NOI.OGRNAME
	         ORDER BY NMP.PUBLISH_DATE
	 )
	</select>
	
	<!-- 取得添加盲样任务数据 -->
	<select id="getAddSamplingBlindData" resultMap="addSamplingBlindResult" parameterType="java.util.HashMap">
	SELECT * FROM (
	SELECT 
	     ROWNUM AS RN,
	     TASK_CODE,
	     TASKNAME,
	     OGRNAME
	FROM(
	  SELECT
	  		 NMT.TASK_CODE,
	         NMT.TASKNAME,
	         NOI.OGRNAME
	      FROM
	         NKY_SAMPLING_INFO NSI
	         INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	         INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMT.PROJECT_CODE = NMP.PROJECT_CODE)
	         INNER JOIN NKY_ORGANIZATION_INFO NOI ON (NMT.ORG_CODE = NOI.CODE)
	      WHERE
	         1=1
	         AND NMP.LEADUNIT = #{leadunit}
	         AND NMP.DETACHED = '1'
	         AND NSI.SAMPLE_STATUS = '3'
	         <if test="taskName != '' and taskName != null">
			 	AND NMT.TASKNAME LIKE '%' || #{taskName} || '%'
			 </if>
			 <if test="ogrName != '' and ogrName != null">
			    AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
			 </if>
	         GROUP BY NMP.PUBLISH_DATE,NMT.TASK_CODE,NMT.TASKNAME,NOI.OGRNAME
	         ORDER BY NMP.PUBLISH_DATE
	 )
	 ) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
	
	
	<resultMap type="java.util.HashMap" id="selectSamplingBlindResult">
	    <result column="RN" property="rn"/>
	    <result column="CNAME" property="cname"/>  
        <result column="SAMPLE_CODE" property="sampleCode"/>  
        <result column="SP_CODE" property="spCode"/>
        <result column="OGRNAME" property="ogrName"/>
        <result column="MONITORING_LINK" property="monitoringLink"/>
    </resultMap> 
	<!-- 增加盲样选择样品 数据SIZE -->
	<select id="getCountSelectSamplingBlind" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT 
		 count(1)
		FROM(
		  SELECT
	      AGR.CNAME,
	      NSI.SAMPLE_CODE,
	      NSI.SP_CODE,
	      NOI.OGRNAME,
	      NSI.MONITORING_LINK
	    FROM
	       NKY_SAMPLING_INFO NSI
	       INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	       INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMT.PROJECT_CODE = NMP.PROJECT_CODE)
	       INNER JOIN NKY_ORGANIZATION_INFO NOI ON (NSI.SAMPLING_ORG_CODE = NOI.CODE)
	       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE) 
	    WHERE
	       1=1
	       AND NMP.LEADUNIT = #{leadunit}
	       AND NMP.DETACHED = '1'
	       AND NSI.TASK_CODE = #{taskCode}
	       AND NSI.Sample_Code NOT IN (
	           select NBS.SAMPLE_CODE from Nky_Blind_Sample NBS
	       )
	       <if test="sampleName != '' and sampleName != null">
	        AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
	       </if>
	       <if test="spCode != '' and spCode != null">
	          AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
	       </if>
	   )
	</select>
	
	<!-- 增加盲样选择样品 数据取得 -->
	<select id="getSelectSamplingBlind" resultMap="selectSamplingBlindResult" parameterType="java.util.HashMap">
	SELECT * FROM (
		SELECT 
		     ROWNUM AS RN,
		     CNAME,
		     SAMPLE_CODE,
		     SP_CODE,
		     OGRNAME,
		     MONITORING_LINK
		FROM(
		  SELECT
	      AGR.CNAME,
	      NSI.SAMPLE_CODE,
	      NSI.SP_CODE,
	      NOI.OGRNAME,
	      NSI.MONITORING_LINK
	    FROM
	       NKY_SAMPLING_INFO NSI
	       INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
	       INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMT.PROJECT_CODE = NMP.PROJECT_CODE)
	       INNER JOIN NKY_ORGANIZATION_INFO NOI ON (NSI.SAMPLING_ORG_CODE = NOI.CODE)
	       LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE) 
	    WHERE
	       1=1
	       AND NMP.LEADUNIT = #{leadunit}
	       AND NMP.DETACHED = '1'
	       AND NSI.TASK_CODE = #{taskCode}
	       AND NSI.Sample_Code NOT IN (
	           select NBS.SAMPLE_CODE from Nky_Blind_Sample NBS
	       )
		  <if test="sampleName != '' and sampleName != null">
	        AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
	       </if>
	       <if test="spCode != '' and spCode != null">
	          AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
	       </if>
	   )
	 ) T
	 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}	
	</select>
		<!-- 取得盲样管理数据导出用 -->
	<select id="getSamplingBlindDataForExport" resultType="java.util.LinkedHashMap" parameterType="java.util.HashMap">
	SELECT 
	     ROWNUM AS RN,
	     NAME,
	     AREANAME,
	     CNAME,
	     SP_CODE,
	     SOGRNAME,
	     DOGRNAME,
	     BLIND_SAMPLE_VALUE
	FROM(
	  SELECT
          NMP.NAME,
          AREA1.AREANAME || AREA2.AREANAME AS AREANAME,
          AGR.CNAME,
          NSI.SP_CODE,
          NOI1.OGRNAME AS SOGRNAME,
          NOI2.OGRNAME AS DOGRNAME,
          NBS.BLIND_SAMPLE_VALUE
        FROM
           NKY_SAMPLING_INFO NSI
           INNER JOIN NKY_BLIND_SAMPLE NBS ON (NSI.SAMPLE_CODE = NBS.SAMPLE_CODE)
           INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
           INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMT.PROJECT_CODE = NMP.PROJECT_CODE)
           INNER JOIN NKY_ORGANIZATION_INFO NOI1 ON (NSI.SAMPLING_ORG_CODE = NOI1.CODE)
           LEFT JOIN NKY_ORGANIZATION_INFO NOI2 ON (NSI.DETECTION_CODE = NOI2.CODE)
           INNER JOIN SYS_AREA_CODE AREA1 ON (AREA1.CODE = NSI.CITY_CODE)
           INNER JOIN SYS_AREA_CODE AREA2 ON (AREA2.CODE = NSI.COUNTY_CODE)
           LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE) 
        WHERE
           1=1
           AND NMP.LEADUNIT = #{leadunit}
           AND NMP.DETACHED = '1'
           <if test="projectCode != null">
           	 AND NMP.PROJECT_CODE in
          	 <foreach item="item" index="index" collection="projectCode" open="(" separator="," close=")">
          	  #{item}
         	 </foreach>
	       </if>
           <if test="projectName != '' and projectName != null">
	         AND NMP.NAME LIKE '%' || #{projectName} || '%'
	       </if>
	       <if test="areaName != '' and areaName != null">
	         AND AREA1.AREANAME || AREA2.AREANAME LIKE '%' || #{areaName} || '%'
	       </if>
	       <if test="sampleName != '' and sampleName != null">
	          AND AGR.CNAME LIKE '%' || #{sampleName} || '%'
	       </if>
	       <if test="spCode != '' and spCode != null">
	         AND NSI.SP_CODE = #{spCode}
	       </if>
	       <if test="unitFullname != '' and unitFullname != null">
	          AND NOI1.OGRNAME LIKE '%' || #{unitFullname} || '%'
	       </if>
	       <if test="remark != '' and remark != null">
	         AND NOI2.OGRNAME LIKE '%' || #{remark} || '%'
	       </if>
	 )
	 
	</select>
	
	<resultMap type="java.util.HashMap" id="organizationResult">
		<result column="ID" property="id"/>
		<result column="CODE" property="code"/>  
		<result column="OGRNAME" property="ogrname"/>  
		<result column="CONTACTS" property="contacts"/>  
		<result column="RN" property="rn"/>  
		<result column="LEADER" property="leader"/>  
		<result column="CONTACTSTEL" property="contactstel"/>  
    </resultMap>  
    
	<select id="getOrganizationCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			SELECT NOI.ID
				FROM NKY_ORGANIZATION_INFO NOI
            WHERE 1=1
            <if test="samplingOrgCode != '' and samplingOrgCode != null ">
            	AND NOI.CODE = #{samplingOrgCode}
            </if>
			<if test="code != '' and code != null ">
				AND NOI.CODE LIKE '%' || #{code} || '%'
			</if>
			<if test="ogrname != '' and ogrname != null ">
				AND NOI.OGRNAME LIKE '%' || #{ogrname} || '%'
			</if>
			<if test="leader != '' and leader != null ">
				AND NOI.LEADER LIKE '%' || #{leader} || '%'
			</if>
			<if test="contactstel != '' and contactstel != null ">
				AND NOI.CONTACTSTEL LIKE '%' || #{contactstel} || '%'
			</if>
         ) t	
	</select>
	
	<select id="getOrganizationInfo" resultMap="organizationResult" parameterType="java.util.HashMap">
		select t.*
  			from (
  			SELECT NOI.ID AS id,
  				   NOI.CODE AS code,
  				   NOI.OGRNAME AS ogrname,
  				   NOI.LEADER AS leader,
  				   NOI.CONTACTS AS contacts,
  				   NOI.CONTACTSTEL AS contactstel,
  				   ROWNUM AS RN
				FROM NKY_ORGANIZATION_INFO NOI
            WHERE 1=1
            <if test="samplingOrgCode != '' and samplingOrgCode != null ">
            	AND NOI.CODE = #{samplingOrgCode}
            </if>
			<if test="code != '' and code != null ">
				AND NOI.CODE LIKE '%' || #{code} || '%'
			</if>
			<if test="ogrname != '' and ogrname != null ">
				AND NOI.OGRNAME LIKE '%' || #{ogrname} || '%'
			</if>
			<if test="leader != '' and leader != null ">
				AND NOI.LEADER LIKE '%' || #{leader} || '%'
			</if>
			<if test="contactstel != '' and contactstel != null ">
				AND NOI.CONTACTSTEL LIKE '%' || #{contactstel} || '%'
			</if>
         ) t	
          WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	
	<select id="checkUniqueSpcode" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(1)
		from nky_sampling_info nsi
		INNER JOIN NKY_MONITORING_TASK NMT on (NMT.TASK_CODE = NSI.TASK_CODE)
		where nsi.SP_CODE = #{spCode}
		and nsi.COUNTY_CODE = #{countyCode}
		and nmt.PROJECT_CODE = #{projectCode}
	</select>
	
	
	<!-- 抽样信息汇总（20141120） 牵头单位可以查看项目全部数据-->
	<select id="getSampleCollectCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
				LEFT JOIN SYS_AREA_CODE AREA1 ON NSI.CITY_CODE = AREA1.CODE
				LEFT JOIN SYS_AREA_CODE AREA2 ON NSI.COUNTY_CODE = AREA2.CODE
            WHERE 1=1
<!--             </if> -->
			<if test="pt != '' and pt != null ">
				AND NSI.SAMPLING_ORG_CODE = #{pt}
			</if>
			<if test="projectCode != '' and projectCode != null ">
				AND NMP.PROJECT_CODE = #{projectCode}
			</if>
	        <if test="agrName != '' and agrName != null">
				AND AGR.CNAME LIKE '%' || #{agrName} || '%'
			</if>
			<if test=" unitFullname != '' and unitFullname != null ">
				AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
			</if>
			<if test="sampleStatus != '' and sampleStatus != null">
				AND NSI.SAMPLE_STATUS IN 
			    <foreach collection="sampleStatus" index="index" item="item" open="(" separator="," close=")">
			     	#{item}
			    </foreach>  
			</if>
			<if test="monitoringLink != '' and monitoringLink != null">
			 	AND NSI.MONITORING_LINK = #{monitoringLink}
			</if>
			<if test="projectName != '' and projectName != null">
			 	AND NMP.NAME = #{projectName}
			</if>
			<!-- 用户部门所在的行政区划 -->
	       	<if test="cityCode != '' and cityCode != null ">
				AND NSI.CITY_CODE = #{cityCode}
			</if>
			<!-- 搜索条件 -Start-->
			<!-- 地区 -->
			<if test=" countyCode != '' and countyCode != null ">
				AND NSI.COUNTY_CODE = #{countyCode}
			</if>
			<if test="dCode != '' and dCode != null">
			 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
			</if>
			<if test="complete != '' and complete != null ">
 				AND NSI.COMPLETE = #{complete}
			</if>
			<if test="samplingDate != '' and samplingDate != null ">
 				AND NSI.SAMPLING_DATE = #{samplingDate}
			</if>
         ) t	
	</select>
	
	<select id="getSampleCollect" resultMap="sampleResult" parameterType="java.util.HashMap">
		SELECT T.* 
		  FROM (SELECT NSI.ID,
				       NSI.UNIT_FULLNAME,
				       NSI.SAMPLE_CODE,
				       TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
				       NSI.MONITORING_LINK,
				       NSI.TASK_CODE,
				       NSI.COUNTY_CODE,
				       NSI.D_CODE,
				       NSI.SP_CODE,
				       AGR.CNAME,
				       NMP.NAME,
				       NMP.PROJECT_CODE,
				       ROWNUM AS RN,
				       AREA1.AREANAME || AREA2.AREANAME AS CITY_AND_COUNTRY,
				       TO_CHAR(NSI.REPORTING_DATE,'YYYY-MM-DD') AS REPORTING_DATE
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
				LEFT JOIN SYS_AREA_CODE AREA1 ON NSI.CITY_CODE = AREA1.CODE
				LEFT JOIN SYS_AREA_CODE AREA2 ON NSI.COUNTY_CODE = AREA2.CODE
      			WHERE 1=1
      			<if test="pt != '' and pt != null ">
					AND NSI.SAMPLING_ORG_CODE = #{pt}
				</if>
      			<if test="projectCode != '' and projectCode != null ">
	 				AND NMP.PROJECT_CODE = #{projectCode}
				</if>
		        <if test="agrName != '' and agrName != null">
					AND AGR.CNAME LIKE '%' || #{agrName} || '%'
				</if>
				<if test=" unitFullname != '' and unitFullname != null ">
				 	AND NSI.UNIT_FULLNAME LIKE '%' || #{unitFullname} || '%'
				</if>
				<if test="sampleStatus != '' and sampleStatus != null">
					AND NSI.SAMPLE_STATUS IN 
				    <foreach collection="sampleStatus" index="index" item="item" open="(" separator="," close=")">
				     	#{item}
				    </foreach>  
				</if>
				<if test="monitoringLink != '' and monitoringLink != null">
				 	AND NSI.MONITORING_LINK = #{monitoringLink}
				</if>
				<if test="projectName != '' and projectName != null">
				 	AND NMP.NAME = #{projectName}
				</if>
				 <!-- 用户部门所在的行政区划 -->
		       	<if test="cityCode != '' and cityCode != null ">
					AND NSI.CITY_CODE = #{cityCode}
				</if>
				<!-- 搜索条件 -Start-->
				<!-- 地区 -->
				<if test=" countyCode != '' and countyCode != null ">
					AND NSI.COUNTY_CODE = #{countyCode}
				</if>
				<if test="dCode != '' and dCode != null">
				 	AND NSI.D_CODE LIKE '%' || #{dCode} || '%'
				</if>
				<if test="complete != '' and complete != null ">
 					AND NSI.COMPLETE = #{complete}
				</if>
				<if test="samplingDate != '' and samplingDate != null ">
 					AND NSI.SAMPLING_DATE = #{samplingDate}
				</if>
      	) T
		 WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex}
	</select>
	
	<resultMap type="java.util.HashMap" id="samplingBatchSetBackResult">
	  	<result column="PROJECT_CODE" property="projectCode"/>
        <result column="NAME" property="projectName"/>
        <result column="OGRNAME" property="ogrName"/>
        <result column="PUBLISH_DATE" property="publishDate"/>
        <result column="ACOUNT" property="aCount"/>
        <result column="RCOUNT1" property="rCount1"/>
        <result column="RCOUNT2" property="rCount2"/>
        <result column="CODE" property="ogrCode"/>
    </resultMap>  
	<!-- 抽样信息批量退回列表SIZE取得-->
	<select id="getSamplingBatchSetBackCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT COUNT(1)
		FROM(
		 SELECT
			   NMP.NAME
			FROM
			   NKY_MONITORING_PROJECT NMP
			   LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NMP.LEADUNIT = NOI.CODE)
			   LEFT JOIN (SELECT TASK.PROJECT_CODE,
			             SUM(TASK.SAMPLING_COUNT) AS COUNT
			          FROM NKY_MONITORING_TASK TASK
			          GROUP BY TASK.PROJECT_CODE) CY_ALL 
	              ON (CY_ALL.PROJECT_CODE = NMP.PROJECT_CODE)
	           LEFT JOIN (SELECT TASK.PROJECT_CODE,
	            		   COUNT(NSI.ID) AS COUNT
		   				   FROM NKY_SAMPLING_INFO NSI
		                   LEFT JOIN NKY_MONITORING_TASK TASK ON NSI.TASK_CODE = TASK.TASK_CODE
		                   WHERE NSI.SAMPLE_STATUS IN ('3')
		                   GROUP BY TASK.PROJECT_CODE) CY_REPORT1 
		          ON (CY_REPORT1.PROJECT_CODE = NMP.PROJECT_CODE)
		       LEFT JOIN (SELECT TASK.PROJECT_CODE,
	            		   COUNT(NSI.ID) AS COUNT
		   				   FROM NKY_SAMPLING_INFO NSI
		                   LEFT JOIN NKY_MONITORING_TASK TASK ON NSI.TASK_CODE = TASK.TASK_CODE
		                   WHERE NSI.SAMPLE_STATUS IN ('4','5')
		                   GROUP BY TASK.PROJECT_CODE) CY_REPORT2 
		          ON (CY_REPORT2.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NMP.LEADUNIT = #{orgCode}
			   AND NMP.STATE = 1
			   <if test="projectName != '' and projectName != null">
				  AND NMP.NAME LIKE '%' || #{projectName} || '%'
			   </if>
			GROUP BY NMP.NAME
		)
	</select>
	<!-- 抽样信息批量退回列表取得 -->
	<select id="getSamplingBatchSetBack" resultMap="samplingBatchSetBackResult" parameterType="java.util.HashMap">
	SELECT *
	FROM(
		SELECT
			ROWNUM AS RN,
			PROJECT_CODE,
			NAME,
			OGRNAME,
<!-- 			PUBLISH_DATE, -->
			ACOUNT,
			RCOUNT1,
			RCOUNT2
		  FROM (
			SELECT
			   NMP.PROJECT_CODE,
			   NMP.NAME,
			   NOI.OGRNAME,
<!-- 			   TO_CHAR(NMP.PUBLISH_DATE,'YYYY-MM-DD') AS PUBLISH_DATE, -->
			   nvl(CY_ALL.COUNT,0) AS ACOUNT,
			   nvl(CY_REPORT1.COUNT,0) AS RCOUNT1,
			   nvl(CY_REPORT2.COUNT,0) AS RCOUNT2  
			FROM
			   NKY_MONITORING_PROJECT NMP
			   LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NMP.LEADUNIT = NOI.CODE)
			   LEFT JOIN (SELECT TASK.PROJECT_CODE,
			             SUM(TASK.SAMPLING_COUNT) AS COUNT
			          FROM NKY_MONITORING_TASK TASK
			          GROUP BY TASK.PROJECT_CODE) CY_ALL 
	              ON (CY_ALL.PROJECT_CODE = NMP.PROJECT_CODE)
	           LEFT JOIN (SELECT TASK.PROJECT_CODE,
	            		   COUNT(NSI.ID) AS COUNT
		   				   FROM NKY_SAMPLING_INFO NSI
		                   LEFT JOIN NKY_MONITORING_TASK TASK ON NSI.TASK_CODE = TASK.TASK_CODE
		                   WHERE NSI.SAMPLE_STATUS IN ('3')
		                   GROUP BY TASK.PROJECT_CODE) CY_REPORT1 
		          ON (CY_REPORT1.PROJECT_CODE = NMP.PROJECT_CODE)
		       LEFT JOIN (SELECT TASK.PROJECT_CODE,
	            		   COUNT(NSI.ID) AS COUNT
		   				   FROM NKY_SAMPLING_INFO NSI
		                   LEFT JOIN NKY_MONITORING_TASK TASK ON NSI.TASK_CODE = TASK.TASK_CODE
		                   WHERE NSI.SAMPLE_STATUS IN ('4','5')
		                   GROUP BY TASK.PROJECT_CODE) CY_REPORT2 
		          ON (CY_REPORT2.PROJECT_CODE = NMP.PROJECT_CODE)
			WHERE
			   NMP.LEADUNIT = #{orgCode}
			   AND NMP.STATE = 1
			    <if test="projectName != '' and projectName != null">
				  AND NMP.NAME LIKE '%' || #{projectName} || '%'
			   </if>
			GROUP BY NMP.PROJECT_CODE,NMP.NAME,NOI.OGRNAME,NMP.PUBLISH_DATE,CY_ALL.COUNT,CY_REPORT1.COUNT,CY_REPORT2.COUNT  
			ORDER BY NMP.PUBLISH_DATE DESC
		  ) T
	  ) WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex} 
	</select>
	
	<!-- 抽样信息批量退回列表SIZE取得-->
	<select id="getSamplingBatchSetBackDetailCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">

		 SELECT COUNT(1)
			FROM(
				SELECT
					NOI.CODE,
					NOI.OGRNAME,
					count(NSI.id) AS COUNT 
				FROM
					NKY_SAMPLING_INFO NSI
					INNER JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
					LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NSI.SAMPLING_ORG_CODE = NOI.CODE)
					
				WHERE
					NSI.SAMPLE_STATUS = 3
					AND NMT.PROJECT_CODE = #{projectCode}
					<if test="ogrName != '' and ogrName != null">
					  AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
				   </if>
				GROUP BY NOI.CODE,NOI.OGRNAME
		)
	</select>
	<!-- 抽样信息批量退回列表取得 -->
	<select id="getSamplingBatchSetBackDetail" resultMap="samplingBatchSetBackResult" parameterType="java.util.HashMap">
	SELECT 
	 * FROM
	(
	SELECT ROWNUM AS RN,
		CODE,
		OGRNAME,
		RCOUNT1
	FROM(
		SELECT
			NOI.CODE,
			NOI.OGRNAME,
			count(NSI.id) AS RCOUNT1 
		FROM
			NKY_SAMPLING_INFO NSI
			INNER JOIN NKY_MONITORING_TASK NMT ON (NSI.TASK_CODE = NMT.TASK_CODE)
			LEFT JOIN NKY_ORGANIZATION_INFO NOI ON (NSI.SAMPLING_ORG_CODE = NOI.CODE)
			
		WHERE
			NSI.SAMPLE_STATUS = 3
			AND NMT.PROJECT_CODE = #{projectCode}
			<if test="ogrName != '' and ogrName != null">
				AND NOI.OGRNAME LIKE '%' || #{ogrName} || '%'
			</if>
		GROUP BY NOI.CODE,NOI.OGRNAME
	) T
	) WHERE RN > #{beginIndex} AND RN <![CDATA[ <= ]]>  #{endIndex} 
	
	</select>
	
	
	<select id="getBatchSetBackSampleListCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		select count(*)
  			from (
  			SELECT NSI.ID
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE) 
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
            WHERE 1=1
            AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
            AND NSI.SAMPLE_STATUS = 3
            AND NMP.PROJECT_CODE = #{projectCode}
            AND NSI.D_CODE NOT IN (
            		SELECT CODE 
            		FROM NKY_SAMPLING_SETBACK NSS
            		WHERE NSS.STATUS = 2
            	)
	        <if test="agrName != '' and agrName != null">
				AND AGR.CNAME LIKE '%' || #{agrName} || '%'
			</if>
			<if test="dCode != '' and dCode != null">
				AND NSI.D_CODE = #{dCode}
			</if>
			<if test="spCode != '' and spCode != null">
				AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
			</if>
         ) t	
	</select>
	
	<select id="getBatchSetBackSampleList" resultMap="sampleResult" parameterType="java.util.HashMap">
	 	select ROWNUM AS RN,t.* from (
				SELECT NSI.ID,
				       NSI.UNIT_FULLNAME,
				       NSI.SAMPLE_CODE,
				       TO_CHAR(NSI.SAMPLING_DATE,'YYYY-MM-DD') AS SAMPLING_DATE,
				       NSI.MONITORING_LINK,
				       NSI.TASK_CODE,
				       NSI.COUNTY_CODE,
				       NSI.D_CODE,
				       NSI.SP_CODE,
				       AGR.CNAME,
				       NMP.NAME,
				       NMP.PROJECT_CODE,
				       ROWNUM AS RN,
				       TO_CHAR(NSI.REPORTING_DATE,'YYYY-MM-DD') AS REPORTING_DATE
				FROM NKY_SAMPLING_INFO NSI
				INNER JOIN NKY_MONITORING_TASK NMT ON(NSI.TASK_CODE = NMT.TASK_CODE)
				INNER JOIN NKY_MONITORING_PROJECT NMP ON(NMP.PROJECT_CODE = NMT.PROJECT_CODE)
				INNER JOIN NkY_MONITORING_PLAN NMPL ON(NMPL.PLAN_CODE = NMP.PLAN_CODE)
				LEFT JOIN V_NKY_MONITORING_AGR AGR ON (AGR.CODE = NSI.AGR_CODE AND AGR.PROJECT_CODE = NMP.PROJECT_CODE)
      			WHERE 1=1
      			AND NSI.SAMPLING_ORG_CODE = #{samplingOrgCode}
      		    AND NSI.SAMPLE_STATUS = 3
            	AND NMP.PROJECT_CODE = #{projectCode}
            	AND NSI.D_CODE NOT IN (
            		SELECT CODE 
            		FROM NKY_SAMPLING_SETBACK NSS
            		WHERE NSS.STATUS = 2
            	)
	        <if test="agrName != '' and agrName != null">
				AND AGR.CNAME LIKE '%' || #{agrName} || '%'
			</if>
			<if test="dCode != '' and dCode != null">
				AND NSI.D_CODE = #{dCode}
			</if>
			<if test="spCode != '' and spCode != null">
				AND NSI.SP_CODE LIKE '%' || #{spCode} || '%'
			</if>
				ORDER BY SUBSTR(NSI.D_CODE, 8, 6) ASC
			) t
	</select>
	
	
	<select id="getMatchResult" resultType="com.hippo.nky.entity.monitoring.NkyMonitoringSiteEntity" parameterType="java.lang.String">
		SELECT *
			FROM
			NKY_MONITORING_SITE T
		WHERE 
			T.NAME LIKE '%' || #{keyWords} || '%'
		AND ROWNUM <![CDATA[ < ]]> 10
	</select>
	
	<select id="getGenerateMonitoringSiteCode" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT
			substr(MAX(CODE),1,2) || trim(to_char(to_number(substr(max(code),3)) + 1, '00000')) 
		 FROM
		NKY_MONITORING_SITE T
	</select>
</mapper>